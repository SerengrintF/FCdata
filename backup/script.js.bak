// API ì„¤ì •
const API_KEY = 'live_72e6c00482ffc1def6dde5f00b426e8d07b3d0335525104d8d9b7fe6b1a579a2efe8d04e6d233bd35cf2fabdeb93fb0d';
const BASE_URL = 'https://open.api.nexon.com/fconline/v1';

// ë„¥ìŠ¨ APIì˜ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ë“¤ (ë¬¸ì„œ ê¸°ë°˜)
const NEXON_ENDPOINTS = {
    userBasic: 'https://open.api.nexon.com/fconline/v1/user/basic',
    userInfo: 'https://open.api.nexon.com/fconline/v1/user/info',
    userMatch: 'https://open.api.nexon.com/fconline/v1/user/match',
    // ëŒ€ì•ˆ ì—”ë“œí¬ì¸íŠ¸ë“¤
    userBasicAlt: 'https://open.api.nexon.com/fconline/v1/user',
    userInfoAlt: 'https://open.api.nexon.com/fconline/v1/user/detail'
};

// DOM ìš”ì†Œë“¤
const nicknameInput = document.getElementById('nicknameInput');
const searchBtn = document.getElementById('searchBtn');
const loading = document.getElementById('loading');
const errorSection = document.getElementById('errorSection');
const errorMessage = document.getElementById('errorMessage');

// ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ê´€ë ¨ ìš”ì†Œë“¤
const searchDropdown = document.getElementById('searchDropdown');
const favoritesList = document.getElementById('favoritesList');
const historyList = document.getElementById('historyList');
const clearFavoritesBtn = document.getElementById('clearFavoritesBtn');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');

// ì„ ìˆ˜ ì •ë³´ ê´€ë ¨ ìš”ì†Œë“¤
const playerBasicInfo = document.getElementById('playerBasicInfo');
const playerName = document.getElementById('playerName');
const currentGradeText = document.getElementById('currentGradeText');
const highestGradeText = document.getElementById('highestGradeText');
const playerLevel = document.getElementById('playerLevel');

// ê²½ê¸° íŠ¹ì§• ê´€ë ¨ ìš”ì†Œë“¤
const playStyle = document.getElementById('playStyle');
const mainStrength = document.getElementById('mainStrength');
const gameTendency = document.getElementById('gameTendency');

// íƒ­ ê´€ë ¨ ìš”ì†Œë“¤
const tabContainer = document.getElementById('tabContainer');
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');

// ëŒ€ì‹œë³´ë“œ ê´€ë ¨ ìš”ì†Œë“¤
const winRate = document.getElementById('winRate');
const avgGoals = document.getElementById('avgGoals');
const avgConceded = document.getElementById('avgConceded');
const matchesList = document.getElementById('matchesList');
const loadMoreBtn = document.getElementById('loadMoreBtn');
const matchCount = document.getElementById('matchCount');


// ì»¨íŠ¸ë¡¤ëŸ¬ íƒ€ì… ë§¤í•‘
const CONTROLLER_INFO = {
    'keyboard': { name: 'í‚¤ë³´ë“œ', emoji: 'âŒ¨ï¸' },
    'gamepad': { name: 'ê²Œì„íŒ¨ë“œ', emoji: 'ğŸ®' },
    'pad': { name: 'ê²Œì„íŒ¨ë“œ', emoji: 'ğŸ®' }
};

// ì»¨íŠ¸ë¡¤ëŸ¬ ì´ëª¨ì§€ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getControllerEmoji(controllerType) {
    if (controllerType === null || controllerType === undefined || controllerType === '') {
        return '';
    }
    
    // ë¬¸ìì—´ì„ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ë§¤ì¹­
    const normalizedType = controllerType.toLowerCase();
    const controllerInfo = CONTROLLER_INFO[normalizedType];
    
    console.log('ì»¨íŠ¸ë¡¤ëŸ¬ íƒ€ì… ë³€í™˜:', {
        ì›ë³¸: controllerType,
        ì •ê·œí™”: normalizedType,
        ë§¤ì¹­ê²°ê³¼: controllerInfo
    });
    
    return controllerInfo ? controllerInfo.emoji : '';
}

// ì „ì—­ ë³€ìˆ˜
let currentUserInfo = null;
let currentMatchOffset = 10;

// ê²€ìƒ‰ ê¸°ë¡ê³¼ ì¦ê²¨ì°¾ê¸° ê´€ë¦¬
let searchHistory = JSON.parse(localStorage.getItem('fcData_searchHistory') || '[]');
let favorites = JSON.parse(localStorage.getItem('fcData_favorites') || '[]');
let selectedIndex = -1;

// ê²½ê¸° ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateMatchCount() {
    const matchItems = document.querySelectorAll('.match-item');
    const count = matchItems.length;
    matchCount.textContent = `(${count})`;
    
    // ê³¨ ë„£ëŠ” ìœ í˜•ê³¼ ì£¼ìš” ì„ ìˆ˜ ì¹´ë“œì˜ ê²½ê¸° ìˆ˜ë„ ì—…ë°ì´íŠ¸
    const goalAnalysisMatchCount = document.getElementById('goalAnalysisMatchCount');
    const topPlayersMatchCount = document.getElementById('topPlayersMatchCount');
    
    if (goalAnalysisMatchCount) {
        goalAnalysisMatchCount.textContent = `(${count})`;
    }
    if (topPlayersMatchCount) {
        topPlayersMatchCount.textContent = `(${count})`;
    }
}

// ê²½ê¸° í†µê³„ ì—…ë°ì´íŠ¸ (ë”ë³´ê¸°ë¡œ ê²½ê¸° ì¶”ê°€ ì‹œ í˜¸ì¶œ)
function updateMatchStatistics() {
    if (!currentUserInfo || !currentUserInfo.matches || currentUserInfo.matches.length === 0) {
        console.log('ì—…ë°ì´íŠ¸í•  ê²½ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    console.log('í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘, ì „ì²´ ê²½ê¸° ìˆ˜:', currentUserInfo.matches.length);
    
    // ì „ì²´ ê²½ê¸° ë°ì´í„°ë¡œ í†µê³„ ì¬ê³„ì‚°
    const matchStats = calculateMatchStats(currentUserInfo.matches);
    
    // ìŠ¹ë¥ , í‰ê·  ë“ì , í‰ê·  ì‹¤ì  ì—…ë°ì´íŠ¸
    if (winRate) {
        winRate.textContent = `${matchStats.winRate}%`;
    }
    if (avgGoals) {
        avgGoals.textContent = matchStats.avgGoals.toFixed(1);
    }
    if (avgConceded) {
        avgConceded.textContent = matchStats.avgConceded.toFixed(1);
    }
    
    // ê²½ê¸°ë ¥ íŠ¸ë Œë“œ ì—…ë°ì´íŠ¸
    displayTrend(matchStats.trend);
    
    // ê³¨ ìœ í˜• ë¶„ì„ ì—…ë°ì´íŠ¸
    displayGoalAnalysis(matchStats.goalTypes);
    
    // ì£¼ìš” ì„ ìˆ˜ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì‚¬ìš©ìì˜ ëª¨ë“  ë§¤ì¹˜ ë°ì´í„° ì‚¬ìš©)
    if (currentUserInfo && currentUserInfo.matches) {
        displayTopPlayers(currentUserInfo.matches);
    }
    
    console.log('í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', {
        winRate: matchStats.winRate,
        avgGoals: matchStats.avgGoals.toFixed(1),
        avgConceded: matchStats.avgConceded.toFixed(1),
        trend: matchStats.trend
    });
}

// í…Œë§ˆ ì „í™˜ í•¨ìˆ˜
function initTheme() {
    // ë‹¤í¬ í…Œë§ˆë¡œ ê³ ì •
    document.documentElement.setAttribute('data-theme', 'dark');
}

// ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
searchBtn.addEventListener('click', searchUser);
nicknameInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchUser();
    }
});

// íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸
tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab');
        switchTab(tabId);
    });
});

// ë”ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
loadMoreBtn.addEventListener('click', loadMoreMatches);


// ìœ ì € ê²€ìƒ‰ í•¨ìˆ˜ (ì„œë²„ì—ì„œ í•œ ë²ˆì— ì²˜ë¦¬)
async function searchUser() {
    const nickname = nicknameInput.value.trim();
    
    if (!nickname) {
        showError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        showLoading(true);
        hideError();
        hideResults();
        
        // ì„œë²„ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ (ì„œë²„ì—ì„œ 2ë‹¨ê³„ ëª¨ë‘ ì²˜ë¦¬)
        const url = `/api/search/${encodeURIComponent(nickname)}`;
        console.log('ì„œë²„ API í˜¸ì¶œ URL:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('ì„œë²„ ì—ëŸ¬ ì‘ë‹µ:', errorText);
            
            if (response.status === 404) {
                showError('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (response.status === 400) {
                showError('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë‹‰ë„¤ì„ í˜•ì‹ì…ë‹ˆë‹¤. íŠ¹ìˆ˜ë¬¸ìë‚˜ ê³µë°± ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
        }
        
        const userInfo = await response.json();
        console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', userInfo);
        
            if (userInfo) {
                currentUserInfo = userInfo; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                currentMatchOffset = 10; // ë”ë³´ê¸° ì˜¤í”„ì…‹ ì´ˆê¸°í™”
                
                // êµ¬ë‹¨ë³„ ë°ì´í„° ìºì‹œ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì‚¬ìš©ì ê²€ìƒ‰ ì‹œ)
                teamDataCache = null;
                teamDataLoaded = false;
                console.log('ìƒˆë¡œìš´ ì‚¬ìš©ì ê²€ìƒ‰ìœ¼ë¡œ ì¸í•´ êµ¬ë‹¨ë³„ ë°ì´í„° ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // í¬ë©”ì´ì…˜ ë°ì´í„° ìºì‹œ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì‚¬ìš©ì ê²€ìƒ‰ ì‹œ)
                formationDataCache = null;
                formationDataLoaded = false;
                console.log('ìƒˆë¡œìš´ ì‚¬ìš©ì ê²€ìƒ‰ìœ¼ë¡œ ì¸í•´ í¬ë©”ì´ì…˜ ë°ì´í„° ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // teamDetailPanel ì´ˆê¸°í™”
                const teamDetailPanel = document.getElementById('teamDetailPanel');
                if (teamDetailPanel) {
                    teamDetailPanel.innerHTML = `
                        <div class="team-detail-placeholder">
                            <div class="placeholder-icon">âš½</div>
                            <h4>êµ¬ë‹¨ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h4>
                            <p>ìœ„ì—ì„œ êµ¬ë‹¨ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    // displayëŠ” ì„¤ì •í•˜ì§€ ì•ŠìŒ (êµ¬ë‹¨ë³„ ë°ì´í„° íƒ­ í´ë¦­ ì‹œ í‘œì‹œë¨)
                }
                
                // ê²€ìƒ‰ ê¸°ë¡ì— ì¶”ê°€
                addToSearchHistory(nickname);
                
                displayPlayerInfo(userInfo, nickname);
                showDashboard(userInfo);
            } else {
                showError('ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        
    } catch (error) {
        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        if (error.message.includes('400')) {
            showError('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } else if (error.message.includes('404')) {
            showError('í•´ë‹¹ ë‹‰ë„¤ì„ì˜ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        } else if (error.message.includes('500')) {
            showError('ì„œë²„ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } else {
            showError('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    } finally {
        showLoading(false);
    }
}

// ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
async function testNexonAPI() {
    console.log('ë„¥ìŠ¨ API í…ŒìŠ¤íŠ¸ ì‹œì‘...');
    
    // í…ŒìŠ¤íŠ¸ìš© ë‹‰ë„¤ì„ (ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
    const testNickname = 'test';
    
    // ê°€ì¥ ì¼ë°˜ì ì¸ ë„¥ìŠ¨ API í˜•ì‹ ì‹œë„
    const testUrl = `${NEXON_ENDPOINTS.userBasic}?nickname=${encodeURIComponent(testNickname)}`;
    const testHeaders = {
        'x-nxopen-api-key': API_KEY,
        'Content-Type': 'application/json'
    };
    
    try {
        console.log('í…ŒìŠ¤íŠ¸ URL:', testUrl);
        console.log('í…ŒìŠ¤íŠ¸ í—¤ë”:', testHeaders);
        
        const response = await fetch(testUrl, {
            method: 'GET',
            headers: testHeaders
        });
        
        console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
        console.log('ì‘ë‹µ í—¤ë”:', [...response.headers.entries()]);
        
        const responseText = await response.text();
        console.log('ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText);
        
        if (response.ok) {
            try {
                const data = JSON.parse(responseText);
                console.log('íŒŒì‹±ëœ ë°ì´í„°:', data);
                return data;
            } catch (e) {
                console.log('JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ í…ìŠ¤íŠ¸:', responseText);
                return responseText;
            }
        } else {
            console.error('API ì˜¤ë¥˜:', response.status, responseText);
            return null;
        }
        
    } catch (error) {
        console.error('API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
        return null;
    }
}

// ë‹‰ë„¤ì„ìœ¼ë¡œ accessId ì¡°íšŒ (ì„œë²„ë¥¼ í†µí•´)
async function getAccessIdByNickname(nickname) {
    try {
        console.log('ìœ ì € ê²€ìƒ‰ ì‹œì‘:', nickname);
        
        // ì„œë²„ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
        const url = `/api/search/${encodeURIComponent(nickname)}`;
        console.log('ì„œë²„ API í˜¸ì¶œ URL:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('ì„œë²„ ì—ëŸ¬ ì‘ë‹µ:', errorText);
            
            if (response.status === 404) {
                return null; // ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
            }
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
        return data.id || data.accessId || data.userId;
        
    } catch (error) {
        console.error('AccessId ì¡°íšŒ ì˜¤ë¥˜:', error);
        throw error;
    }
}

// accessIdë¡œ ìœ ì € ì •ë³´ ì¡°íšŒ (ì„œë²„ë¥¼ í†µí•´)
async function getUserInfo(accessId) {
    try {
        console.log('ìœ ì € ì •ë³´ ì¡°íšŒ ì‹œì‘:', accessId);
        
        // ì„œë²„ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
        const url = `/api/user/${accessId}`;
        console.log('ì„œë²„ API í˜¸ì¶œ URL:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('ì„œë²„ ì—ëŸ¬ ì‘ë‹µ:', errorText);
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
        return data;
        
    } catch (error) {
        console.error('ìœ ì € ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
        throw error;
    }
}

// ì„ ìˆ˜ ì •ë³´ í‘œì‹œ - ê³µì‹ ê²½ê¸° ë“±ê¸‰ ì‹œìŠ¤í…œ ì ìš©
function displayPlayerInfo(userInfo, nickname) {
    // ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ ë””ë²„ê¹…
    console.log('ì‚¬ìš©ì ì •ë³´ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ í™•ì¸:', {
        controller: userInfo.controller,
        controllerType: userInfo.controllerType,
        inputDevice: userInfo.inputDevice,
        ì „ì²´ì‚¬ìš©ìì •ë³´: userInfo
    });
    
    // ì„ ìˆ˜ ì´ë¦„ ì„¤ì • (ì»¨íŠ¸ë¡¤ëŸ¬ ì´ëª¨ì§€ í¬í•¨)
    const controllerEmoji = getControllerEmoji(userInfo.controller);
    const displayName = userInfo.nickname || nickname;
    playerName.textContent = `${displayName} ${controllerEmoji}`;
    
    // ë ˆë²¨ ì„¤ì •
    if (userInfo.level !== undefined && userInfo.level !== null) {
        playerLevel.textContent = userInfo.level;
    }
    
    // ì—­ëŒ€ ìµœê³  ë“±ê¸‰ ì •ë³´ë§Œ ì‚¬ìš©
    const maxDivision = userInfo.maxDivision;
    const maxDivisionInfo = userInfo.maxDivisionInfo;
    
    console.log('ì—­ëŒ€ ìµœê³  ë“±ê¸‰ ì •ë³´:', {
        maxDivision,
        maxDivisionInfo: maxDivisionInfo?.name
    });
    
    // ë“±ê¸‰ ì´ë¯¸ì§€ í‘œì‹œ (ì—­ëŒ€ ìµœê³  ë“±ê¸‰ë§Œ í‘œì‹œ)
    displayDivisionImage('currentGradeImage', maxDivision, maxDivisionInfo);
    // ìµœê³  ë“±ê¸‰ ì´ë¯¸ì§€ëŠ” ìˆ¨ê¹€ ì²˜ë¦¬ (ì¤‘ë³µ ë°©ì§€)
    const highestGradeElement = document.getElementById('highestGradeImage');
    if (highestGradeElement) {
        highestGradeElement.style.display = 'none';
    }
    
    // ê²½ê¸° íŠ¹ì§• í‘œì‹œ
    displayPlayerCharacteristics(userInfo);
    
    // ì„ ìˆ˜ ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ í‘œì‹œ
    playerBasicInfo.style.display = 'block';
}

// ê³µì‹ ê²½ê¸° ë“±ê¸‰ ì´ë¯¸ì§€ í‘œì‹œ í•¨ìˆ˜
function displayDivisionImage(elementId, divisionId, divisionInfo) {
    const element = document.getElementById(elementId);
    
    if (!element) return;
    
    console.log('ë“±ê¸‰ ì´ë¯¸ì§€ í‘œì‹œ:', {
        elementId,
        divisionId,
        divisionInfo: divisionInfo?.name,
        level: divisionInfo?.level
    });
    
    // ê¸°ì¡´ ë“±ê¸‰ í´ë˜ìŠ¤ ì œê±°
    element.className = element.className.replace(/division-\d+/g, '');
    
    if (divisionId && divisionInfo) {
        // ê³µì‹ ê²½ê¸° ë“±ê¸‰ ì´ë¯¸ì§€ URL ìƒì„±
        const imageUrl = getDivisionImageUrl(divisionInfo.level);
        console.log('ë“±ê¸‰ ì´ë¯¸ì§€ URL:', imageUrl);
        
        element.innerHTML = `
            <img src="${imageUrl}" 
                 alt="${divisionInfo.name}" 
                 class="grade-image" 
                 onerror="this.style.display='none'">
        `;
        element.title = `${divisionInfo.name} (${divisionInfo.description})`;
        
        console.log('ë“±ê¸‰ ì´ë¯¸ì§€ ì„¤ì • ì™„ë£Œ:', {
            divisionId,
            name: divisionInfo.name,
            level: divisionInfo.level,
            color: divisionInfo.color,
            imageUrl
        });
    } else {
        console.log('ë“±ê¸‰ ì •ë³´ ì—†ìŒ, ì´ë¯¸ì§€ í‘œì‹œí•˜ì§€ ì•ŠìŒ');
        // ë“±ê¸‰ ì •ë³´ê°€ ì—†ì„ ë•ŒëŠ” ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        element.innerHTML = '';
        element.title = '';
        element.style.borderColor = '';
    }
}

// ê³µì‹ ê²½ê¸° ë“±ê¸‰ ì´ë¯¸ì§€ URL ìƒì„±
function getDivisionImageUrl(level) {
    // ì‚¬ìš©ìê°€ ì œê³µí•œ ì´ë¯¸ì§€ URL ì‚¬ìš©
    const baseUrl = 'https://ssl.nexon.com/s2/game/fo4/obt/rank/large/update_2009/';
    
    // ë ˆë²¨ì„ ì´ë¯¸ì§€ ë²ˆí˜¸ë¡œ ë§¤í•‘ (level 1 = ico_rank0, level 18 = ico_rank17)
    const imageNumber = level - 1;
    const fileName = `ico_rank${imageNumber}.png`;
    
    const imageUrl = `${baseUrl}${fileName}`;
    console.log('ìƒì„±ëœ ì´ë¯¸ì§€ URL:', imageUrl, 'level:', level, 'imageNumber:', imageNumber);
    
    return imageUrl;
}

// ê¸°ì¡´ ë“±ê¸‰ ì´ë¯¸ì§€ í‘œì‹œ í•¨ìˆ˜ (ì¹´ë“œ ë“±ê¸‰ìš© - í˜¸í™˜ì„± ìœ ì§€)
function displayGradeImage(elementId, gradeValue) {
    const element = document.getElementById(elementId);
    
    if (!element) return;
    
    // ê¸°ì¡´ ë“±ê¸‰ í´ë˜ìŠ¤ ì œê±°
    element.className = element.className.replace(/grade-\d+/g, '');
    
    if (gradeValue && gradeValue !== '-') {
        // ë“±ê¸‰ì— ë”°ë¥¸ ì´ëª¨ì§€ë‚˜ í…ìŠ¤íŠ¸ í‘œì‹œ
        const gradeEmoji = getGradeEmoji(gradeValue);
        element.innerHTML = `<span class="grade-display">${gradeEmoji}</span>`;
        element.title = `ë“±ê¸‰: ${gradeValue}`;
        
        // ë“±ê¸‰ë³„ CSS í´ë˜ìŠ¤ ì¶”ê°€
        element.classList.add(`grade-${gradeValue}`);
    } else {
        element.innerHTML = '<span class="grade-display">-</span>';
        element.title = 'ë“±ê¸‰ ì •ë³´ ì—†ìŒ';
        element.classList.add('grade-0');
    }
}

// ë“±ê¸‰ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
function getGradeEmoji(grade) {
    const gradeMap = {
        0: 'âšª',   // ê¸°ë³¸
        1: 'âšª',   // +1 (ê°ˆìƒ‰)
        2: 'ğŸŸ¤',   // +2 (ê°ˆìƒ‰)
        3: 'ğŸŸ¤',   // +3 (ê°ˆìƒ‰)
        4: 'ğŸŸ¤',   // +4 (ê°ˆìƒ‰)
        5: 'âšª',   // +5 (ì€ìƒ‰)
        6: 'âšª',   // +6 (ì€ìƒ‰)
        7: 'âšª',   // +7 (ì€ìƒ‰)
        8: 'ğŸŸ¡',   // +8 (ê¸ˆìƒ‰)
        9: 'ğŸŸ¡',   // +9 (ê¸ˆìƒ‰)
        10: 'ğŸŸ¡',  // +10 (ê¸ˆìƒ‰)
        11: 'ğŸ”µ',  // +11 (ë°±ê¸ˆìƒ‰)
        12: 'ğŸ”µ',  // +12 (ë°±ê¸ˆìƒ‰)
        13: 'ğŸ”µ'   // +13 (ë°±ê¸ˆìƒ‰)
    };
    
    return gradeMap[grade] || 'âšª';
}

// ë“±ê¸‰ í…ìŠ¤íŠ¸ ì„¤ì • (ê°„ì†Œí™”ëœ ë²„ì „) - ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€
function setGradeDisplay(gradeType, gradeValue) {
    const textElement = document.getElementById(`${gradeType}Text`);
    
    if (textElement) {
        if (gradeValue && gradeValue !== '-') {
            textElement.textContent = gradeValue;
        } else {
            textElement.textContent = '-';
        }
    }
}

// ëŒ€ì‹œë³´ë“œ í‘œì‹œ
function showDashboard(userInfo) {
    tabContainer.style.display = 'block';
    
    // ê¸°ë³¸ì ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ íƒ­ í™œì„±í™”
    switchTab('dashboard');
    
    // ì‹¤ì œ ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ì±„ìš°ê¸° (ë”ë³´ê¸° ë²„íŠ¼ ìƒíƒœë„ í¬í•¨)
    loadDashboardData(userInfo);
}

// íƒ­ ì „í™˜ í•¨ìˆ˜
function switchTab(tabId) {
    // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
    tabBtns.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));
    
    // ì„ íƒëœ íƒ­ í™œì„±í™”
    const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
    const activeContent = document.getElementById(tabId);
    
    if (activeBtn && activeContent) {
        activeBtn.classList.add('active');
        activeContent.classList.add('active');
        
        // êµ¬ë‹¨ë³„ ë°ì´í„° íƒ­ì¸ ê²½ìš° ë°ì´í„° ë¶„ì„
        if (tabId === 'team') {
            console.log('êµ¬ë‹¨ë³„ ë°ì´í„° íƒ­ í´ë¦­ë¨');
            console.log('currentUserData ì¡´ì¬ ì—¬ë¶€:', !!currentUserData);
            console.log('ìºì‹œ ìƒíƒœ í™•ì¸:', 'teamDataLoaded:', teamDataLoaded, 'teamDataCache:', !!teamDataCache);
            
            if (currentUserData) {
                // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ë¶„ì„
                if (teamDataLoaded && teamDataCache) {
                    console.log('ìºì‹œëœ êµ¬ë‹¨ë³„ ë°ì´í„°ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    displayTeamFormationCards(teamDataCache.formations);
                    displayTeamTopPlayers(teamDataCache.matches);
                    
                    // ì‹¤ì œ ê²½ê¸° ìˆ˜ ì—…ë°ì´íŠ¸
                    const actualMatchCount = document.getElementById('actualMatchCount');
                    if (actualMatchCount && teamDataCache.matches) {
                        actualMatchCount.textContent = teamDataCache.matches.length;
                    }
                    
                    // ì„¹ì…˜ í‘œì‹œ
                    const topPlayersSection = document.getElementById('topPlayersSection');
                    if (topPlayersSection) {
                        topPlayersSection.style.display = 'block';
                    }
                    
                    // teamLayout í‘œì‹œ
                    const teamLayout = document.getElementById('teamLayout');
                    if (teamLayout) {
                        teamLayout.style.display = 'flex';
                    }
                    
                    // teamDetailPanel í‘œì‹œ (ê°€ì´ë“œ)
                    const teamDetailPanel = document.getElementById('teamDetailPanel');
                    if (teamDetailPanel) {
                        teamDetailPanel.style.display = 'block';
                    }
                    
                    // teamCardGuide í‘œì‹œ
                    if (teamCardGuide) {
                        teamCardGuide.style.display = 'block';
                    }
                    
                    hideTeamLoading();
                } else {
                    console.log('ìºì‹œëœ ë°ì´í„°ê°€ ì—†ì–´ì„œ ìƒˆë¡œ ë¶„ì„í•©ë‹ˆë‹¤.');
                    // UI ìš”ì†Œë“¤ë§Œ ì´ˆê¸°í™” (ìºì‹œëŠ” ìœ ì§€)
                    const teamLayout = document.getElementById('teamLayout');
                    const topPlayersSection = document.getElementById('topPlayersSection');
                    if (teamLayout) teamLayout.style.display = 'none';
                    if (topPlayersSection) topPlayersSection.style.display = 'none';
                    
                    // teamDetailPanel í‘œì‹œ (ê°€ì´ë“œ)
                    const teamDetailPanel = document.getElementById('teamDetailPanel');
                    if (teamDetailPanel) {
                        teamDetailPanel.style.display = 'block';
                    }
                    
                    // teamCardGuide í‘œì‹œ
                    if (teamCardGuide) {
                        teamCardGuide.style.display = 'block';
                    }
                    
                    analyzeTeamData();
                }
            } else {
                console.log('ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ì–´ì„œ ë°ì´í„° ì—†ìŒ í‘œì‹œ');
                showNoTeamData();
            }
        }
        
        // í¬ë©”ì´ì…˜ ë¶„ì„ íƒ­ì¸ ê²½ìš° ë°ì´í„° ë¶„ì„
        if (tabId === 'stats') {
            console.log('í¬ë©”ì´ì…˜ ë¶„ì„ íƒ­ í´ë¦­ë¨');
            console.log('currentUserData ì¡´ì¬ ì—¬ë¶€:', !!currentUserData);
            console.log('ìºì‹œ ìƒíƒœ í™•ì¸:', 'formationDataLoaded:', formationDataLoaded, 'formationDataCache:', !!formationDataCache);
            
            if (currentUserData) {
                // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ë¶„ì„
                if (formationDataLoaded && formationDataCache) {
                    console.log('ìºì‹œëœ í¬ë©”ì´ì…˜ ë°ì´í„°ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    displayFormationPerformances(formationDataCache.performances);
                    // ê·¸ë£¹ ë°ì´í„°ëŠ” í¬ë©”ì´ì…˜ ì¹´ë“œ í´ë¦­ ì‹œ í‘œì‹œë¨
                    showFormationGroupsGuide('í¬ë©”ì´ì…˜ ì„±ê³¼ ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ í•´ë‹¹ í¬ë©”ì´ì…˜ì˜ ìƒì„¸ ê·¸ë£¹ ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”.');
                    // ìºì‹œëœ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    window.formationGroupsData = formationDataCache.detailedGroups;
                    window.formationMatchesData = formationDataCache.matchesData;
                    hideFormationLoading();
                } else {
                    console.log('ìºì‹œëœ ë°ì´í„°ê°€ ì—†ì–´ì„œ ìƒˆë¡œ ë¶„ì„í•©ë‹ˆë‹¤.');
                    // ë¡œë”© ìƒíƒœ ë¨¼ì € í‘œì‹œ
                    showFormationLoading('100ê²½ê¸° ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘...');
                    // ì•½ê°„ì˜ ì§€ì—° í›„ ë¶„ì„ ì‹œì‘ (UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
                    setTimeout(() => {
                        analyzeFormationData();
                    }, 100);
                }
            } else {
                console.log('ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ì–´ì„œ ë°ì´í„° ì—†ìŒ í‘œì‹œ');
                showNoFormationData();
            }
        }
    }
}

// ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
function loadDashboardData(userInfo) {
    // ì „ì—­ ë³€ìˆ˜ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ë”ë³´ê¸° ê¸°ëŠ¥ì—ì„œ ì‚¬ìš©)
    currentUserInfo = userInfo;
    currentUserData = userInfo; // êµ¬ë‹¨ë³„ ë°ì´í„° ë¶„ì„ì„ ìœ„í•´ ì¶”ê°€
    // ë”ë³´ê¸° ì˜¤í”„ì…‹ ì´ˆê¸°í™”
    currentMatchOffset = 10;
    
    if (userInfo && userInfo.matches && userInfo.matches.length > 0) {
        // ì „ì²´ ê²½ê¸° ë°ì´í„°ë¡œ í†µê³„ ê³„ì‚° (ìŠ¹ë¥ , í‰ê·  ë“ì  ë“±)
        const matchStats = calculateMatchStats(userInfo.matches);
        
        // ìŠ¹ë¥ , í‰ê·  ë“ì , í‰ê·  ì‹¤ì  í‘œì‹œ
        winRate.textContent = `${matchStats.winRate}%`;
        winRate.className = `summary-value ${getStatClass(matchStats.winRate, 'winRate')}`;
        avgGoals.textContent = matchStats.avgGoals.toFixed(1);
        avgConceded.textContent = matchStats.avgConceded.toFixed(1);
        
        // ê²½ê¸°ë ¥ íŠ¸ë Œë“œ í‘œì‹œ
        displayTrend(matchStats.trend);
        
        // ê³¨ ìœ í˜• ë¶„ì„ í‘œì‹œ
        displayGoalAnalysis(matchStats.goalTypes);
        
        // ì£¼ìš” ì„ ìˆ˜ í‘œì‹œ
        console.log('userInfo.matches êµ¬ì¡° í™•ì¸:', userInfo.matches?.length, userInfo.matches?.[0]);
        displayTopPlayers(userInfo.matches || []);
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ ëª¨ë“  ë§¤ì¹˜ í‘œì‹œ (ì„œë²„ì—ì„œ ëª¨ë“  ë§¤ì¹˜ë¥¼ ê°€ì ¸ì˜´)
        const initialMatches = userInfo.matches || [];
        displayRealMatches(initialMatches);
        
        // ë”ë³´ê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì • (í•­ìƒ í‘œì‹œ)
        loadMoreBtn.style.display = 'block';
        if (userInfo.matches && userInfo.matches.length > 0) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = 'ë”ë³´ê¸°';
        } else {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = 'ë” ì´ìƒ ì—†ìŒ';
        }
    } else {
        // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ê°’ í‘œì‹œ
        winRate.textContent = '-';
        avgGoals.textContent = '-';
        avgConceded.textContent = '-';
        trendText.textContent = '-';
        
        // íŠ¸ë Œë“œ ì´ëª¨ì§€ë„ ì´ˆê¸°í™”
        const trendIcon = document.querySelector('.trend-icon');
        if (trendIcon) {
            trendIcon.textContent = '';
        }
        
        // ê²½ê¸° ê¸°ë¡ì´ ì—†ìŒ í‘œì‹œ
        matchesList.innerHTML = '<div class="no-matches">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.disabled = true;
        loadMoreBtn.innerHTML = 'ë” ì´ìƒ ì—†ìŒ';
        displayGoalAnalysis({ 
            closeRange: 0, 
            midRange: 0, 
            heading: 0,
            calculationDetails: {
                totalGoals: 0,
                closeRangeGoals: 0,
                midRangeGoals: 0,
                headingGoals: 0,
                matchCount: 0,
                closeRangePercent: 0,
                midRangePercent: 0,
                headingPercent: 0
            }
        }); // ê³¨ ìœ í˜•ë„ ì´ˆê¸°í™”
        
        // ê²½ê¸° ìˆ˜ ì—…ë°ì´íŠ¸
        updateMatchCount();
    }
}

// ê²½ê¸° í†µê³„ ê³„ì‚°
function calculateMatchStats(matches) {
    if (!matches || matches.length === 0) {
        return {
            winRate: 0,
            avgGoals: 0,
            avgConceded: 0,
            trend: 'stable',
            goalTypes: { closeRange: 0, midRange: 0, heading: 0 }
        };
    }
    
    let wins = 0;
    let totalGoals = 0;
    let totalConceded = 0;
    let recentResults = [];
    
    matches.forEach(match => {
        // ìŠ¹íŒ¨ ê³„ì‚° (ìƒˆë¡œìš´ API ì‘ë‹µ êµ¬ì¡°)
        const matchResult = match.matchResult || 0; // 0: ë¬´ìŠ¹ë¶€, 1: ìŠ¹ë¦¬, 2: íŒ¨ë°°
        if (matchResult === 1) wins++;
        
        // ë“ì /ì‹¤ì  ê³„ì‚° (ìƒˆë¡œìš´ API ì‘ë‹µ êµ¬ì¡°)
        const goals = match.userGoals || 0;
        const conceded = match.opponentGoals || 0;
        totalGoals += goals;
        totalConceded += conceded;
        
        recentResults.push({
            result: matchResult,
            goals: goals,
            conceded: conceded
        });
    });
    
    const winRate = Math.round((wins / matches.length) * 100);
    const avgGoals = totalGoals / matches.length;
    const avgConceded = totalConceded / matches.length;
    
    // íŠ¸ë Œë“œ ê³„ì‚° (ìµœê·¼ 5ê²½ê¸° vs ì´ì „ 5ê²½ê¸°)
    const trend = calculateTrend(recentResults);
    
    // ê³¨ ìœ í˜• ë¶„ì„ (ì‹¤ì œ ê²½ê¸° ë°ì´í„° ê¸°ë°˜)
    const goalTypes = calculateGoalTypes(matches);
    
    return {
        winRate,
        avgGoals,
        avgConceded,
        trend,
        goalTypes
    };
}

// íŠ¸ë Œë“œ ê³„ì‚°
function calculateTrend(results) {
    if (results.length < 6) return 'stable';
    
    const recent = results.slice(0, 5);
    const older = results.slice(5, 10);
    
    const recentWinRate = recent.filter(r => r.result === 1).length / recent.length;
    const olderWinRate = older.filter(r => r.result === 1).length / older.length;
    
    const diff = recentWinRate - olderWinRate;
    
    if (diff > 0.2) return 'rising';
    if (diff < -0.2) return 'falling';
    return 'stable';
}

// ê³¨ ìœ í˜• ë¶„ì„ ê³„ì‚° (ì‹¤ì œ API ìŠ› ë°ì´í„° ê¸°ë°˜)
function calculateGoalTypes(matches) {
    if (!matches || matches.length === 0) {
        return { closeRange: 0, midRange: 0, heading: 0, calculationDetails: null };
    }
    
    let totalGoals = 0;
    let closeRangeGoals = 0;  // í˜ë„í‹° ë°•ìŠ¤ ì•ˆ ê³¨ (ê·¼ê±°ë¦¬)
    let midRangeGoals = 0;    // í˜ë„í‹° ë°•ìŠ¤ ë°– ê³¨ (ì¤‘ê±°ë¦¬)
    let headingGoals = 0;     // í—¤ë”© ê³¨
    
    console.log('ê³¨ ìœ í˜• ë¶„ì„ ì‹œì‘, ê²½ê¸° ìˆ˜:', matches.length);
    
    // ê° ê²½ê¸°ì—ì„œ ì‹¤ì œ ìŠ› ë°ì´í„° ë¶„ì„
    matches.forEach(match => {
        // userStatsì—ì„œ ìŠ› ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const userStats = match.userStats;
        if (userStats && userStats.shoot) {
            const shoot = userStats.shoot;
            
            // ì‹¤ì œ ê³¨ ìˆ˜ í™•ì¸
            const goals = shoot.goalTotal || 0;
            totalGoals += goals;
            
            // í˜ë„í‹° ë°•ìŠ¤ ì•ˆ ê³¨ (ê·¼ê±°ë¦¬)
            const inPenaltyGoals = shoot.goalInPenalty || 0;
            closeRangeGoals += inPenaltyGoals;
            
            // í˜ë„í‹° ë°•ìŠ¤ ë°– ê³¨ (ì¤‘ê±°ë¦¬)
            const outPenaltyGoals = shoot.goalOutPenalty || 0;
            midRangeGoals += outPenaltyGoals;
            
            // í—¤ë”© ê³¨
            const headGoals = shoot.goalHeading || 0;
            headingGoals += headGoals;
            
            console.log(`ê²½ê¸° ${match.matchId}: ì´ ${goals}ê³¨ (í˜ë°•ì•ˆ: ${inPenaltyGoals}, í˜ë°•ë°–: ${outPenaltyGoals}, í—¤ë”©: ${headGoals})`);
        } else {
            console.log(`ê²½ê¸° ${match.matchId}: ìŠ› ë°ì´í„° ì—†ìŒ`);
        }
    });
    
    console.log(`ì´ ê³¨: ${totalGoals}, ê·¼ê±°ë¦¬: ${closeRangeGoals}, ì¤‘ê±°ë¦¬: ${midRangeGoals}, í—¤ë”©: ${headingGoals}`);
    
    // ê³¨ì´ ì—†ëŠ” ê²½ìš°
    if (totalGoals === 0) {
        return { closeRange: 0, midRange: 0, heading: 0, calculationDetails: null };
    }
    
    // í¼ì„¼íŠ¸ ê³„ì‚°
    let closeRangePercent = Math.round((closeRangeGoals / totalGoals) * 100);
    let midRangePercent = Math.round((midRangeGoals / totalGoals) * 100);
    let headingPercent = Math.round((headingGoals / totalGoals) * 100);
    
    // ì´í•©ì´ 100%ê°€ ë˜ë„ë¡ ì •ê·œí™”
    const total = closeRangePercent + midRangePercent + headingPercent;
    if (total > 0) {
        closeRangePercent = Math.round((closeRangePercent / total) * 100);
        midRangePercent = Math.round((midRangePercent / total) * 100);
        headingPercent = Math.round((headingPercent / total) * 100);
    }
    
    // ê³„ì‚° ê³¼ì • ì €ì¥
    const calculationDetails = {
        totalGoals: totalGoals,
        closeRangeGoals: closeRangeGoals,
        midRangeGoals: midRangeGoals,
        headingGoals: headingGoals,
        matchCount: matches.length,
        closeRangePercent: closeRangePercent,
        midRangePercent: midRangePercent,
        headingPercent: headingPercent
    };
    
    const result = {
        closeRange: closeRangePercent,
        midRange: midRangePercent,
        heading: headingPercent,
        calculationDetails: calculationDetails
    };
    
    console.log('ê³¨ ìœ í˜• ë¶„ì„ ê²°ê³¼:', result);
    
    return result;
}

// ìŠ›ì„ ì‹œë„í•œ ìœ í˜• ë¶„ì„ ê³„ì‚° (ì‹¤ì œ API ìŠ› ë°ì´í„° ê¸°ë°˜)
function calculateShootTypes(matches) {
    if (!matches || matches.length === 0) {
        return { closeRange: 0, midRange: 0, heading: 0 };
    }
    
    let totalShoots = 0;
    let closeRangeShoots = 0;  // í˜ë„í‹° ë°•ìŠ¤ ì•ˆ ìŠ› (ê·¼ê±°ë¦¬)
    let midRangeShoots = 0;    // í˜ë„í‹° ë°•ìŠ¤ ë°– ìŠ› (ì¤‘ê±°ë¦¬)
    let headingShoots = 0;     // í—¤ë”© ìŠ›
    
    console.log('ìŠ› ìœ í˜• ë¶„ì„ ì‹œì‘, ê²½ê¸° ìˆ˜:', matches.length);
    
    // ê° ê²½ê¸°ì—ì„œ ì‹¤ì œ ìŠ› ë°ì´í„° ë¶„ì„
    matches.forEach(match => {
        // userStatsì—ì„œ ìŠ› ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const userStats = match.userStats;
        if (userStats && userStats.shoot) {
            const shoot = userStats.shoot;
            
            // ì‹¤ì œ ìŠ› ìˆ˜ í™•ì¸
            const shoots = shoot.shootTotal || 0;
            totalShoots += shoots;
            
            // í˜ë„í‹° ë°•ìŠ¤ ì•ˆ ìŠ› (ê·¼ê±°ë¦¬)
            const inPenaltyShoots = shoot.shootInPenalty || 0;
            closeRangeShoots += inPenaltyShoots;
            
            // í˜ë„í‹° ë°•ìŠ¤ ë°– ìŠ› (ì¤‘ê±°ë¦¬)
            const outPenaltyShoots = shoot.shootOutPenalty || 0;
            midRangeShoots += outPenaltyShoots;
            
            // í—¤ë”© ìŠ›
            const headShoots = shoot.shootHeading || 0;
            headingShoots += headShoots;
            
            console.log(`ê²½ê¸° ${match.matchId}: ì´ ${shoots}ìŠ› (í˜ë°•ì•ˆ: ${inPenaltyShoots}, í˜ë°•ë°–: ${outPenaltyShoots}, í—¤ë”©: ${headShoots})`);
        } else {
            console.log(`ê²½ê¸° ${match.matchId}: ìŠ› ë°ì´í„° ì—†ìŒ`);
        }
    });
    
    console.log(`ì´ ìŠ›: ${totalShoots}, ê·¼ê±°ë¦¬: ${closeRangeShoots}, ì¤‘ê±°ë¦¬: ${midRangeShoots}, í—¤ë”©: ${headingShoots}`);
    
    // ìŠ›ì´ ì—†ëŠ” ê²½ìš°
    if (totalShoots === 0) {
        return { closeRange: 0, midRange: 0, heading: 0 };
    }
    
    // í¼ì„¼íŠ¸ ê³„ì‚°
    let closeRangePercent = Math.round((closeRangeShoots / totalShoots) * 100);
    let midRangePercent = Math.round((midRangeShoots / totalShoots) * 100);
    let headingPercent = Math.round((headingShoots / totalShoots) * 100);
    
    // ì´í•©ì´ 100%ê°€ ë˜ë„ë¡ ì •ê·œí™”
    const total = closeRangePercent + midRangePercent + headingPercent;
    if (total > 0) {
        closeRangePercent = Math.round((closeRangePercent / total) * 100);
        midRangePercent = Math.round((midRangePercent / total) * 100);
        headingPercent = Math.round((headingPercent / total) * 100);
    }
    
    const result = {
        closeRange: closeRangePercent,
        midRange: midRangePercent,
        heading: headingPercent
    };
    
    console.log('ìŠ› ìœ í˜• ë¶„ì„ ê²°ê³¼:', result);
    
    return result;
}

// íŠ¸ë Œë“œ í‘œì‹œ
function displayTrend(trend) {
    const trendIcon = document.querySelector('.trend-icon');
    const trendTextElement = document.getElementById('trendText');
    
    if (trendIcon && trendTextElement) {
        switch (trend) {
            case 'rising':
                trendIcon.textContent = 'ğŸ“ˆ';
                trendTextElement.textContent = 'ìƒìŠ¹ì„¸';
                trendTextElement.style.color = '#00d4aa';
                break;
            case 'falling':
                trendIcon.textContent = 'ğŸ“‰';
                trendTextElement.textContent = 'í•˜ë½ì„¸';
                trendTextElement.style.color = '#ff4757';
                break;
            default:
                trendIcon.textContent = 'â¡ï¸';
                trendTextElement.textContent = 'ì•ˆì •ì„¸';
                trendTextElement.style.color = '#ffa502';
        }
    }
}

// ê³¨ ìœ í˜• ë¶„ì„ í‘œì‹œ
// ì „ì—­ ë³€ìˆ˜ë¡œ ê³„ì‚° ê³¼ì • ì €ì¥
let currentGoalCalculationDetails = null;
let currentPlayerStatsDetails = null;

function displayGoalAnalysis(goalTypes) {
    // ê³„ì‚° ê³¼ì • ì €ì¥ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì œê³µ)
    currentGoalCalculationDetails = goalTypes.calculationDetails || {
        totalGoals: 0,
        closeRangeGoals: 0,
        midRangeGoals: 0,
        headingGoals: 0,
        matchCount: 0,
        closeRangePercent: 0,
        midRangePercent: 0,
        headingPercent: 0
    };
    
    // í¼ì„¼íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('closeRangePercent').textContent = `${goalTypes.closeRange}%`;
    document.getElementById('midRangePercent').textContent = `${goalTypes.midRange}%`;
    document.getElementById('headingPercent').textContent = `${goalTypes.heading}%`;
    
    // ì¹´ë“œ ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸
    updateGoalCardAnimations(goalTypes.closeRange, goalTypes.midRange, goalTypes.heading);
    
    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    addPercentClickEvents();
}

// í¼ì„¼íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
function addPercentClickEvents() {
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    removePercentClickEvents();
    
    // ê·¼ê±°ë¦¬ í¼ì„¼íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
    const closeRangePercent = document.getElementById('closeRangePercent');
    if (closeRangePercent) {
        closeRangePercent.style.cursor = 'pointer';
        closeRangePercent.addEventListener('click', () => {
            console.log('ê·¼ê±°ë¦¬ í¼ì„¼íŠ¸ í´ë¦­ë¨');
            showCalculationPopup('closeRange');
        });
    }
    
    // ì¤‘ê±°ë¦¬ í¼ì„¼íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
    const midRangePercent = document.getElementById('midRangePercent');
    if (midRangePercent) {
        midRangePercent.style.cursor = 'pointer';
        midRangePercent.addEventListener('click', () => {
            console.log('ì¤‘ê±°ë¦¬ í¼ì„¼íŠ¸ í´ë¦­ë¨');
            showCalculationPopup('midRange');
        });
    }
    
    // í—¤ë”© í¼ì„¼íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
    const headingPercent = document.getElementById('headingPercent');
    if (headingPercent) {
        headingPercent.style.cursor = 'pointer';
        headingPercent.addEventListener('click', () => {
            console.log('í—¤ë”© í¼ì„¼íŠ¸ í´ë¦­ë¨');
            showCalculationPopup('heading');
        });
    }
}

// ê¸°ì¡´ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
function removePercentClickEvents() {
    const closeRangePercent = document.getElementById('closeRangePercent');
    const midRangePercent = document.getElementById('midRangePercent');
    const headingPercent = document.getElementById('headingPercent');
    
    if (closeRangePercent) {
        closeRangePercent.replaceWith(closeRangePercent.cloneNode(true));
    }
    if (midRangePercent) {
        midRangePercent.replaceWith(midRangePercent.cloneNode(true));
    }
    if (headingPercent) {
        headingPercent.replaceWith(headingPercent.cloneNode(true));
    }
}

// ê³„ì‚° ê³¼ì • íŒì—… í‘œì‹œ
function showCalculationPopup(type) {
    console.log('showCalculationPopup í˜¸ì¶œë¨, type:', type);
    console.log('currentGoalCalculationDetails:', currentGoalCalculationDetails);
    
    if (!currentGoalCalculationDetails) {
        alert('ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const details = currentGoalCalculationDetails;
    let content = '';
    
    // ë°ì´í„°ê°€ ëª¨ë‘ 0ì¸ ê²½ìš° (ê²½ê¸° ê¸°ë¡ ì—†ìŒ)
    if (details.totalGoals === 0 && details.matchCount === 0) {
        content = `
            <h4>ğŸ“Š ê³„ì‚° ê³¼ì •</h4>
            <div class="calculation-step">
                <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ê²½ê¸° ê¸°ë¡ ì—†ìŒ</p>
                <p><strong>ì´ ê³¨ ìˆ˜:</strong> 0ê³¨</p>
                <p><strong>${type === 'closeRange' ? 'ê·¼ê±°ë¦¬' : type === 'midRange' ? 'ì¤‘ê±°ë¦¬' : 'í—¤ë”©'} ê³¨ ìˆ˜:</strong> 0ê³¨</p>
                <p><strong>ê³„ì‚°ì‹:</strong> (0 Ã· 0) Ã— 100 = 0%</p>
            </div>
            <div class="calculation-note">
                <p>ğŸ’¡ ê²½ê¸° ê¸°ë¡ì´ ìˆì–´ì•¼ ê³¨ ìœ í˜• ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
        `;
        
        // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
        document.getElementById('calculationPopupContent').innerHTML = content;
        
        // íŒì—… í‘œì‹œ
        document.getElementById('calculationPopup').style.display = 'flex';
        return;
    }
    
    switch(type) {
        case 'closeRange':
            content = `
                <h4>âš½ ê·¼ê±°ë¦¬ ê³¨ ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ ê³¨ ìˆ˜:</strong> ${details.totalGoals}ê³¨</p>
                    <p><strong>ê·¼ê±°ë¦¬ ê³¨ ìˆ˜:</strong> ${details.closeRangeGoals}ê³¨</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${details.closeRangeGoals} Ã· ${details.totalGoals}) Ã— 100 = ${details.closeRangePercent}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ìµœê·¼ ${details.matchCount}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>ê·¼ê±°ë¦¬ ê³¨:</strong> í˜ë„í‹° ë°•ìŠ¤ ì•ˆì—ì„œ ë„£ì€ ê³¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
        case 'midRange':
            content = `
                <h4>ğŸš€ ì¤‘ê±°ë¦¬ ê³¨ ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ ê³¨ ìˆ˜:</strong> ${details.totalGoals}ê³¨</p>
                    <p><strong>ì¤‘ê±°ë¦¬ ê³¨ ìˆ˜:</strong> ${details.midRangeGoals}ê³¨</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${details.midRangeGoals} Ã· ${details.totalGoals}) Ã— 100 = ${details.midRangePercent}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ìµœê·¼ ${details.matchCount}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>ì¤‘ê±°ë¦¬ ê³¨:</strong> í˜ë„í‹° ë°•ìŠ¤ ë°–ì—ì„œ ë„£ì€ ê³¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
        case 'heading':
            content = `
                <h4>ğŸ’¥ í—¤ë”© ê³¨ ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ ê³¨ ìˆ˜:</strong> ${details.totalGoals}ê³¨</p>
                    <p><strong>í—¤ë”© ê³¨ ìˆ˜:</strong> ${details.headingGoals}ê³¨</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${details.headingGoals} Ã· ${details.totalGoals}) Ã— 100 = ${details.headingPercent}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ìµœê·¼ ${details.matchCount}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>í—¤ë”© ê³¨:</strong> í—¤ë”©ìœ¼ë¡œ ë„£ì€ ê³¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
    }
    
    // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
    document.getElementById('calculationPopupContent').innerHTML = content;
    
    // íŒì—… í‘œì‹œ
    const popup = document.getElementById('calculationPopup');
    console.log('íŒì—… í‘œì‹œ ì‹œë„, popup ìš”ì†Œ:', popup);
    if (popup) {
        // ê°•ì œë¡œ ëª¨ë“  ìŠ¤íƒ€ì¼ ì„¤ì •
        popup.setAttribute('style', `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(0, 0, 0, 0.7) !important;
            z-index: 9999 !important;
            opacity: 1 !important;
            visibility: visible !important;
        `);
        console.log('íŒì—… í‘œì‹œ ì™„ë£Œ, display:', popup.style.display);
        console.log('íŒì—… ê³„ì‚°ëœ ìŠ¤íƒ€ì¼:', window.getComputedStyle(popup).display);
    } else {
        console.error('calculationPopup ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

// ê³„ì‚° íŒì—… ë‹«ê¸°
function closeCalculationPopup() {
    const popup = document.getElementById('calculationPopup');
    if (popup) {
        popup.style.display = 'none';
        popup.style.visibility = 'hidden';
        popup.style.opacity = '0';
        console.log('íŒì—… ë‹«ê¸° ì™„ë£Œ');
    }
}

// ì„ ìˆ˜ë³„ ì„±ê³µë¥  íŒì—… í‘œì‹œ
function showPlayerStatPopup(playerId, statType, playerName) {
    console.log('showPlayerStatPopup í˜¸ì¶œë¨:', { playerId, statType, playerName });
    
    if (!currentPlayerStatsDetails || !currentPlayerStatsDetails[playerId]) {
        alert('ì„ ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const playerData = currentPlayerStatsDetails[playerId];
    let content = '';
    
    switch(statType) {
        case 'pass':
            content = `
                <h4>âš½ ${playerName} íŒ¨ìŠ¤ ì„±ê³µë¥  ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ íŒ¨ìŠ¤ ì‹œë„:</strong> ${playerData.passTry}íšŒ</p>
                    <p><strong>íŒ¨ìŠ¤ ì„±ê³µ:</strong> ${playerData.passSuccess}íšŒ</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${playerData.passSuccess} Ã· ${playerData.passTry}) Ã— 100 = ${playerData.passSuccessRate}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ${playerData.totalMatches}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>íŒ¨ìŠ¤ ì„±ê³µë¥ :</strong> ì‹œë„í•œ íŒ¨ìŠ¤ ì¤‘ ì„±ê³µí•œ íŒ¨ìŠ¤ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
        case 'dribble':
            content = `
                <h4>ğŸƒ ${playerName} ë“œë¦¬ë¸” ì„±ê³µë¥  ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ ë“œë¦¬ë¸” ì‹œë„:</strong> ${playerData.dribbleTry}íšŒ</p>
                    <p><strong>ë“œë¦¬ë¸” ì„±ê³µ:</strong> ${playerData.dribbleSuccess}íšŒ</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${playerData.dribbleSuccess} Ã· ${playerData.dribbleTry}) Ã— 100 = ${playerData.dribbleSuccessRate}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ${playerData.totalMatches}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>ë“œë¦¬ë¸” ì„±ê³µë¥ :</strong> ì‹œë„í•œ ë“œë¦¬ë¸” ì¤‘ ì„±ê³µí•œ ë“œë¦¬ë¸”ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
        case 'possession':
            content = `
                <h4>ğŸ¯ ${playerName} ë³¼ ì†Œìœ  ì„±ê³µë¥  ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ ë³¼ ì†Œìœ  ì‹œë„:</strong> ${playerData.possessionTry}íšŒ</p>
                    <p><strong>ë³¼ ì†Œìœ  ì„±ê³µ:</strong> ${playerData.possessionSuccess}íšŒ</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${playerData.possessionSuccess} Ã· ${playerData.possessionTry}) Ã— 100 = ${playerData.possessionSuccessRate}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ${playerData.totalMatches}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>ë³¼ ì†Œìœ  ì„±ê³µë¥ :</strong> ë³¼ì„ ì†Œìœ í•˜ë ¤ ì‹œë„í•œ íšŸìˆ˜ ì¤‘ ì„±ê³µí•œ íšŸìˆ˜ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
        case 'aerial':
            content = `
                <h4>ğŸ’¥ ${playerName} ê³µì¤‘ë³¼ ì„±ê³µë¥  ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ ê³µì¤‘ë³¼ ì‹œë„:</strong> ${playerData.aerialDuels}íšŒ</p>
                    <p><strong>ê³µì¤‘ë³¼ ì„±ê³µ:</strong> ${playerData.aerialDuelsWon}íšŒ</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${playerData.aerialDuelsWon} Ã· ${playerData.aerialDuels}) Ã— 100 = ${playerData.aerialSuccessRate}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ${playerData.totalMatches}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>ê³µì¤‘ë³¼ ì„±ê³µë¥ :</strong> í—¤ë”© ê²½í•©ì—ì„œ ìŠ¹ë¦¬í•œ íšŸìˆ˜ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
        case 'block':
            content = `
                <h4>ğŸ›¡ï¸ ${playerName} ë¸”ë¡ ì„±ê³µë¥  ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ ë¸”ë¡ ì‹œë„:</strong> ${playerData.blockTry}íšŒ</p>
                    <p><strong>ë¸”ë¡ ì„±ê³µ:</strong> ${playerData.blocks}íšŒ</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${playerData.blocks} Ã· ${playerData.blockTry}) Ã— 100 = ${playerData.blockSuccessRate}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ${playerData.totalMatches}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>ë¸”ë¡ ì„±ê³µë¥ :</strong> ì‹œë„í•œ ë¸”ë¡ ì¤‘ ì„±ê³µí•œ ë¸”ë¡ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
        case 'tackle':
            content = `
                <h4>âš”ï¸ ${playerName} íƒœí´ ì„±ê³µë¥  ê³„ì‚° ê³¼ì •</h4>
                <div class="calculation-step">
                    <p><strong>ì´ íƒœí´ ì‹œë„:</strong> ${playerData.tackleTry}íšŒ</p>
                    <p><strong>íƒœí´ ì„±ê³µ:</strong> ${playerData.tackles}íšŒ</p>
                    <p><strong>ê³„ì‚°ì‹:</strong> (${playerData.tackles} Ã· ${playerData.tackleTry}) Ã— 100 = ${playerData.tackleSuccessRate}%</p>
                    <p><strong>ë¶„ì„ ê¸°ê°„:</strong> ${playerData.totalMatches}ê²½ê¸°</p>
                </div>
                <div class="calculation-note">
                    <p>ğŸ’¡ <strong>íƒœí´ ì„±ê³µë¥ :</strong> ì‹œë„í•œ íƒœí´ ì¤‘ ì„±ê³µí•œ íƒœí´ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤.</p>
                </div>
            `;
            break;
    }
    
    // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
    document.getElementById('calculationPopupContent').innerHTML = content;
    
    // íŒì—… í‘œì‹œ
    const popup = document.getElementById('calculationPopup');
    console.log('ì„ ìˆ˜ ì„±ê³µë¥  íŒì—… í‘œì‹œ ì‹œë„, popup ìš”ì†Œ:', popup);
    if (popup) {
        // ê°•ì œë¡œ ëª¨ë“  ìŠ¤íƒ€ì¼ ì„¤ì •
        popup.setAttribute('style', `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(0, 0, 0, 0.7) !important;
            z-index: 9999 !important;
            opacity: 1 !important;
            visibility: visible !important;
        `);
        console.log('ì„ ìˆ˜ ì„±ê³µë¥  íŒì—… í‘œì‹œ ì™„ë£Œ, display:', popup.style.display);
        console.log('ì„ ìˆ˜ ì„±ê³µë¥  íŒì—… ê³„ì‚°ëœ ìŠ¤íƒ€ì¼:', window.getComputedStyle(popup).display);
    } else {
        console.error('calculationPopup ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

// íŒì—… ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
function addPopupOverlayClickEvent() {
    const popupOverlay = document.getElementById('calculationPopup');
    if (popupOverlay) {
        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) {
                closeCalculationPopup();
            }
        });
    }
}

function updateGoalCardAnimations(closeRange, midRange, heading) {
    // ê° ì¹´ë“œì˜ ë°°ê²½ ë°” ì• ë‹ˆë©”ì´ì…˜
    const closeRangeCard = document.getElementById('closeRangeCard');
    const midRangeCard = document.getElementById('midRangeCard');
    const headingCard = document.getElementById('headingCard');
    
    // ë°°ê²½ ë°”ì˜ ë„ˆë¹„ë¥¼ í¼ì„¼íŠ¸ì— ë”°ë¼ ì¡°ì •
    setTimeout(() => {
        if (closeRangeCard) {
            const bgElement = closeRangeCard.querySelector('.goal-card-bg');
            if (bgElement) {
                bgElement.style.width = `${closeRange}%`;
                bgElement.style.height = closeRange > 0 ? '6px' : '4px';
            }
        }
        
        if (midRangeCard) {
            const bgElement = midRangeCard.querySelector('.goal-card-bg');
            if (bgElement) {
                bgElement.style.width = `${midRange}%`;
                bgElement.style.height = midRange > 0 ? '6px' : '4px';
            }
        }
        
        if (headingCard) {
            const bgElement = headingCard.querySelector('.goal-card-bg');
            if (bgElement) {
                bgElement.style.width = `${heading}%`;
                bgElement.style.height = heading > 0 ? '6px' : '4px';
            }
        }
    }, 100);
}

// ì£¼ìš” ì„ ìˆ˜ 3ëª… ê³„ì‚° ë° í‘œì‹œ
function displayTopPlayers(allMatches) {
    const topPlayers = calculateTopPlayers(allMatches);
    const topPlayersContainer = document.getElementById('topPlayersList');
    
    if (!topPlayers || topPlayers.length === 0) {
        topPlayersContainer.innerHTML = '<div class="no-players">ì£¼ìš” ì„ ìˆ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    topPlayersContainer.innerHTML = topPlayers.map((player, index) => `
        <div class="top-player-item">
            <div class="top-player-rank"></div>
            <img src="/live/externalAssets/common/playersAction/p${player.spid}.png" 
                 alt="${player.name}" 
                 class="top-player-image"
                 onload="console.log('ì„ ìˆ˜ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', '${player.name}', this.src)"
                 onerror="console.log('ì„ ìˆ˜ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${player.name}', this.src); this.onerror=null;">
            <div class="top-player-info">
                <div class="top-player-name-section">
                    ${player.season?.seasonImg ? `<img src="${player.season.seasonImg}" alt="ì‹œì¦Œ" class="top-player-season-img" onerror="this.style.display='none'"/>` : ''}
                    <div class="top-player-name">${player.name}</div>
                </div>
                <div class="top-player-stats">
                    <div class="top-player-stat">âš½ ${player.totalGoals}ê³¨ ğŸ…°ï¸ ${player.totalAssists}ë„ì›€ â­ ${player.avgRating}</div>
                </div>
            </div>
        </div>
    `).join('');
}

// ì£¼ìš” ì„ ìˆ˜ 3ëª… ê³„ì‚° í•¨ìˆ˜
function calculateTopPlayers(allMatches) {
    console.log('calculateTopPlayers í˜¸ì¶œë¨:', allMatches?.length, 'ê²½ê¸°');
    
    if (!allMatches || allMatches.length === 0) {
        console.log('ë§¤ì¹˜ ë°ì´í„°ê°€ ì—†ìŒ');
        return [];
    }
    
    // ëª¨ë“  ê²½ê¸°ì—ì„œ ì„ ìˆ˜ ë°ì´í„° ìˆ˜ì§‘
    const playerStats = {};
    console.log('ì„ ìˆ˜ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...');
    
    allMatches.forEach((match, matchIndex) => {
        console.log(`ê²½ê¸° ${matchIndex + 1} ì²˜ë¦¬ ì¤‘:`, match.matchId);
        console.log('ë§¤ì¹˜ êµ¬ì¡°:', Object.keys(match));
        console.log('ì „ì²´ ë§¤ì¹˜ ê°ì²´:', match);
        console.log('matchDetail ì¡´ì¬:', !!match.matchDetail);
        console.log('userPlayers ì¡´ì¬:', !!match.matchDetail?.userPlayers);
        console.log('userPlayers ê¸¸ì´:', match.matchDetail?.userPlayers?.length);
        
        // ë§¤ì¹˜ ë°ì´í„°ì—ì„œ ì„ ìˆ˜ ì •ë³´ ì°¾ê¸° (matchDetail.userPlayers ë˜ëŠ” ì§ì ‘ userPlayers)
        const userPlayers = match.matchDetail?.userPlayers || match.userPlayers;
        
        if (userPlayers && Array.isArray(userPlayers)) {
            console.log('ì„ ìˆ˜ ë°ì´í„° ìƒ˜í”Œ:', userPlayers[0]);
            userPlayers.forEach(player => {
                // spid ë˜ëŠ” spId ë‘˜ ë‹¤ í™•ì¸
                const spid = player.spid || player.spId;
                if (!spid) {
                    console.log('spid ì—†ëŠ” ì„ ìˆ˜:', player);
                    return;
                }
                
                if (!playerStats[spid]) {
                    playerStats[spid] = {
                        spid: spid,
                        name: player.spName || 'ì•Œ ìˆ˜ ì—†ìŒ',
                        season: player.season || null,
                        totalGoals: 0,
                        totalAssists: 0,
                        totalRating: 0,
                        matchCount: 0,
                        recentMatches: []
                    };
                }
                
                const goals = player.status?.goal || 0;
                const assists = player.status?.assist || 0;
                const rating = player.status?.spRating || 0;
                
                playerStats[spid].totalGoals += goals;
                playerStats[spid].totalAssists += assists;
                playerStats[spid].totalRating += rating;
                playerStats[spid].matchCount += 1;
                
                // ìµœê·¼ 5ê²½ê¸° ê¸°ë¡ ì €ì¥ (ìµœì‹ ìˆœ)
                playerStats[spid].recentMatches.unshift({
                    goals: goals,
                    assists: assists,
                    rating: rating,
                    matchDate: match.matchDate
                });
                
                // ìµœê·¼ 5ê²½ê¸°ë§Œ ìœ ì§€
                if (playerStats[spid].recentMatches.length > 5) {
                    playerStats[spid].recentMatches.pop();
                }
            });
        }
    });
    
    // ì„ ìˆ˜ë³„ ì¢…í•© ì ìˆ˜ ê³„ì‚°
    console.log('ìˆ˜ì§‘ëœ ì„ ìˆ˜ í†µê³„:', Object.keys(playerStats).length, 'ëª…');
    console.log('ì„ ìˆ˜ í†µê³„ ìƒ˜í”Œ:', Object.values(playerStats).slice(0, 3));
    
    const playersArray = Object.values(playerStats).map(player => {
        // ìµœì†Œ 1ê²½ê¸° ì´ìƒ ì¶œì „í•œ ì„ ìˆ˜ë§Œ í¬í•¨ (ì„ì‹œë¡œ ê¸°ì¤€ ì™„í™”)
        if (player.matchCount < 1) {
            console.log(`ì„ ìˆ˜ ${player.name}: ì¶œì „ ê²½ê¸° ìˆ˜ ë¶€ì¡± (${player.matchCount}ê²½ê¸°)`);
            return null;
        }
        
        const avgRating = player.matchCount > 0 ? (player.totalRating / player.matchCount) : 0;
        const goalsPerMatch = player.matchCount > 0 ? (player.totalGoals / player.matchCount) : 0;
        const assistsPerMatch = player.matchCount > 0 ? (player.totalAssists / player.matchCount) : 0;
        
        // ìµœê·¼ í¼ ê³„ì‚° (ìµœê·¼ 3ê²½ê¸° í‰ê· )
        const recentForm = calculateRecentForm(player.recentMatches);
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°
        // ê³¨ ìˆ˜ (40%) + ë„ì›€ ìˆ˜ (20%) + í‰ì  (25%) + ìµœê·¼ í¼ (15%)
        const comprehensiveScore = 
            (player.totalGoals * 0.4) + 
            (player.totalAssists * 0.2) + 
            (avgRating * 0.25) + 
            (recentForm * 0.15);
        
        return {
            ...player,
            avgRating: avgRating.toFixed(1),
            goalsPerMatch: goalsPerMatch.toFixed(1),
            assistsPerMatch: assistsPerMatch.toFixed(1),
            recentForm: recentForm.toFixed(1),
            comprehensiveScore: comprehensiveScore
        };
    }).filter(player => player !== null);
    
    // ì¢…í•© ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìƒìœ„ 3ëª… ë°˜í™˜
    const filteredPlayers = playersArray.filter(player => player !== null);
    console.log('í•„í„°ë§ í›„ ì„ ìˆ˜ ìˆ˜:', filteredPlayers.length);
    
    const topPlayers = filteredPlayers
        .sort((a, b) => b.comprehensiveScore - a.comprehensiveScore)
        .slice(0, 3);
    
    console.log('ìµœì¢… ì£¼ìš” ì„ ìˆ˜:', topPlayers);
    return topPlayers;
}

// ìµœê·¼ í¼ ê³„ì‚° (ìµœê·¼ 3ê²½ê¸° ê¸°ì¤€)
function calculateRecentForm(recentMatches) {
    if (!recentMatches || recentMatches.length === 0) {
        return 0;
    }
    
    const recent3Matches = recentMatches.slice(0, 3);
    const totalScore = recent3Matches.reduce((sum, match) => {
        // ê³¨ (2ì ) + ë„ì›€ (1ì ) + í‰ì  ë³´ë„ˆìŠ¤
        const matchScore = (match.goals * 2) + (match.assists * 1) + (match.rating > 7 ? 1 : 0);
        return sum + matchScore;
    }, 0);
    
    return recent3Matches.length > 0 ? totalScore / recent3Matches.length : 0;
}

// ì‹¤ì œ ê²½ê¸° ê¸°ë¡ í‘œì‹œ
function displayRealMatches(matches) {
    matchesList.innerHTML = '';
    
    if (!matches || matches.length === 0) {
        matchesList.innerHTML = '<div class="no-matches">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    console.log('ì›ë³¸ ê²½ê¸° ë°ì´í„°:', matches.length, 'ê°œ');
    
    // ëª¨ë“  ê²½ê¸° ë°ì´í„° í‘œì‹œ (ìœ íš¨ì„± ê²€ì‚¬ ì™„í™”)
    console.log('í‘œì‹œí•  ê²½ê¸° ë°ì´í„°:', matches.length, 'ê°œ');
    
    if (matches.length === 0) {
        matchesList.innerHTML = '<div class="no-matches">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    // APIì—ì„œ ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ì œê³µë˜ë¯€ë¡œ ë³„ë„ ì •ë ¬ ë¶ˆí•„ìš”
    console.log('APIì—ì„œ ì œê³µëœ ê²½ê¸° ë°ì´í„°:', matches.length, 'ê°œ');
    
    matches.forEach((match, index) => {
        const matchElement = document.createElement('div');
        matchElement.className = 'match-item';
        
        const result = match.matchResult || 0;
        const resultText = result === 1 ? 'ìŠ¹' : result === 2 ? 'íŒ¨' : 'ë¬´';
        const resultClass = result === 1 ? 'win' : result === 2 ? 'lose' : 'draw';
        
        const goals = match.userGoals || 0;
        const conceded = match.opponentGoals || 0;
        const score = `${goals} - ${conceded}`;
        
        // ìƒëŒ€ë°© ë‹‰ë„¤ì„ í‘œì‹œ
        const opponentName = match.opponentNickname || 'ìƒëŒ€ë°©';
        
        // ë‚ ì§œ í¬ë§·íŒ…
        const matchDate = match.matchDate ? formatMatchDate(match.matchDate) : '';
        
        matchElement.innerHTML = `
            <div class="match-header" onclick="toggleMatchDetails(this)">
                <div class="match-info">
                    <div class="match-details">
                        <span class="match-date">${matchDate}</span>
                        <span class="match-opponent">vs ${opponentName}</span>
                    </div>
                    <div class="match-score">
                        <span class="score">${score}</span>
                    </div>
                </div>
                <span class="match-result ${resultClass}">${resultText}</span>
                <div class="expand-icon">â–¼</div>
            </div>
            <div class="match-details-expanded" style="display: none;">
                <div class="match-loading">ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...</div>
            </div>
        `;
        
        // ë§¤ì¹˜ ë°ì´í„°ë¥¼ ìš”ì†Œì— ì €ì¥
        matchElement.setAttribute('data-match', JSON.stringify(match));
        
        matchesList.appendChild(matchElement);
    });
    
    // ê²½ê¸° ìˆ˜ ì—…ë°ì´íŠ¸
    updateMatchCount();
}

// ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
function formatMatchDate(dateString) {
    try {
        // ISO í˜•ì‹ì˜ ë‚ ì§œë¥¼ íŒŒì‹±
        const date = new Date(dateString);
        
        // ë‚ ì§œê°€ ìœ íš¨í•œì§€ í™•ì¸
        if (isNaN(date.getTime())) {
            console.log('ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹:', dateString);
            return dateString; // ì›ë³¸ ë°˜í™˜
        }
        
        // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜ (UTC+9)
        const koreanTime = new Date(date.getTime() + (9 * 60 * 60 * 1000));
        
        const month = String(koreanTime.getMonth() + 1).padStart(2, '0');
        const day = String(koreanTime.getDate()).padStart(2, '0');
        const hours = String(koreanTime.getHours()).padStart(2, '0');
        const minutes = String(koreanTime.getMinutes()).padStart(2, '0');
        
        return `${month}/${day} ${hours}:${minutes}`;
    } catch (error) {
        console.log('ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜:', error.message, 'ì›ë³¸:', dateString);
        return dateString;
    }
}

// ìƒ˜í”Œ ê²½ê¸° ê¸°ë¡ ë¡œë“œ
function loadSampleMatches() {
    const sampleMatches = [
        { opponent: 'ë ˆì•Œë§ˆë“œë¦¬ë“œ', score: '3-2', result: 'win' },
        { opponent: 'ë°”ë¥´ì…€ë¡œë‚˜', score: '1-1', result: 'draw' },
        { opponent: 'ë§¨ì²´ìŠ¤í„° ìœ ë‚˜ì´í‹°ë“œ', score: '2-1', result: 'win' },
        { opponent: 'ì²¼ì‹œ', score: '0-2', result: 'lose' },
        { opponent: 'ì•„ìŠ¤ë‚ ', score: '4-1', result: 'win' },
        { opponent: 'ë¦¬ë²„í’€', score: '2-3', result: 'lose' },
        { opponent: 'í† íŠ¸ë„˜', score: '1-0', result: 'win' },
        { opponent: 'ë§¨ì²´ìŠ¤í„° ì‹œí‹°', score: '2-2', result: 'draw' },
        { opponent: 'ì•„í‹€ë ˆí‹°ì½”', score: '3-0', result: 'win' },
        { opponent: 'ìœ ë²¤íˆ¬ìŠ¤', score: '1-1', result: 'draw' }
    ];
    
    matchesList.innerHTML = '';
    
    sampleMatches.forEach((match, index) => {
        const matchElement = document.createElement('div');
        matchElement.className = 'match-item';
        matchElement.innerHTML = `
            <div class="match-info">
                <span>vs ${match.opponent}</span>
                <span>${match.score}</span>
            </div>
            <span class="match-result ${match.result}">
                ${match.result === 'win' ? 'ìŠ¹' : match.result === 'lose' ? 'íŒ¨' : 'ë¬´'}
            </span>
        `;
        matchesList.appendChild(matchElement);
    });
}

// ë”ë³´ê¸° ë²„íŠ¼ ê¸°ëŠ¥
async function loadMoreMatches() {
    if (!currentUserInfo || !currentUserInfo.ouid) {
        console.log('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // í˜„ì¬ í‘œì‹œëœ ê²½ê¸° ìˆ˜ í™•ì¸
    const currentMatchCount = document.querySelectorAll('.match-item').length;
    console.log('í˜„ì¬ í‘œì‹œëœ ê²½ê¸° ìˆ˜:', currentMatchCount);
    
    // 100ê²½ê¸° ì œí•œ í™•ì¸
    if (currentMatchCount >= 100) {
        console.log('ìµœëŒ€ 100ê²½ê¸°ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
        loadMoreBtn.disabled = true;
        loadMoreBtn.innerHTML = 'ìµœëŒ€ 100ê²½ê¸°';
        return;
    }
    
    try {
        // ë”ë³´ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
        loadMoreBtn.disabled = true;
        loadMoreBtn.innerHTML = 'ë¡œë”© ì¤‘...';
        
        // ì¶”ê°€ ê²½ê¸° ê¸°ë¡ ì¡°íšŒ (10ê°œì”© ìš”ì²­)
        const url = `/api/more-matches/${currentUserInfo.ouid}/${currentMatchOffset}/10`;
        console.log('ë”ë³´ê¸° API í˜¸ì¶œ:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('ë”ë³´ê¸° ì‘ë‹µ ë°ì´í„°:', data);
        
        if (data.matches && data.matches.length > 0) {
            // ê¸°ì¡´ ê²½ê¸° ê¸°ë¡ì— ì¶”ê°€
            displayMoreMatches(data.matches);
            currentMatchOffset += 10; // ì˜¤í”„ì…‹ ì¦ê°€
            
            // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ì— ìƒˆë¡œìš´ ê²½ê¸° ì¶”ê°€
            if (currentUserInfo.matches) {
                currentUserInfo.matches = currentUserInfo.matches.concat(data.matches);
            } else {
                currentUserInfo.matches = data.matches;
            }
            
            // ì£¼ìš” ì„ ìˆ˜ ê°±ì‹  (ì „ì²´ ê²½ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°)
            displayTopPlayers(currentUserInfo.matches);
            
            // ì¶”ê°€ í›„ ê²½ê¸° ìˆ˜ í™•ì¸
            const newMatchCount = document.querySelectorAll('.match-item').length;
            console.log('ì¶”ê°€ í›„ ê²½ê¸° ìˆ˜:', newMatchCount);
            
            // ë”ë³´ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (í•­ìƒ í‘œì‹œ)
            if (data.matches.length < 10) {
                // 10ê°œ ë¯¸ë§Œì´ë©´ ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼
                loadMoreBtn.disabled = true;
                loadMoreBtn.innerHTML = 'ë” ì´ìƒ ì—†ìŒ';
            } else {
                // ì •ìƒì ìœ¼ë¡œ 10ê°œ ì¶”ê°€ëœ ê²½ìš° ë²„íŠ¼ ìœ ì§€
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = 'ë”ë³´ê¸°';
            }
        } else {
            // ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = 'ë” ì´ìƒ ì—†ìŒ';
        }
        
    } catch (error) {
        console.error('ë”ë³´ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ë”ë³´ê¸° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë§Œ ë²„íŠ¼ ìƒíƒœ ë³µì›
        loadMoreBtn.disabled = false;
        loadMoreBtn.innerHTML = 'ë”ë³´ê¸°';
    }
}

// ì¶”ê°€ ê²½ê¸° ê¸°ë¡ í‘œì‹œ
function displayMoreMatches(moreMatches) {
    console.log('ì¶”ê°€ ê²½ê¸° ë°ì´í„°:', moreMatches.length, 'ê°œ');
    
    if (moreMatches.length === 0) {
        return;
    }
    
    // APIì—ì„œ ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ì œê³µë˜ë¯€ë¡œ ë³„ë„ ì •ë ¬ ë¶ˆí•„ìš”
    console.log('APIì—ì„œ ì œê³µëœ ì¶”ê°€ ê²½ê¸° ë°ì´í„°:', moreMatches.length, 'ê°œ');
    
    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ì— ìƒˆë¡œìš´ ê²½ê¸°ë“¤ì„ ì¶”ê°€ (ìµœì‹  ê²½ê¸°ê°€ ì•ì— ì˜¤ë„ë¡)
    if (currentUserInfo && currentUserInfo.matches) {
        currentUserInfo.matches = [...moreMatches, ...currentUserInfo.matches];
        console.log('ì „ì²´ ê²½ê¸° ìˆ˜ ì—…ë°ì´íŠ¸:', currentUserInfo.matches.length, 'ê°œ');
        
        // í†µê³„ ì¬ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        updateMatchStatistics();
    }
    
    moreMatches.forEach((match, index) => {
        const matchElement = document.createElement('div');
        matchElement.className = 'match-item';
        
        const result = match.matchResult || 0;
        const resultText = result === 1 ? 'ìŠ¹' : result === 2 ? 'íŒ¨' : 'ë¬´';
        const resultClass = result === 1 ? 'win' : result === 2 ? 'lose' : 'draw';
        
        const goals = match.userGoals || 0;
        const conceded = match.opponentGoals || 0;
        const score = `${goals} - ${conceded}`;
        
        // ìƒëŒ€ë°© ë‹‰ë„¤ì„ í‘œì‹œ
        const opponentName = match.opponentNickname || 'ìƒëŒ€ë°©';
        
        // ë‚ ì§œ í¬ë§·íŒ…
        const matchDate = match.matchDate ? formatMatchDate(match.matchDate) : '';
        
        matchElement.innerHTML = `
            <div class="match-header" onclick="toggleMatchDetails(this)">
                <div class="match-info">
                    <div class="match-details">
                        <span class="match-date">${matchDate}</span>
                        <span class="match-opponent">vs ${opponentName}</span>
                    </div>
                    <div class="match-score">
                        <span class="score">${score}</span>
                    </div>
                </div>
                <span class="match-result ${resultClass}">${resultText}</span>
                <div class="expand-icon">â–¼</div>
            </div>
            <div class="match-details-expanded" style="display: none;">
                <div class="match-loading">ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...</div>
            </div>
        `;
        
        // ë§¤ì¹˜ ë°ì´í„°ë¥¼ ìš”ì†Œì— ì €ì¥
        matchElement.setAttribute('data-match', JSON.stringify(match));
        
        matchesList.appendChild(matchElement);
    });
    
    // ì¶”ê°€ëœ ê²½ê¸°ë“¤ì„ ì „ì²´ì ìœ¼ë¡œ ì‹œê°„ìˆœìœ¼ë¡œ ì¬ì •ë ¬
    const allMatches = Array.from(matchesList.children);
    allMatches.sort((a, b) => {
        const dateA = new Date(a.querySelector('.match-date').textContent);
        const dateB = new Date(b.querySelector('.match-date').textContent);
        return dateB - dateA; // ìµœì‹ ìˆœ
    });
    
    // ì¬ì •ë ¬ëœ ìˆœì„œë¡œ DOMì— ë‹¤ì‹œ ì¶”ê°€
    allMatches.forEach(match => {
        matchesList.appendChild(match);
    });
    
    // ê²½ê¸° ìˆ˜ ì—…ë°ì´íŠ¸
    updateMatchCount();
}

// ì •ë³´ ì•„ì´í…œ ì¶”ê°€
function addInfoItem(label, value) {
    const infoItem = document.createElement('div');
    infoItem.className = 'info-item';
    infoItem.innerHTML = `
        <h3>${label}</h3>
        <p>${value}</p>
    `;
    infoGrid.appendChild(infoItem);
}

// ë¡œë”© ìƒíƒœ í‘œì‹œ/ìˆ¨ê¹€
function showLoading(show) {
    loading.style.display = show ? 'flex' : 'none';
    searchBtn.disabled = show;
    nicknameInput.disabled = show;
}

// ê²°ê³¼ í‘œì‹œ/ìˆ¨ê¹€
function hideResults() {
    playerBasicInfo.style.display = 'none';
    tabContainer.style.display = 'none';
}

// ì—ëŸ¬ í‘œì‹œ/ìˆ¨ê¹€
function showError(message) {
    errorMessage.textContent = message;
    errorSection.style.display = 'block';
    playerBasicInfo.style.display = 'none';
    tabContainer.style.display = 'none';
}

function hideError() {
    errorSection.style.display = 'none';
}

// ê²½ê¸° ìƒì„¸ ì •ë³´ í† ê¸€ í•¨ìˆ˜
function toggleMatchDetails(headerElement) {
    const matchItem = headerElement.closest('.match-item');
    const expandedSection = matchItem.querySelector('.match-details-expanded');
    const expandIcon = headerElement.querySelector('.expand-icon');
    
    if (expandedSection.style.display === 'none' || expandedSection.style.display === '') {
        // í™•ì¥
        expandedSection.style.display = 'block';
        expandIcon.textContent = 'â–²';
        expandIcon.style.transform = 'rotate(180deg)';
        
        // ìƒì„¸ ì •ë³´ ë¡œë“œ
        loadMatchDetails(matchItem);
    } else {
        // ì¶•ì†Œ
        expandedSection.style.display = 'none';
        expandIcon.textContent = 'â–¼';
        expandIcon.style.transform = 'rotate(0deg)';
    }
}

// ê²½ê¸° ìƒì„¸ ì •ë³´ ë¡œë“œ
function loadMatchDetails(matchItem) {
    const matchData = JSON.parse(matchItem.getAttribute('data-match'));
    const expandedSection = matchItem.querySelector('.match-details-expanded');
    
    console.log('ë§¤ì¹˜ ë°ì´í„°:', matchData);
    console.log('ì‚¬ìš©ì ì„ ìˆ˜ ë°ì´í„°:', matchData.userPlayers);
    console.log('ìƒëŒ€ë°© ì„ ìˆ˜ ë°ì´í„°:', matchData.opponentPlayers);
    
    // ì„ ìˆ˜ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
    if (matchData.userPlayers && matchData.userPlayers.length > 0) {
        expandedSection.innerHTML = createMatchDetailsHTML(matchData);
    } else {
        // ë””ë²„ê¹… ì •ë³´ í¬í•¨
        const debugInfo = `
            <div class="match-details-content">
                <div class="no-player-data">
                    <p>ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p>APIì—ì„œ ì œê³µë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë°ì´í„° êµ¬ì¡°ê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <details style="margin-top: 16px;">
                        <summary>ë””ë²„ê¹… ì •ë³´ (í´ë¦­í•˜ì—¬ í™•ì¸)</summary>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 8px; font-size: 12px; overflow-x: auto;">
ë§¤ì¹˜ ID: ${matchData.matchId}
ì‚¬ìš©ì ì„ ìˆ˜ ë°ì´í„°: ${JSON.stringify(matchData.userPlayers, null, 2)}
ìƒëŒ€ë°© ì„ ìˆ˜ ë°ì´í„°: ${JSON.stringify(matchData.opponentPlayers, null, 2)}
ì „ì²´ ë§¤ì¹˜ ë°ì´í„°: ${JSON.stringify(matchData, null, 2)}
                        </pre>
                    </details>
                </div>
            </div>
        `;
        expandedSection.innerHTML = debugInfo;
    }
}

// ê²½ê¸° ìƒì„¸ ì •ë³´ HTML ìƒì„± (ë¦¬ë‰´ì–¼ëœ êµ¬ì¡°)
function createMatchDetailsHTML(matchData) {
    const userPlayers = matchData.userPlayers || [];
    const opponentPlayers = matchData.opponentPlayers || [];
    const userStats = matchData.userStats || {};
    const opponentStats = matchData.opponentStats || {};
    
    // ìŠ›ì„ ì‹œë„í•œ ìœ í˜• ë¶„ì„ ì¶”ê°€
    const shootTypes = calculateShootTypes([matchData]);
    userStats.shootTypes = shootTypes;
    
    console.log('Match data:', matchData);
    console.log('User players:', userPlayers);
    console.log('Opponent players:', opponentPlayers);
    
    // ê²½ê¸° ê¸°ë³¸ ì •ë³´
    const matchDate = matchData.matchDate ? formatMatchDate(matchData.matchDate) : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
    const opponentName = matchData.opponentNickname || 'ìƒëŒ€ë°©';
    const userGoals = matchData.userGoals || 0;
    const opponentGoals = matchData.opponentGoals || 0;
    const matchResult = matchData.matchResult || 0;
    const resultText = matchResult === 1 ? 'ìŠ¹' : matchResult === 2 ? 'íŒ¨' : 'ë¬´';
    const resultClass = matchResult === 1 ? 'win' : matchResult === 2 ? 'lose' : 'draw';
    
    // ì‚¬ìš©ì ì •ë³´ì—ì„œ ë‹‰ë„¤ì„ê³¼ ìµœê³  ë“±ê¸‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const userNickname = currentUserInfo?.nickname || 'ë‚˜';
    const userMaxGrade = currentUserInfo?.maxDivisionInfo || null;
    const opponentMaxGrade = matchData.opponentDivision ? getDivisionInfo(matchData.opponentDivision) : null;
    
    // ì„±ì·¨ê° ë©˜íŠ¸ ìƒì„± (ìƒëŒ€ë°© ë°ì´í„°ì™€ ë¹„êµ ë¶„ì„)
    const achievementMessage = generateAchievementMessage(matchResult, userGoals, opponentGoals, userStats, opponentStats);
    
    // ì‹¤ë ¥ í–¥ìƒì„ ìœ„í•œ ë³´ì™„ì  ì œì•ˆ
    const improvementSuggestion = generateImprovementSuggestion(matchResult, userGoals, opponentGoals, userStats, opponentStats, currentUserInfo?.matches || []);
    
    // ë² ìŠ¤íŠ¸ í”Œë ˆì´ì–´ ì •ë³´
    const bestPlayers = getBestPlayers(userPlayers);
    
    // ì „ìˆ  ì •ë³´ (ì‹¤ì œ ì„ ìˆ˜ ë°ì´í„° ê¸°ë°˜)
    const userTactics = generateTacticsInfo(userPlayers, userStats, opponentStats);
    const opponentTactics = generateTacticsInfo(opponentPlayers, opponentStats, userStats);
    
    return `
        <div class="match-details-content">
            <!-- 1. ê²½ê¸° í•œëˆˆì— ë³´ê¸° -->
            <div class="match-overview">
                <div class="match-header-info">
                    <div class="match-date-time">${matchDate}</div>
                    <div class="match-opponents-single-line">
                        <div class="team-badge user-team">
                            <div class="team-name">${userNickname}</div>
                        </div>
                        <div class="score-display">
                            <div class="score-box ${resultClass}">
                                <div class="score-numbers">${userGoals} : ${opponentGoals}</div>
                            </div>
                        </div>
                        <div class="team-badge opponent-team">
                            <div class="team-name">${opponentName}</div>
                        </div>
                    </div>
                </div>
                <div class="achievement-message">${achievementMessage}</div>
                <div class="improvement-suggestion">${improvementSuggestion}</div>

            </div>
            
            <!-- 2. íŒ€ë³„ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ¯ -->
            <div class="team-highlight-stats">
                <h4>íŒ€ë³„ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ¯</h4>
                <div class="stats-comparison">
                    <div class="stat-item">
                        <div class="stat-label">ì ìœ ìœ¨</div>
                        <div class="stat-comparison">
                            <span class="user-value">${userStats.possession || 0}%</span>
                            <span class="vs">vs</span>
                            <span class="opponent-value">${opponentStats.possession || 0}%</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ìŠˆíŒ… / ìœ íš¨ ìŠˆíŒ…</div>
                        <div class="stat-comparison">
                            <span class="user-value">${userStats.shoot?.shootTotal || 0} / ${userStats.shoot?.effectiveShootTotal || 0}</span>
                            <span class="vs">vs</span>
                            <span class="opponent-value">${opponentStats.shoot?.shootTotal || 0} / ${opponentStats.shoot?.effectiveShootTotal || 0}</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ìŠ›ì„ ì‹œë„í•œ ìœ í˜•</div>
                        <div class="goal-types">
                            <span class="goal-type">ì¤‘ê±°ë¦¬ ${userStats.shootTypes?.midRange || 0}%</span>
                            <span class="goal-type">ê·¼ê±°ë¦¬ ${userStats.shootTypes?.closeRange || 0}%</span>
                            <span class="goal-type">í—¤ë”© ${userStats.shootTypes?.heading || 0}%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 3. ê²½ê¸° ì •ë³´ ì •ë³´ ì¹´ë“œ -->
            <div class="tactics-info">
                <div class="section-header">
                    <h4>ê²½ê¸° ì •ë³´</h4>
                    <button class="info-button" onclick="showMetricsPopup()">?</button>
                </div>
                <div class="tactics-cards-container">
                    <!-- ë‚˜ì˜ ì „ìˆ  ì¹´ë“œ -->
                    <div class="tactics-card my-tactics-card">
                        <div class="card-header">
                            <h5>ë‚˜ì˜ ì „ìˆ </h5>
                            <div class="formation-badge">${userTactics.formation}</div>
                        </div>
                        <div class="card-content">
                            <div class="style-section">
                                <span class="label">ê²½ê¸° ì„±í–¥</span>
                                <span class="style-value">${userTactics.style}</span>
                            </div>
                            ${userTactics.characteristics ? `
                                <div class="performance-metrics">
                                    <div class="metric-row">
                                        <span class="metric-label">ê³µê²©ë ¥</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: ${userTactics.characteristics.scores.attack.score}%"></div>
                                        </div>
                                        <span class="metric-score">${userTactics.characteristics.scores.attack.score}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">ë¹Œë“œì—…</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: ${userTactics.characteristics.scores.buildup.score}%"></div>
                                        </div>
                                        <span class="metric-score">${userTactics.characteristics.scores.buildup.score}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">ì ìœ ìœ¨ í™œìš©</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: ${userTactics.characteristics.scores.possession.score}%"></div>
                                        </div>
                                        <span class="metric-score">${userTactics.characteristics.scores.possession.score}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">ìˆ˜ë¹„ ê°•ë„</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: ${userTactics.characteristics.scores.defense.score}%"></div>
                                        </div>
                                        <span class="metric-score">${userTactics.characteristics.scores.defense.score}</span>
                                    </div>
                                </div>
                                <div class="characteristics-section">
                                    <span class="label">ì´ ê²½ê¸° íŠ¹ì§•</span>
                                    <p class="match-description">${generatePerformanceBasedDescription(userTactics.characteristics.scores)}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- VS êµ¬ë¶„ì„  -->
                    <div class="tactics-vs">
                        <span>VS</span>
                    </div>
                    
                    <!-- ìƒëŒ€ë°© ì „ìˆ  ì¹´ë“œ -->
                    <div class="tactics-card opponent-tactics-card">
                        <div class="card-header">
                            <h5>ìƒëŒ€ë°© ì „ìˆ </h5>
                            <div class="formation-badge">${opponentTactics.formation}</div>
                        </div>
                        <div class="card-content">
                            <div class="style-section">
                                <span class="label">ê²½ê¸° ì„±í–¥</span>
                                <span class="style-value">${opponentTactics.style}</span>
                            </div>
                            ${opponentTactics.characteristics ? `
                                <div class="performance-metrics">
                                    <div class="metric-row">
                                        <span class="metric-label">ê³µê²©ë ¥</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill opponent-fill" style="width: ${opponentTactics.characteristics.scores.attack.score}%"></div>
                                        </div>
                                        <span class="metric-score">${opponentTactics.characteristics.scores.attack.score}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">ë¹Œë“œì—…</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill opponent-fill" style="width: ${opponentTactics.characteristics.scores.buildup.score}%"></div>
                                        </div>
                                        <span class="metric-score">${opponentTactics.characteristics.scores.buildup.score}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">ì ìœ ìœ¨ í™œìš©</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill opponent-fill" style="width: ${opponentTactics.characteristics.scores.possession.score}%"></div>
                                        </div>
                                        <span class="metric-score">${opponentTactics.characteristics.scores.possession.score}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">ìˆ˜ë¹„ ê°•ë„</span>
                                        <div class="metric-bar">
                                            <div class="metric-fill opponent-fill" style="width: ${opponentTactics.characteristics.scores.defense.score}%"></div>
                                        </div>
                                        <span class="metric-score">${opponentTactics.characteristics.scores.defense.score}</span>
                                    </div>
                                </div>
                                <div class="characteristics-section">
                                    <span class="label">ì´ ê²½ê¸° íŠ¹ì§•</span>
                                    <p class="match-description">${generatePerformanceBasedDescription(opponentTactics.characteristics.scores)}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4. ë² ìŠ¤íŠ¸ í”Œë ˆì´ì–´ -->
            <div class="best-players">
                <h4>ë² ìŠ¤íŠ¸ í”Œë ˆì´ì–´</h4>
                <div class="best-players-grid">
                    <div class="best-player-item">
                        <div class="player-title">ë“ì ì™•</div>
                        <div class="player-info-inline">
                            ${bestPlayers.topScorer.season?.seasonImg ? `<img src="${bestPlayers.topScorer.season.seasonImg}" alt="ì‹œì¦Œ" class="season-img-small" onerror="this.style.display='none'"/>` : ''}
                            ${renderGradeImage(bestPlayers.topScorer.grade, bestPlayers.topScorer.spid)}
                            <span class="player-name">${bestPlayers.topScorer.name}</span>
                            <span class="player-value">${bestPlayers.topScorer.goals}ê³¨</span>
                        </div>
                    </div>
                    <div class="best-player-item">
                        <div class="player-title">ë„ì›€ì™•</div>
                        <div class="player-info-inline">
                            ${bestPlayers.topAssister.season?.seasonImg ? `<img src="${bestPlayers.topAssister.season.seasonImg}" alt="ì‹œì¦Œ" class="season-img-small" onerror="this.style.display='none'"/>` : ''}
                            ${renderGradeImage(bestPlayers.topAssister.grade, bestPlayers.topAssister.spid)}
                            <span class="player-name">${bestPlayers.topAssister.name}</span>
                            <span class="player-value">${bestPlayers.topAssister.assists}ë„ì›€</span>
                        </div>
                    </div>
                    <div class="best-player-item">
                        <div class="player-title">í‰ì ì™•</div>
                        <div class="player-info-inline">
                            ${bestPlayers.topRated.season?.seasonImg ? `<img src="${bestPlayers.topRated.season.seasonImg}" alt="ì‹œì¦Œ" class="season-img-small" onerror="this.style.display='none'"/>` : ''}
                            ${renderGradeImage(bestPlayers.topRated.grade, bestPlayers.topRated.spid)}
                            <span class="player-name">${bestPlayers.topRated.name}</span>
                            <span class="player-value">${bestPlayers.topRated.rating}ì </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 5. ì„ ìˆ˜ ëª©ë¡ -->
            <div class="players-section">
                <h4>ì„ ìˆ˜ ëª©ë¡</h4>
                <div class="teams-players">
                    ${userPlayers && userPlayers.length > 0 ? renderPlayerList(userPlayers, 'ë‚˜ì˜ í´ëŸ½') : `
                        <div class="team-players">
                            <h5>ë‚˜ì˜ í´ëŸ½</h5>
                            <div class="no-players">ì„ ìˆ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    `}
                    ${opponentPlayers && opponentPlayers.length > 0 ? renderPlayerList(opponentPlayers, 'ìƒëŒ€ë°© í´ëŸ½') : `
                        <div class="team-players">
                            <h5>ìƒëŒ€ë°© í´ëŸ½</h5>
                            <div class="no-players">ì„ ìˆ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;
}

// ì„±ì·¨ê° ë©˜íŠ¸ ìƒì„± (ìŠ¹ë¦¬ ìš”ì¸/í”¼ë“œë°± í¬í•¨)
function generateAchievementMessage(matchResult, userGoals, opponentGoals, userStats = {}, opponentStats = {}) {
    const goalDiff = userGoals - opponentGoals;
    
    if (matchResult === 1) { // ìŠ¹ë¦¬ - ìŠ¹ë¦¬ ìš”ì¸ê³¼ ê°•ì  ë¶„ì„
        return analyzeWinFactors(userGoals, opponentGoals, userStats, opponentStats);
    } else if (matchResult === 2) { // íŒ¨ë°° - ë¶€ì¡±í•œ ì ê³¼ ìƒëŒ€ë°© ë¹„êµ í”¼ë“œë°±
        return analyzeLossFactors(userGoals, opponentGoals, userStats, opponentStats);
    } else { // ë¬´ìŠ¹ë¶€ - ê°œì„ ì ê³¼ ìƒëŒ€ë°© ë¹„êµ í”¼ë“œë°±
        return analyzeDrawFactors(userGoals, opponentGoals, userStats, opponentStats);
    }
}

// ìŠ¹ë¦¬ ìš”ì¸ ë¶„ì„
function analyzeWinFactors(userGoals, opponentGoals, userStats, opponentStats) {
    const goalDiff = userGoals - opponentGoals;
    const userPossession = userStats.possession || 0;
    const opponentPossession = opponentStats.possession || 0;
    const userShots = userStats.shoot?.shootTotal || 0;
    const opponentShots = opponentStats.shoot?.shootTotal || 0;
    const userEffectiveShots = userStats.shoot?.effectiveShootTotal || 0;
    const opponentEffectiveShots = opponentStats.shoot?.effectiveShootTotal || 0;
    
    // ì ìœ ìœ¨ ìš°ìœ„
    if (userPossession > opponentPossession + 10) {
        return "ğŸ¯ ì ìœ ìœ¨ ì¥ì•…ìœ¼ë¡œ ê²½ê¸°ë¥¼ ì£¼ë„í–ˆë‹¤!";
    }
    
    // ìŠˆíŒ… íš¨ìœ¨ì„±
    if (userEffectiveShots > opponentEffectiveShots && userShots <= opponentShots) {
        return "âš¡ ì •í™•í•œ ìŠˆíŒ…ìœ¼ë¡œ íš¨ìœ¨ì ì¸ ê³µê²©ì„ í–ˆë‹¤!";
    }
    
    // ëŒ€ìŠ¹
    if (goalDiff >= 3) {
        return "ğŸ† ì™„ì „í•œ ì••ìŠ¹! ê³µìˆ˜ ëª¨ë‘ ì™„ë²½í–ˆë‹¤!";
    }
    
    // ì•ˆì •ì  ìŠ¹ë¦¬
    if (goalDiff === 2) {
        return "ğŸ’ª ì•ˆì •ì ì¸ ê²½ê¸° ìš´ì˜ìœ¼ë¡œ ìŠ¹ë¦¬ë¥¼ ê±°ë‘ì—ˆë‹¤!";
    }
    
    // ê·¼ì†Œí•œ ìŠ¹ë¦¬
    if (goalDiff === 1) {
        return "ğŸ¯ ì¹˜ì—´í•œ ê²½ê¸° ëì— ê²°ì •ë ¥ì„ ë°œíœ˜í–ˆë‹¤!";
    }
    
    return "ğŸ‰ ìŠ¹ë¦¬! ì˜¤ëŠ˜ì€ ë‚´ê°€ ìµœê³ ì˜€ë‹¤!";
}

// íŒ¨ë°° ìš”ì¸ ë¶„ì„
function analyzeLossFactors(userGoals, opponentGoals, userStats, opponentStats) {
    const goalDiff = userGoals - opponentGoals;
    const userPossession = userStats.possession || 0;
    const opponentPossession = opponentStats.possession || 0;
    const userShots = userStats.shoot?.shootTotal || 0;
    const opponentShots = opponentStats.shoot?.shootTotal || 0;
    const userEffectiveShots = userStats.shoot?.effectiveShootTotal || 0;
    const opponentEffectiveShots = opponentStats.shoot?.effectiveShootTotal || 0;
    
    // ì ìœ ìœ¨ ì—´ì„¸
    if (userPossession < opponentPossession - 10) {
        return "ğŸ˜” ì ìœ ìœ¨ì—ì„œ ë°€ë ¤ ê²½ê¸°ë¥¼ ë‚´ì£¼ì—ˆë‹¤";
    }
    
    // ìŠˆíŒ… ê¸°íšŒ ë¶€ì¡±
    if (userShots < opponentShots - 3) {
        return "ğŸ¤” ê³µê²© ê¸°íšŒê°€ ë¶€ì¡±í–ˆë‹¤";
    }
    
    // ìŠˆíŒ… ì •í™•ë„ ë¶€ì¡±
    if (userShots >= opponentShots && userEffectiveShots < opponentEffectiveShots) {
        return "ğŸ˜¤ ìŠˆíŒ… ì •í™•ë„ê°€ ì•„ì‰¬ì› ë‹¤";
    }
    
    // ëŒ€íŒ¨
    if (goalDiff <= -3) {
        return "ğŸ˜” í° ì ìˆ˜ì°¨ íŒ¨ë°°... ìˆ˜ë¹„ê°€ ë¬´ë„ˆì¡Œë‹¤";
    }
    
    // ê·¼ì†Œí•œ íŒ¨ë°°
    if (goalDiff === -1) {
        return "ğŸ˜… ì•„ì‰¬ìš´ 1ì ì°¨ íŒ¨ë°°, ê²°ì •ë ¥ì´ ë¶€ì¡±í–ˆë‹¤";
    }
    
    return "ğŸ’ª íŒ¨ë°°í–ˆì§€ë§Œ ì‹¤ë ¥ì€ ì¸ì •ë°›ì•˜ë‹¤!";
}

// ë¬´ìŠ¹ë¶€ ìš”ì¸ ë¶„ì„
function analyzeDrawFactors(userGoals, opponentGoals, userStats, opponentStats) {
    const userPossession = userStats.possession || 0;
    const opponentPossession = opponentStats.possession || 0;
    const userShots = userStats.shoot?.shootTotal || 0;
    const opponentShots = opponentStats.shoot?.shootTotal || 0;
    
    // ë¬´ë“ì  ë¬´ìŠ¹ë¶€
    if (userGoals === 0 && opponentGoals === 0) {
        return "ğŸ›¡ï¸ ìˆ˜ë¹„ì „, ê³µê²©ë ¥ì´ ë¶€ì¡±í–ˆë‹¤";
    }
    
    // ê³ ë“ì  ë¬´ìŠ¹ë¶€
    if (userGoals >= 3 && opponentGoals >= 3) {
        return "âš½ í™”ëˆí•œ ê²½ê¸°! ìˆ˜ë¹„ ì•ˆì •ì„±ì´ ë¶€ì¡±í–ˆë‹¤";
    }
    
    // ì ìœ ìœ¨ ìš°ìœ„ì—ë„ ë¬´ìŠ¹ë¶€
    if (userPossession > opponentPossession + 5) {
        return "ğŸ¤” ì ìœ ìœ¨ì€ ìš°ì„¸í–ˆì§€ë§Œ ê²°ì •ë ¥ì´ ë¶€ì¡±í–ˆë‹¤";
    }
    
    // ìŠˆíŒ… ê¸°íšŒëŠ” ë§ì•˜ì§€ë§Œ ë¬´ìŠ¹ë¶€
    if (userShots > opponentShots + 2) {
        return "ğŸ˜¤ ìŠˆíŒ… ê¸°íšŒëŠ” ë§ì•˜ì§€ë§Œ ì •í™•ë„ê°€ ì•„ì‰¬ì› ë‹¤";
    }
    
    return "ğŸ¤ ì‹¤ë ¥ì´ íŒ½íŒ½í•œ ë¬´ìŠ¹ë¶€ì˜€ë‹¤";
}

// ì‹¤ë ¥ í–¥ìƒì„ ìœ„í•œ ë³´ì™„ì  ì œì•ˆ ìƒì„±
function generateImprovementSuggestion(matchResult, userGoals, opponentGoals, userStats, opponentStats, recentMatches) {
    const suggestions = [];
    
    // 1. ê²½ê¸° ê²°ê³¼ë³„ ê¸°ë³¸ í”¼ë“œë°±
    const basicFeedback = getBasicImprovementFeedback(matchResult, userGoals, opponentGoals);
    if (basicFeedback) suggestions.push(basicFeedback);
    
    // 2. ìƒëŒ€ë°©ê³¼ì˜ ë°ì´í„° ë¹„êµ ë¶„ì„
    const comparisonFeedback = getComparisonFeedback(userStats, opponentStats);
    if (comparisonFeedback) suggestions.push(comparisonFeedback);
    
    // 3. ìµœê·¼ ê²½ê¸° íŒ¨í„´ ë¶„ì„
    const patternFeedback = getPatternFeedback(recentMatches);
    if (patternFeedback) suggestions.push(patternFeedback);
    
    // 4. êµ¬ì²´ì ì¸ ê°œì„  ë°©í–¥ ì œì‹œ
    const specificFeedback = getSpecificFeedback(userStats, opponentStats, recentMatches);
    if (specificFeedback) suggestions.push(specificFeedback);
    
    // ê°€ì¥ ì¤‘ìš”í•œ í”¼ë“œë°± 1-2ê°œ ì„ íƒ
    const prioritySuggestions = suggestions.slice(0, 2);
    
    if (prioritySuggestions.length === 0) {
        return "ğŸ’¡ ê¾¸ì¤€í•œ ì—°ìŠµìœ¼ë¡œ ì‹¤ë ¥ì„ í–¥ìƒì‹œì¼œë³´ì„¸ìš”!";
    }
    
    return prioritySuggestions.join(' ');
}

// ê¸°ë³¸ ê°œì„  í”¼ë“œë°±
function getBasicImprovementFeedback(matchResult, userGoals, opponentGoals) {
    const goalDiff = userGoals - opponentGoals;
    
    if (matchResult === 1) { // ìŠ¹ë¦¬
        if (goalDiff >= 3) {
            return "ğŸ† ì™„ë²½í•œ ê²½ê¸°! ì´ í”Œë ˆì´ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì„¸ìš”";
        } else if (goalDiff === 1) {
            return "ğŸ’ª ìŠ¹ë¦¬í–ˆì§€ë§Œ ë” ì•ˆì •ì ì¸ ê²½ê¸° ìš´ì˜ì´ í•„ìš”í•´ìš”";
        }
    } else if (matchResult === 2) { // íŒ¨ë°°
        if (goalDiff <= -3) {
            return "ğŸ˜¤ í° ì ìˆ˜ì°¨ íŒ¨ë°°... ìˆ˜ë¹„ ì§‘ì¤‘ë„ì™€ ê³µê²© íš¨ìœ¨ì„±ì„ ë†’ì—¬ë³´ì„¸ìš”";
        } else if (goalDiff === -1) {
            return "ğŸ˜… ì•„ì‰¬ìš´ 1ì ì°¨ íŒ¨ë°°, ê²°ì •ë ¥ í–¥ìƒì´ í•„ìš”í•´ìš”";
        }
    } else { // ë¬´ìŠ¹ë¶€
        if (userGoals === 0) {
            return "ğŸ›¡ï¸ ë¬´ë“ì  ë¬´ìŠ¹ë¶€, ê³µê²© ë‹¤ì–‘ì„±ì„ ëŠ˜ë ¤ë³´ì„¸ìš”";
        } else if (userGoals >= 3) {
            return "âš½ ê³ ë“ì  ë¬´ìŠ¹ë¶€, ìˆ˜ë¹„ ì•ˆì •ì„±ì„ ë†’ì—¬ë³´ì„¸ìš”";
        }
    }
    
    return null;
}

// ìƒëŒ€ë°©ê³¼ì˜ ë¹„êµ í”¼ë“œë°±
function getComparisonFeedback(userStats, opponentStats) {
    const userPossession = userStats.possession || 0;
    const opponentPossession = opponentStats.possession || 0;
    const userShots = userStats.shoot?.shootTotal || 0;
    const opponentShots = opponentStats.shoot?.shootTotal || 0;
    const userEffectiveShots = userStats.shoot?.effectiveShootTotal || 0;
    const opponentEffectiveShots = opponentStats.shoot?.effectiveShootTotal || 0;
    
    // ì ìœ ìœ¨ ë¹„êµ
    if (userPossession < opponentPossession - 15) {
        return "ğŸ“Š ì ìœ ìœ¨ì—ì„œ í¬ê²Œ ë°€ë ¸ì–´ìš”. ë¹Œë“œì—… ì—°ìŠµì´ í•„ìš”í•´ìš”";
    }
    
    // ìŠˆíŒ… ê¸°íšŒ ë¹„êµ
    if (userShots < opponentShots - 5) {
        return "âš½ ê³µê²© ê¸°íšŒê°€ ë¶€ì¡±í–ˆì–´ìš”. ê³µê²© ì „ê°œë¥¼ ë” ì ê·¹ì ìœ¼ë¡œ í•´ë³´ì„¸ìš”";
    }
    
    // ìŠˆíŒ… ì •í™•ë„ ë¹„êµ
    if (userShots > 0 && opponentShots > 0) {
        const userAccuracy = (userEffectiveShots / userShots) * 100;
        const opponentAccuracy = (opponentEffectiveShots / opponentShots) * 100;
        
        if (userAccuracy < opponentAccuracy - 20) {
            return "ğŸ¯ ìŠˆíŒ… ì •í™•ë„ê°€ ì•„ì‰¬ì›Œìš”. ë§ˆë¬´ë¦¬ ì—°ìŠµì„ ë” í•´ë³´ì„¸ìš”";
        }
    }
    
    return null;
}

// ìµœê·¼ ê²½ê¸° íŒ¨í„´ ë¶„ì„
function getPatternFeedback(recentMatches) {
    if (!recentMatches || recentMatches.length < 3) return null;
    
    const recent3Matches = recentMatches.slice(0, 3);
    let totalGoals = 0;
    let totalConceded = 0;
    let wins = 0;
    
    recent3Matches.forEach(match => {
        totalGoals += match.userGoals || 0;
        totalConceded += match.opponentGoals || 0;
        if (match.matchResult === 1) wins++;
    });
    
    const avgGoals = (totalGoals / recent3Matches.length).toFixed(1);
    const avgConceded = (totalConceded / recent3Matches.length).toFixed(1);
    
    // ë“ì  íŒ¨í„´ ë¶„ì„
    if (parseFloat(avgGoals) < 1.0) {
        return "âš½ ìµœê·¼ ë“ì ì´ ë¶€ì¡±í•´ìš”. ê³µê²© ì „ìˆ ì„ ë‹¤ì–‘í™”í•´ë³´ì„¸ìš”";
    }
    
    // ì‹¤ì  íŒ¨í„´ ë¶„ì„
    if (parseFloat(avgConceded) > 2.0) {
        return "ğŸ›¡ï¸ ìµœê·¼ ì‹¤ì ì´ ë§ì•„ìš”. ìˆ˜ë¹„ ì§‘ì¤‘ë„ë¥¼ ë†’ì—¬ë³´ì„¸ìš”";
    }
    
    // ìŠ¹ë¥  íŒ¨í„´ ë¶„ì„
    if (wins === 0) {
        return "ğŸ“ˆ ìµœê·¼ ìŠ¹ë¥ ì´ ë‚®ì•„ìš”. ê¸°ë³¸ê¸° ì—°ìŠµì— ì§‘ì¤‘í•´ë³´ì„¸ìš”";
    }
    
    return null;
}

// êµ¬ì²´ì ì¸ ê°œì„  ë°©í–¥ ì œì‹œ
function getSpecificFeedback(userStats, opponentStats, recentMatches) {
    const userPossession = userStats.possession || 0;
    const userShots = userStats.shoot?.shootTotal || 0;
    const userEffectiveShots = userStats.shoot?.effectiveShootTotal || 0;
    
    // ì ìœ ìœ¨ ê¸°ë°˜ ì œì•ˆ
    if (userPossession < 40) {
        return "ğŸ”„ ì ìœ ìœ¨ì„ ë†’ì´ê¸° ìœ„í•´ íŒ¨ìŠ¤ ì •í™•ë„ë¥¼ ì—°ìŠµí•´ë³´ì„¸ìš”";
    }
    
    // ìŠˆíŒ… íš¨ìœ¨ì„± ê¸°ë°˜ ì œì•ˆ
    if (userShots > 0) {
        const accuracy = (userEffectiveShots / userShots) * 100;
        if (accuracy < 30) {
            return "ğŸ¯ ìŠˆíŒ… ì •í™•ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ ê³¨ëŒ€ ì•ˆìª½ì„ ë…¸ë ¤ë³´ì„¸ìš”";
        }
    }
    
    // ìµœê·¼ ê²½ê¸° ê¸°ë°˜ ì œì•ˆ
    if (recentMatches && recentMatches.length >= 5) {
        const recent5Matches = recentMatches.slice(0, 5);
        let cleanSheets = 0;
        
        recent5Matches.forEach(match => {
            if (match.opponentGoals === 0) cleanSheets++;
        });
        
        if (cleanSheets === 0) {
            return "ğŸ›¡ï¸ ë¬´ì‹¤ì  ê²½ê¸°ë¥¼ ìœ„í•´ ìˆ˜ë¹„ ì¡°ì§ë ¥ì„ ê°•í™”í•´ë³´ì„¸ìš”";
        }
    }
    
    return null;
}

// ìµœê·¼ 10ê²½ê¸° íŠ¹ì§• ë¶„ì„
function analyzeRecentFeatures(matches) {
    if (!matches || matches.length === 0) {
        return {};
    }
    
    const recent10Matches = matches.slice(0, 10);
    const features = {};
    
    // ì—°ìŠ¹/ì—°íŒ¨ ë¶„ì„
    let currentStreak = 0;
    let streakType = '';
    
    for (let i = 0; i < recent10Matches.length; i++) {
        const result = recent10Matches[i].matchResult;
        if (i === 0) {
            streakType = result === 1 ? 'win' : result === 2 ? 'lose' : 'draw';
            currentStreak = 1;
        } else {
            if ((streakType === 'win' && result === 1) || 
                (streakType === 'lose' && result === 2) || 
                (streakType === 'draw' && result === 0)) {
                currentStreak++;
            } else {
                break;
            }
        }
    }
    
    if (currentStreak >= 2) {
        if (streakType === 'win') {
            features.streak = `ì—°ìŠ¹ ${currentStreak}ê²½ê¸°`;
        } else if (streakType === 'lose') {
            features.streak = `ì—°íŒ¨ ${currentStreak}ê²½ê¸°`;
        } else if (streakType === 'draw') {
            features.streak = `ì—°ë¬´ ${currentStreak}ê²½ê¸°`;
        }
    }
    
    // ë¬´ì‹¤ì  ê²½ê¸° ë¶„ì„
    let cleanSheets = 0;
    for (const match of recent10Matches) {
        if (match.opponentGoals === 0) {
            cleanSheets++;
        }
    }
    
    if (cleanSheets >= 2) {
        features.cleanSheets = `ë¬´ì‹¤ì  ${cleanSheets}ê²½ê¸°`;
    }
    
    // í‰ê·  ë“ì  ê³„ì‚°ì„ ìœ„í•œ ì´ ê³¨ ìˆ˜
    let totalGoals = 0;
    for (const match of recent10Matches) {
        totalGoals += match.userGoals || 0;
    }
    
    // í‰ê·  ë“ì  ë¶„ì„
    const avgGoals = (totalGoals / recent10Matches.length).toFixed(1);
    if (parseFloat(avgGoals) >= 1.5) {
        features.avgGoals = `í‰ê·  ${avgGoals}ê³¨`;
    }
    
    return features;
}


// ë“±ê¸‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (lib/grade.jsì˜ getDivisionInfoì™€ ë™ì¼í•œ ë¡œì§)
function getDivisionInfo(divisionId) {
    const divisionMap = {
        800: { name: 'ìŠˆí¼ì±”í”¼ì–¸ìŠ¤', color: '#FFD700', description: 'ìµœê³  ë“±ê¸‰' },
        900: { name: 'ì±”í”¼ì–¸ìŠ¤', color: '#C0C0C0', description: 'ì±”í”¼ì–¸ìŠ¤ ë“±ê¸‰' },
        1000: { name: 'ìŠˆí¼ì±Œë¦°ì €', color: '#CD7F32', description: 'ìŠˆí¼ì±Œë¦°ì € ë“±ê¸‰' },
        1100: { name: 'ì±Œë¦°ì €', color: '#FF6B6B', description: 'ì±Œë¦°ì € ë“±ê¸‰' },
        1200: { name: 'ìŠˆí¼ì±”í”¼ì–¸', color: '#4ECDC4', description: 'ìŠˆí¼ì±”í”¼ì–¸ ë“±ê¸‰' },
        1300: { name: 'ì±”í”¼ì–¸', color: '#45B7D1', description: 'ì±”í”¼ì–¸ ë“±ê¸‰' },
        1400: { name: 'ìŠˆí¼ì›”ë“œí´ë˜ìŠ¤', color: '#96CEB4', description: 'ìŠˆí¼ì›”ë“œí´ë˜ìŠ¤ ë“±ê¸‰' },
        1500: { name: 'ì›”ë“œí´ë˜ìŠ¤', color: '#FFEAA7', description: 'ì›”ë“œí´ë˜ìŠ¤ ë“±ê¸‰' },
        1600: { name: 'ìŠˆí¼í”„ë¡œ', color: '#DDA0DD', description: 'ìŠˆí¼í”„ë¡œ ë“±ê¸‰' },
        1700: { name: 'í”„ë¡œ', color: '#98D8C8', description: 'í”„ë¡œ ë“±ê¸‰' },
        1800: { name: 'ì„¸ë¯¸í”„ë¡œ', color: '#F7DC6F', description: 'ì„¸ë¯¸í”„ë¡œ ë“±ê¸‰' },
        1900: { name: 'ì•„ë§ˆì¶”ì–´', color: '#BB8FCE', description: 'ì•„ë§ˆì¶”ì–´ ë“±ê¸‰' },
        2000: { name: 'ë£¨í‚¤', color: '#85C1E9', description: 'ë£¨í‚¤ ë“±ê¸‰' }
    };
    
    return divisionMap[divisionId] || { 
        name: 'ë“±ê¸‰ ì •ë³´ ì—†ìŒ', 
        color: '#666', 
        description: 'ë“±ê¸‰ ì •ë³´ ì—†ìŒ' 
    };
}

// ë² ìŠ¤íŠ¸ í”Œë ˆì´ì–´ ì„ íƒ
function getBestPlayers(players) {
    if (!players || players.length === 0) {
        return {
            topScorer: { name: 'ì •ë³´ ì—†ìŒ', goals: 0, season: null },
            topAssister: { name: 'ì •ë³´ ì—†ìŒ', assists: 0, season: null },
            topRated: { name: 'ì •ë³´ ì—†ìŒ', rating: 0, season: null }
        };
    }
    
    // ë“ì ì™• ì°¾ê¸°
    const topScorer = players.reduce((best, player) => {
        const goals = player.status?.goal || 0;
        return goals > best.goals ? { 
            name: player.spName, 
            goals, 
            season: player.season,
            grade: player.spGrade || player.grade || null,
            spid: player.spid || null
        } : best;
    }, { name: 'ì •ë³´ ì—†ìŒ', goals: 0, season: null, grade: null, spid: null });
    
    // ë„ì›€ì™• ì°¾ê¸°
    const topAssister = players.reduce((best, player) => {
        const assists = player.status?.assist || 0;
        return assists > best.assists ? { 
            name: player.spName, 
            assists, 
            season: player.season,
            grade: player.spGrade || player.grade || null,
            spid: player.spid || null
        } : best;
    }, { name: 'ì •ë³´ ì—†ìŒ', assists: 0, season: null, grade: null, spid: null });
    
    // í‰ì ì™• ì°¾ê¸°
    const topRated = players.reduce((best, player) => {
        const rating = player.status?.spRating || 0;
        return rating > best.rating ? { 
            name: player.spName, 
            rating: rating.toFixed(1), 
            season: player.season,
            grade: player.spGrade || player.grade || null,
            spid: player.spid || null
        } : best;
    }, { name: 'ì •ë³´ ì—†ìŒ', rating: 0, season: null, grade: null, spid: null });
    
    return { topScorer, topAssister, topRated };
}

// í¬ì§€ì…˜ ë²ˆí˜¸ë¥¼ ì‹¤ì œ í¬ì§€ì…˜ëª…ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function getPositionName(positionNumber) {
    const positionMap = {
        0: 'GK',   // ê³¨í‚¤í¼
        1: 'SW',   // ìŠ¤ìœ„í¼
        2: 'RWB',  // ë¼ì´íŠ¸ ìœ™ë°±
        3: 'RB',   // ë¼ì´íŠ¸ ë°±
        4: 'RCB',  // ë¼ì´íŠ¸ ì„¼í„°ë°±
        5: 'CB',   // ì„¼í„°ë°±
        6: 'LCB',  // ë ˆí”„íŠ¸ ì„¼í„°ë°±
        7: 'LB',   // ë ˆí”„íŠ¸ ë°±
        8: 'LWB',  // ë ˆí”„íŠ¸ ìœ™ë°±
        9: 'RDM',  // ë¼ì´íŠ¸ ë””íœì‹œë¸Œ ë¯¸ë“œí•„ë”
        10: 'CDM', // ì„¼í„° ë””íœì‹œë¸Œ ë¯¸ë“œí•„ë”
        11: 'LDM', // ë ˆí”„íŠ¸ ë””íœì‹œë¸Œ ë¯¸ë“œí•„ë”
        12: 'RM',  // ë¼ì´íŠ¸ ë¯¸ë“œí•„ë”
        13: 'RCM', // ë¼ì´íŠ¸ ì„¼í„° ë¯¸ë“œí•„ë”
        14: 'CM',  // ì„¼í„° ë¯¸ë“œí•„ë”
        15: 'LCM', // ë ˆí”„íŠ¸ ì„¼í„° ë¯¸ë“œí•„ë”
        16: 'LM',  // ë ˆí”„íŠ¸ ë¯¸ë“œí•„ë”
        17: 'RAM', // ë¼ì´íŠ¸ ì–´íƒí‚¹ ë¯¸ë“œí•„ë”
        18: 'CAM', // ì„¼í„° ì–´íƒí‚¹ ë¯¸ë“œí•„ë”
        19: 'LAM', // ë ˆí”„íŠ¸ ì–´íƒí‚¹ ë¯¸ë“œí•„ë”
        20: 'RF',  // ë¼ì´íŠ¸ í¬ì›Œë“œ
        21: 'CF',  // ì„¼í„° í¬ì›Œë“œ
        22: 'LF',  // ë ˆí”„íŠ¸ í¬ì›Œë“œ
        23: 'RW',  // ë¼ì´íŠ¸ ìœ™
        24: 'RS',  // ë¼ì´íŠ¸ ìŠ¤íŠ¸ë¼ì´ì»¤
        25: 'ST',  // ìŠ¤íŠ¸ë¼ì´ì»¤
        26: 'LS',  // ë ˆí”„íŠ¸ ìŠ¤íŠ¸ë¼ì´ì»¤
        27: 'LW',  // ë ˆí”„íŠ¸ ìœ™
        28: 'SUB'  // êµì²´ ì„ ìˆ˜
    };
    
    const positionName = positionMap[positionNumber];
    console.log(`Position ${positionNumber} mapped to: ${positionName || 'UNKNOWN'}`);
    return positionName || 'UNKNOWN';
}

// í¬ì§€ì…˜ì„ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜í•˜ëŠ” í•¨ìˆ˜
function getPositionCategory(positionNumber) {
    const positionName = getPositionName(positionNumber);
    
    console.log(`Classifying position ${positionNumber} (${positionName})`);
    
    // ê³µê²©ìˆ˜: ST, CF, LW, RW, LF, RF, RS, LS
    if (['ST', 'CF', 'LW', 'RW', 'LF', 'RF', 'RS', 'LS'].includes(positionName)) {
        console.log(`Position ${positionName} classified as FORWARD`);
        return 'forward';
    }
    // ë¯¸ë“œí•„ë”: CAM, CM, CDM, LM, RM, RAM, LAM, RCM, LCM, RDM, LDM
    else if (['CAM', 'CM', 'CDM', 'LM', 'RM', 'RAM', 'LAM', 'RCM', 'LCM', 'RDM', 'LDM'].includes(positionName)) {
        console.log(`Position ${positionName} classified as MIDFIELDER`);
        return 'midfielder';
    }
    // ìˆ˜ë¹„ìˆ˜: CB, LB, RB, LWB, RWB, LCB, RCB, LC, RC
    else if (['CB', 'LB', 'RB', 'LWB', 'RWB', 'LCB', 'RCB', 'LC', 'RC'].includes(positionName)) {
        console.log(`Position ${positionName} classified as DEFENDER`);
        return 'defender';
    }
    // ê³¨í‚¤í¼: GK
    else if (['GK'].includes(positionName)) {
        console.log(`Position ${positionName} classified as GOALKEEPER`);
        return 'goalkeeper';
    }
    // êµì²´ ì„ ìˆ˜: SUB
    else if (['SUB'].includes(positionName)) {
        console.log(`Position ${positionName} classified as SUBSTITUTE`);
        return 'substitute';
    }
    // ê¸°íƒ€
    else {
        console.log(`Position ${positionName} classified as OTHER`);
        return 'other';
    }
}

// ì„ ìˆ˜ ëª©ë¡ì„ í¬ì§€ì…˜ë³„ë¡œ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
function getPlayersByPosition(players) {
    if (!players || players.length === 0) {
        console.log('No players data provided');
        return {
            forwards: [],
            midfielders: [],
            defenders: [],
            goalkeepers: []
        };
    }
    
    const forwards = [];
    const midfielders = [];
    const defenders = [];
    const goalkeepers = [];
    const substitutes = [];
    const others = [];
    
    console.log('Processing players:', players.length);
    
    players.forEach((player, index) => {
        const positionNumber = player.spPosition;
        const positionName = getPositionName(positionNumber);
        const category = getPositionCategory(positionNumber);
        const rating = player.status?.spRating || 0;
        const goals = player.status?.goal || 0;
        const assists = player.status?.assist || 0;
        
        console.log(`Player ${index}: ${player.spName}, Position: ${positionNumber} (${positionName}), Category: ${category}, Rating: ${rating}`);
        
        const playerInfo = {
            name: player.spName,
            rating: rating,
            goals: goals,
            assists: assists,
            season: player.season,
            position: positionName,
            positionNumber: positionNumber,
            grade: player.spGrade || player.grade || null,
            spid: player.spid || null
        };
        
        // í¬ì§€ì…˜ë³„ ë¶„ë¥˜
        switch (category) {
            case 'forward':
                forwards.push(playerInfo);
                console.log(`Added ${player.spName} to forwards`);
                break;
            case 'midfielder':
                midfielders.push(playerInfo);
                console.log(`Added ${player.spName} to midfielders`);
                break;
            case 'defender':
                defenders.push(playerInfo);
                console.log(`Added ${player.spName} to defenders`);
                break;
            case 'goalkeeper':
                goalkeepers.push(playerInfo);
                console.log(`Added ${player.spName} to goalkeepers`);
                break;
            case 'substitute':
                // êµì²´ ì„ ìˆ˜ëŠ” í‰ì ì´ 0ì´ ì•„ë‹Œ ê²½ìš°ë§Œ ì¶”ê°€
                if (rating > 0) {
                    substitutes.push(playerInfo);
                    console.log(`Added ${player.spName} to substitutes`);
                } else {
                    console.log(`Skipped ${player.spName} from substitutes (rating: 0)`);
                }
                break;
            default:
                others.push(playerInfo);
                console.log(`Added ${player.spName} to others (position: ${positionName})`);
        }
    });
    
    // í‰ì ìˆœìœ¼ë¡œ ì •ë ¬
    forwards.sort((a, b) => b.rating - a.rating);
    midfielders.sort((a, b) => b.rating - a.rating);
    defenders.sort((a, b) => b.rating - a.rating);
    goalkeepers.sort((a, b) => b.rating - a.rating);
    substitutes.sort((a, b) => b.rating - a.rating);
    others.sort((a, b) => b.rating - a.rating);
    
    const result = { forwards, midfielders, defenders, goalkeepers, substitutes, others };
    console.log('Final position groups:', result);
    
    return result;
}

// ì„ ìˆ˜ ëª©ë¡ HTML ìƒì„±
function renderPlayerList(players, teamName) {
    console.log(`Rendering player list for ${teamName}:`, players);
    
    if (!players || players.length === 0) {
        return `
            <div class="team-players">
                <h5>${teamName}</h5>
                <div class="no-players">ì„ ìˆ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        `;
    }
    
    const playersByPosition = getPlayersByPosition(players);
    console.log(`Players by position for ${teamName}:`, playersByPosition);
    
    return `
        <div class="team-players">
            <h5>${teamName}</h5>
            <div class="players-by-position">
                ${playersByPosition.forwards.length > 0 ? `
                    <div class="position-group">
                        <h6>ê³µê²©ìˆ˜</h6>
                        <div class="players-list">
                            ${playersByPosition.forwards.map(player => renderPlayerItem(player)).join('')}
                        </div>
                    </div>
                ` : ''}
                ${playersByPosition.midfielders.length > 0 ? `
                    <div class="position-group">
                        <h6>ë¯¸ë“œí•„ë”</h6>
                        <div class="players-list">
                            ${playersByPosition.midfielders.map(player => renderPlayerItem(player)).join('')}
                        </div>
                    </div>
                ` : ''}
                ${playersByPosition.defenders.length > 0 ? `
                    <div class="position-group">
                        <h6>ìˆ˜ë¹„ìˆ˜</h6>
                        <div class="players-list">
                            ${playersByPosition.defenders.map(player => renderPlayerItem(player)).join('')}
                        </div>
                    </div>
                ` : ''}
                ${playersByPosition.goalkeepers.length > 0 ? `
                    <div class="position-group">
                        <h6>ê³¨í‚¤í¼</h6>
                        <div class="players-list">
                            ${playersByPosition.goalkeepers.map(player => renderPlayerItem(player)).join('')}
                        </div>
                    </div>
                ` : ''}
                ${playersByPosition.substitutes && playersByPosition.substitutes.length > 0 ? `
                    <div class="position-group">
                        <h6>êµì²´ ì„ ìˆ˜</h6>
                        <div class="players-list">
                            ${playersByPosition.substitutes.map(player => renderPlayerItem(player)).join('')}
                        </div>
                    </div>
                ` : ''}
                ${playersByPosition.others && playersByPosition.others.length > 0 ? `
                    <div class="position-group">
                        <h6>ê¸°íƒ€</h6>
                        <div class="players-list">
                            ${playersByPosition.others.map(player => renderPlayerItem(player)).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ê°•í™” ë“±ê¸‰ ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜
function renderGradeImage(grade, spid) {
    if (!grade && !spid) return '';
    
    // spidì—ì„œ ê°•í™” ë“±ê¸‰ ì¶”ì¶œ (ì˜ˆ: spidê°€ "123456789"ë¼ë©´ ë§ˆì§€ë§‰ ìˆ«ìë¡œ ë“±ê¸‰ ì¶”ì •)
    let gradeLevel = grade;
    if (!gradeLevel && spid) {
        // spidì˜ ë§ˆì§€ë§‰ ìë¦¬ë¡œ ê°•í™” ë“±ê¸‰ ì¶”ì • (0-13)
        const lastDigit = parseInt(spid.toString().slice(-1));
        gradeLevel = lastDigit % 14; // 0-13 ë²”ìœ„ë¡œ ì œí•œ
    }
    
    if (gradeLevel === null || gradeLevel === undefined) return '';
    
    // ê°•í™” ë“±ê¸‰ë³„ ìƒ‰ìƒê³¼ í…ìŠ¤íŠ¸
    const gradeInfo = getGradeInfo(gradeLevel);
    
    return `
        <div class="grade-badge grade-${gradeLevel}" title="ê°•í™” ë“±ê¸‰: ${gradeInfo.name}">
            <span class="grade-text">+${gradeLevel}</span>
        </div>
    `;
}

// ê°•í™” ë“±ê¸‰ ì •ë³´ ë°˜í™˜ í•¨ìˆ˜
function getGradeInfo(grade) {
    const gradeMap = {
        0: { name: 'ê¸°ë³¸', color: '#6B7280', tier: 'basic' },
        1: { name: '+1', color: '#8B4513', tier: 'brown' },
        2: { name: '+2', color: '#A0522D', tier: 'brown' },
        3: { name: '+3', color: '#CD853F', tier: 'brown' },
        4: { name: '+4', color: '#D2691E', tier: 'brown' },
        5: { name: '+5', color: '#C0C0C0', tier: 'silver' },
        6: { name: '+6', color: '#A8A8A8', tier: 'silver' },
        7: { name: '+7', color: '#808080', tier: 'silver' },
        8: { name: '+8', color: '#FFD700', tier: 'gold' },
        9: { name: '+9', color: '#FFA500', tier: 'gold' },
        10: { name: '+10', color: '#FF8C00', tier: 'gold' },
        11: { name: '+11', color: '#E5E4E2', tier: 'platinum' },
        12: { name: '+12', color: '#BCC6CC', tier: 'platinum' },
        13: { name: '+13', color: '#98AFC7', tier: 'platinum' }
    };
    
    return gradeMap[grade] || { name: `+${grade}`, color: '#6B7280', tier: 'basic' };
}

// ê°œë³„ ì„ ìˆ˜ ì•„ì´í…œ HTML ìƒì„±
function renderPlayerItem(player) {
    console.log('Rendering player item:', player);
    
    const seasonImg = player.season?.seasonImg ? 
        `<img src="${player.season.seasonImg}" alt="ì‹œì¦Œ" class="player-season-img" onerror="this.style.display='none'"/>` : '';
    
    const gradeImg = renderGradeImage(player.grade, player.spid);
    
    const stats = [];
    if (player.goals > 0) stats.push(`${player.goals}ê³¨`);
    if (player.assists > 0) stats.push(`${player.assists}ì–´ì‹œ`);
    
    const statsText = stats.length > 0 ? ` (${stats.join(', ')})` : '';
    
    const rating = typeof player.rating === 'number' ? player.rating.toFixed(1) : '0.0';
    const position = player.position || 'UNKNOWN';
    
    return `
        <div class="player-item">
            <div class="player-left-info">
                <span class="player-position">${position}</span>
                ${seasonImg}
                ${gradeImg}
                <span class="player-name">${player.name || 'ì´ë¦„ ì—†ìŒ'}</span>
            </div>
            <div class="player-right-info">
                <span class="player-stats">${statsText}</span>
                <span class="player-rating">${rating}</span>
            </div>
        </div>
    `;
}


// ì‹¤ì œ ì„ ìˆ˜ í¬ì§€ì…˜ì„ ë¶„ì„í•˜ì—¬ í¬ë©”ì´ì…˜ ê³„ì‚°
function calculateFormationFromPlayers(players) {
    // ë¹ˆ ë°°ì—´ì´ê±°ë‚˜ nullì¸ ê²½ìš° ë¹ˆ í¬ë©”ì´ì…˜ ë°˜í™˜
    if (!players || players.length === 0) {
        console.log('ì„ ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return '0-0-0-0';
    }
    
    // 1. êµì²´ ì„ ìˆ˜(SUB)ì™€ ê¸°íƒ€ í¬ì§€ì…˜ ì œì™¸í•˜ê³  ì‹¤ì œ ì¶œì „ ì„ ìˆ˜ë§Œ í•„í„°ë§
    const startingPlayers = players.filter(player => {
        const positionGroup = getPositionGroup(player.spPosition);
        return positionGroup !== 'OTHER' && positionGroup !== 'SUB';
    });
    
    console.log(`ì „ì²´ ì„ ìˆ˜: ${players.length}ëª…, ì¶œì „ ì„ ìˆ˜: ${startingPlayers.length}ëª…`);
    
    // 2. ê³¨í‚¤í¼ì™€ í•„ë“œ í”Œë ˆì´ì–´ ë¶„ë¥˜
    const goalkeepers = startingPlayers.filter(player => getPositionGroup(player.spPosition) === 'GK');
    const fieldPlayers = startingPlayers.filter(player => getPositionGroup(player.spPosition) !== 'GK');
    
    console.log(`ê³¨í‚¤í¼: ${goalkeepers.length}ëª…, í•„ë“œ í”Œë ˆì´ì–´: ${fieldPlayers.length}ëª…`);
    
    // 3. í¬ì§€ì…˜ ê·¸ë£¹ë³„ ì„ ìˆ˜ ìˆ˜ ê³„ì‚° (ê³¨í‚¤í¼ ì œì™¸)
    const positionCounts = {
        DF: 0,  // ìˆ˜ë¹„ìˆ˜
        DM: 0,  // ìˆ˜ë¯¸
        AM: 0,  // ê³µë¯¸
        FW: 0   // ê³µê²©ìˆ˜
    };
    
    fieldPlayers.forEach(player => {
        const group = getPositionGroup(player.spPosition);
        if (positionCounts.hasOwnProperty(group)) {
            positionCounts[group]++;
        } else {
            console.log(`ì•Œ ìˆ˜ ì—†ëŠ” í¬ì§€ì…˜ ê·¸ë£¹: ${group} (í¬ì§€ì…˜: ${player.spPosition})`);
        }
    });
    
    // 4. í¬ë©”ì´ì…˜ ë¬¸ìì—´ ìƒì„± (ìˆ˜ë¹„ìˆ˜-ìˆ˜ë¯¸-ê³µë¯¸-ê³µê²©ìˆ˜)
    let formation = `${positionCounts.DF}-${positionCounts.DM}-${positionCounts.AM}-${positionCounts.FW}`;
    
    // 4-2-2-1-1 í¬ë©”ì´ì…˜ íŠ¹ë³„ ì²˜ë¦¬ (FCì˜¨ë¼ì¸ ì •ì˜)
    // FCì˜¨ë¼ì¸ì—ì„œ LB, LCB, RCB, RB, LDM, RDM, LM, RM, CAM, STë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° 4-2-2-1-1
    if (positionCounts.DF === 4 && positionCounts.DM === 2 && positionCounts.AM === 2 && positionCounts.FW === 1) {
        // FCì˜¨ë¼ì¸ 4-2-2-1-1 í¬ë©”ì´ì…˜ì˜ í•µì‹¬ í¬ì§€ì…˜ë“¤ í™•ì¸
        const fcOnlinePositions = fieldPlayers.map(p => getPositionName(p.spPosition));
        
        // FCì˜¨ë¼ì¸ 4-2-2-1-1 í¬ë©”ì´ì…˜ ì¡°ê±´ í™•ì¸
        const hasFcOnlineDefenders = fcOnlinePositions.some(pos => ['LB', 'LCB', 'RCB', 'RB'].includes(pos));
        const hasFcOnlineDMs = fcOnlinePositions.some(pos => ['LDM', 'RDM'].includes(pos));
        const hasFcOnlineAMs = fcOnlinePositions.some(pos => ['LM', 'RM', 'CAM'].includes(pos));
        const hasFcOnlineST = fcOnlinePositions.includes('ST');
        
        console.log(`FCì˜¨ë¼ì¸ 4-2-2-1-1 ì²´í¬ - ìˆ˜ë¹„ìˆ˜:${hasFcOnlineDefenders}, ìˆ˜ë¯¸:${hasFcOnlineDMs}, ê³µë¯¸:${hasFcOnlineAMs}, ê³µê²©ìˆ˜:${hasFcOnlineST}`);
        console.log(`ì‹¤ì œ í¬ì§€ì…˜ë“¤: ${fcOnlinePositions.join(', ')}`);
        
        // FCì˜¨ë¼ì¸ 4-2-2-1-1 í¬ë©”ì´ì…˜ ì¡°ê±´: í•µì‹¬ í¬ì§€ì…˜ë“¤ì´ ëª¨ë‘ ìˆì–´ì•¼ í•¨
        if (hasFcOnlineDefenders && hasFcOnlineDMs && hasFcOnlineAMs && hasFcOnlineST) {
            formation = '4-2-2-1-1';
            console.log('âœ… FCì˜¨ë¼ì¸ 4-2-2-1-1 í¬ë©”ì´ì…˜ ê°ì§€ë¨');
        } else {
            console.log('âŒ FCì˜¨ë¼ì¸ 4-2-2-1-1 í¬ë©”ì´ì…˜ ì¡°ê±´ ë¶ˆë§Œì¡±');
        }
    }
    
    // ì¶”ê°€: 4-2-3-1ì—ì„œ CAMì´ ìˆëŠ” ê²½ìš°ë„ 4-2-2-1-1ë¡œ ì¸ì‹ (FCì˜¨ë¼ì¸ íŠ¹ë³„ ì²˜ë¦¬)
    else if (positionCounts.DF === 4 && positionCounts.DM === 2 && positionCounts.AM === 3 && positionCounts.FW === 1) {
        const fcOnlinePositions = fieldPlayers.map(p => getPositionName(p.spPosition));
        const hasFcOnlineDefenders = fcOnlinePositions.some(pos => ['LB', 'LCB', 'RCB', 'RB'].includes(pos));
        const hasFcOnlineDMs = fcOnlinePositions.some(pos => ['LDM', 'RDM'].includes(pos));
        const hasFcOnlineAMs = fcOnlinePositions.some(pos => ['LM', 'RM', 'CAM'].includes(pos));
        const hasFcOnlineST = fcOnlinePositions.includes('ST');
        
        console.log(`4-2-3-1ì—ì„œ FCì˜¨ë¼ì¸ 4-2-2-1-1 ì²´í¬ - ìˆ˜ë¹„ìˆ˜:${hasFcOnlineDefenders}, ìˆ˜ë¯¸:${hasFcOnlineDMs}, ê³µë¯¸:${hasFcOnlineAMs}, ê³µê²©ìˆ˜:${hasFcOnlineST}`);
        
        if (hasFcOnlineDefenders && hasFcOnlineDMs && hasFcOnlineAMs && hasFcOnlineST) {
            formation = '4-2-2-1-1';
            console.log('âœ… 4-2-3-1ì—ì„œ FCì˜¨ë¼ì¸ 4-2-2-1-1 í¬ë©”ì´ì…˜ ê°ì§€ë¨');
        }
    }
    
    console.log(`ê³„ì‚°ëœ í¬ë©”ì´ì…˜: ${formation}`);
    console.log(`í¬ì§€ì…˜ë³„ ì„ ìˆ˜ ìˆ˜ - ìˆ˜ë¹„ìˆ˜:${positionCounts.DF}, ìˆ˜ë¯¸:${positionCounts.DM}, ê³µë¯¸:${positionCounts.AM}, ê³µê²©ìˆ˜:${positionCounts.FW}, ê³¨í‚¤í¼:${goalkeepers.length}`);
    
    // 5. ì„ ìˆ˜ë³„ í¬ì§€ì…˜ ìƒì„¸ ë¡œê·¸
    fieldPlayers.forEach(player => {
        const positionName = getPositionName(player.spPosition);
        const group = getPositionGroup(player.spPosition);
        console.log(`ì„ ìˆ˜: ${player.spName || 'ì´ë¦„ì—†ìŒ'}, í¬ì§€ì…˜: ${positionName} (${player.spPosition}), ê·¸ë£¹: ${group}`);
    });
    
    return formation;
}

// í¬ë©”ì´ì…˜ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ê°œë°œìš©)
function testFormationCalculation() {
    console.log('=== í¬ë©”ì´ì…˜ ê³„ì‚° í…ŒìŠ¤íŠ¸ ===');
    
    // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 1: 4-4-2 í¬ë©”ì´ì…˜
    const formation442 = [
        { spPosition: 0, spName: 'GK' },      // GK
        { spPosition: 5, spName: 'CB1' },     // CB
        { spPosition: 6, spName: 'CB2' },     // LCB -> CB
        { spPosition: 7, spName: 'LB' },      // LB
        { spPosition: 3, spName: 'RB' },      // RB
        { spPosition: 14, spName: 'CM1' },    // CM -> AM
        { spPosition: 15, spName: 'CM2' },    // LCM -> AM
        { spPosition: 12, spName: 'RM' },     // RM -> AM
        { spPosition: 16, spName: 'LM' },     // LM -> AM
        { spPosition: 25, spName: 'ST1' },    // ST -> FW
        { spPosition: 21, spName: 'ST2' }     // CF -> FW
    ];
    
    console.log('í…ŒìŠ¤íŠ¸ 1 - 4-4-2 í¬ë©”ì´ì…˜:');
    const result1 = calculateFormationFromPlayers(formation442);
    console.log(`ê²°ê³¼: ${result1}\n`);
    
    // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 2: 4-3-3 í¬ë©”ì´ì…˜
    const formation433 = [
        { spPosition: 0, spName: 'GK' },      // GK
        { spPosition: 5, spName: 'CB1' },     // CB
        { spPosition: 6, spName: 'CB2' },     // LCB -> CB
        { spPosition: 7, spName: 'LB' },      // LB
        { spPosition: 3, spName: 'RB' },      // RB
        { spPosition: 10, spName: 'CDM' },    // CDM -> DM
        { spPosition: 14, spName: 'CM1' },    // CM -> AM
        { spPosition: 15, spName: 'CM2' },    // LCM -> AM
        { spPosition: 25, spName: 'ST' },     // ST -> FW
        { spPosition: 27, spName: 'LW' },     // LW -> FW
        { spPosition: 23, spName: 'RW' }      // RW -> FW
    ];
    
    console.log('í…ŒìŠ¤íŠ¸ 2 - 4-1-2-3 í¬ë©”ì´ì…˜:');
    const result2 = calculateFormationFromPlayers(formation433);
    console.log(`ê²°ê³¼: ${result2}\n`);
    
    // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 3: 3-5-2 í¬ë©”ì´ì…˜
    const formation352 = [
        { spPosition: 0, spName: 'GK' },      // GK
        { spPosition: 5, spName: 'CB1' },     // CB
        { spPosition: 6, spName: 'CB2' },     // LCB -> CB
        { spPosition: 4, spName: 'CB3' },     // RCB -> CB
        { spPosition: 10, spName: 'CDM1' },   // CDM -> DM
        { spPosition: 11, spName: 'CDM2' },   // LDM -> DM
        { spPosition: 14, spName: 'CM1' },    // CM -> AM
        { spPosition: 15, spName: 'CM2' },    // LCM -> AM
        { spPosition: 16, spName: 'LM' },     // LM -> AM
        { spPosition: 25, spName: 'ST1' },    // ST -> FW
        { spPosition: 21, spName: 'ST2' }     // CF -> FW
    ];
    
    console.log('í…ŒìŠ¤íŠ¸ 3 - 3-2-3-2 í¬ë©”ì´ì…˜:');
    const result3 = calculateFormationFromPlayers(formation352);
    console.log(`ê²°ê³¼: ${result3}\n`);
    
    // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 4: 4-2-2-1-1 í¬ë©”ì´ì…˜ (FCì˜¨ë¼ì¸ ì •ì˜)
    const formation42211 = [
        { spPosition: 0, spName: 'GK' },      // GK
        { spPosition: 7, spName: 'LB' },      // LB -> DF
        { spPosition: 6, spName: 'LCB' },     // LCB -> DF
        { spPosition: 4, spName: 'RCB' },     // RCB -> DF
        { spPosition: 3, spName: 'RB' },      // RB -> DF
        { spPosition: 11, spName: 'LDM' },    // LDM -> DM
        { spPosition: 10, spName: 'RDM' },    // RDM -> DM
        { spPosition: 16, spName: 'LM' },     // LM -> AM
        { spPosition: 12, spName: 'RM' },     // RM -> AM
        { spPosition: 25, spName: 'ST' }      // ST -> FW
    ];
    
    console.log('í…ŒìŠ¤íŠ¸ 4 - 4-2-2-1-1 í¬ë©”ì´ì…˜ (FCì˜¨ë¼ì¸):');
    const result4 = calculateFormationFromPlayers(formation42211);
    console.log(`ê²°ê³¼: ${result4}\n`);
}

// ê³µê²© íš¨ìœ¨ì„± ê³„ì‚°
function calculateAttackEfficiency(userStats) {
    if (!userStats.shoot) {
        return { score: 0, level: 'poor', description: 'ë¬´ë“ì ' };
    }
    
    // ì•ˆì „í•œ ê°’ ì¶”ì¶œ
    const shootTotal = userStats.shoot.shootTotal || 0;
    const goalTotal = userStats.shoot.goalTotal || 0;
    const effectiveShootTotal = userStats.shoot.effectiveShootTotal || 0;
    const goalInPenalty = userStats.shoot.goalInPenalty || 0;
    
    if (shootTotal === 0) {
        return { score: 0, level: 'poor', description: 'ë¬´ë“ì ' };
    }
    
    // NaN ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „í•œ ê³„ì‚°
    const shootAccuracy = shootTotal > 0 ? goalTotal / shootTotal : 0;
    const effectiveShootRatio = shootTotal > 0 ? effectiveShootTotal / shootTotal : 0;
    const boxFinishing = goalTotal > 0 ? goalInPenalty / goalTotal : 0;
    
    // ìœ íš¨í•œ ìˆ«ìì¸ì§€ í™•ì¸
    const validShootAccuracy = isNaN(shootAccuracy) ? 0 : shootAccuracy;
    const validEffectiveShootRatio = isNaN(effectiveShootRatio) ? 0 : effectiveShootRatio;
    const validBoxFinishing = isNaN(boxFinishing) ? 0 : boxFinishing;
    
    const efficiency = (validShootAccuracy * 0.4 + validEffectiveShootRatio * 0.4 + validBoxFinishing * 0.2) * 100;
    const finalScore = isNaN(efficiency) ? 0 : efficiency;
    
    return {
        score: Math.round(Math.min(Math.max(finalScore, 0), 100)), // 0-100 ë²”ìœ„ë¡œ ì œí•œ
        level: finalScore > 75 ? 'excellent' : finalScore > 50 ? 'good' : finalScore > 25 ? 'average' : 'poor',
        description: finalScore > 75 ? 'ì •í™•í•œ í‚¬ëŸ¬' : finalScore > 50 ? 'íš¨ìœ¨ì  ê³µê²©ìˆ˜' : finalScore > 25 ? 'ê¸°íšŒ ì°½ì¡°í˜•' : 'ë³¼ë¥¨ ìŠˆí„°'
    };
}

// ë¹Œë“œì—… ìŠ¤íƒ€ì¼ ê³„ì‚° (ëª¨ë“  íŒ¨ìŠ¤ ìˆ˜, íŒ¨ìŠ¤ ì„±ê³µë¥ , ì ìœ ìœ¨ ê¸°ë°˜)
function calculateBuildupStyle(userStats) {
    console.log('=== ë¹Œë“œì—… ê³„ì‚° ì‹œì‘ ===');
    console.log('userStats:', userStats);
    
    // ê¸°ë³¸ê°’ ì²´í¬ - ë°ì´í„°ê°€ ì „í˜€ ì—†ìœ¼ë©´ 0ì 
    if (!userStats || (!userStats.pass && !userStats.possession)) {
        console.log('íŒ¨ìŠ¤ ë° ì ìœ ìœ¨ ë°ì´í„° ì—†ìŒ');
        return { score: 0, style: 'direct', description: 'ë°ì´í„° ì—†ìŒ' };
    }
    
    // 1. íŒ¨ìŠ¤ ë°ì´í„° ì¶”ì¶œ ì‹œë„
    let totalPassAttempts = 0;
    let totalPassSuccess = 0;
    
    if (userStats.pass) {
        console.log('íŒ¨ìŠ¤ ë°ì´í„° í™•ì¸:', userStats.pass);
        
        // FCì˜¨ë¼ì¸ APIì˜ ì‹¤ì œ í•„ë“œëª…ë“¤ (ì œê³µëœ API êµ¬ì¡° ê¸°ë°˜)
        const passTry = userStats.pass.passTry || 0;
        const passSuccess = userStats.pass.passSuccess || 0;
        
        // ê°œë³„ íŒ¨ìŠ¤ ìœ í˜•ë³„ ì‹œë„ ë° ì„±ê³µ ìˆ˜
        const shortPassTry = userStats.pass.shortPassTry || 0;
        const shortPassSuccess = userStats.pass.shortPassSuccess || 0;
        const longPassTry = userStats.pass.longPassTry || 0;
        const longPassSuccess = userStats.pass.longPassSuccess || 0;
        const bouncingLobPassTry = userStats.pass.bouncingLobPassTry || 0;
        const bouncingLobPassSuccess = userStats.pass.bouncingLobPassSuccess || 0;
        const drivenGroundPassTry = userStats.pass.drivenGroundPassTry || 0;
        const drivenGroundPassSuccess = userStats.pass.drivenGroundPassSuccess || 0;
        const throughPassTry = userStats.pass.throughPassTry || 0;
        const throughPassSuccess = userStats.pass.throughPassSuccess || 0;
        const lobbedThroughPassTry = userStats.pass.lobbedThroughPassTry || 0;
        const lobbedThroughPassSuccess = userStats.pass.lobbedThroughPassSuccess || 0;
        
        // ì´ íŒ¨ìŠ¤ ì‹œë„ ë° ì„±ê³µ ìˆ˜ ê³„ì‚°
        totalPassAttempts = passTry;
        totalPassSuccess = passSuccess;
        
        console.log('ì¶”ì¶œëœ íŒ¨ìŠ¤ ì •ë³´:', {
            passTry,
            passSuccess,
            shortPassTry,
            shortPassSuccess,
            longPassTry,
            longPassSuccess,
            bouncingLobPassTry,
            bouncingLobPassSuccess,
            drivenGroundPassTry,
            drivenGroundPassSuccess,
            throughPassTry,
            throughPassSuccess,
            lobbedThroughPassTry,
            lobbedThroughPassSuccess,
            totalPassAttempts,
            totalPassSuccess,
            calculatedSuccessRate: totalPassAttempts > 0 ? (totalPassSuccess / totalPassAttempts) : 0
        });
    }
    
    // 2. íŒ¨ìŠ¤ ì„±ê³µë¥  ê³„ì‚°
    const passSuccessRate = totalPassAttempts > 0 ? (totalPassSuccess / totalPassAttempts) : 0;
    
    // 3. ì ìœ ìœ¨ í™•ì¸
    const possession = userStats.possession || 0;
    console.log('ì ìœ ìœ¨:', possession);
    
    // 4. ê°œì„ ëœ ë¹Œë“œì—… ì ìˆ˜ ê³„ì‚°
    let finalScore = 0;
    
    // íŒ¨ìŠ¤ ì„±ê³µë¥  ì ìˆ˜ (0-40ì )
    const passSuccessScore = passSuccessRate * 40;
    
    // ì ìœ ìœ¨ ì ìˆ˜ (0-40ì ) - 50%ë¥¼ ê¸°ì¤€ì ìœ¼ë¡œ ì„¤ì •
    const possessionScore = possession > 0 ? Math.min((possession / 50) * 40, 40) : 0;
    
    // íŒ¨ìŠ¤ í™œì„±ë„ ì ìˆ˜ (0-20ì ) - 100íŒ¨ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •
    const passActivityScore = totalPassAttempts > 0 ? Math.min((totalPassAttempts / 100) * 20, 20) : 0;
    
    finalScore = passSuccessScore + possessionScore + passActivityScore;
    
    // ë°ì´í„°ê°€ ë¶€ì¡±í•œ ê²½ìš° ì ìœ ìœ¨ë§Œìœ¼ë¡œë¼ë„ ì ìˆ˜ ì œê³µ
    if (finalScore === 0 && possession > 0) {
        finalScore = Math.min(possession * 0.8, 60); // ì ìœ ìœ¨ë§Œ ìˆì–´ë„ ìµœëŒ€ 60ì  ê°€ëŠ¥
        console.log('ì ìœ ìœ¨ë§Œìœ¼ë¡œ ì ìˆ˜ ê³„ì‚°:', finalScore);
    }
    
    // ìµœì†Œ ì ìˆ˜ ë³´ì¥ (ë‹¨, ì•„ì˜ˆ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ëŠ” ì œì™¸)
    if (finalScore === 0 && totalPassAttempts === 0 && possession === 0) {
        finalScore = 0; // ë°ì´í„°ê°€ ì „í˜€ ì—†ìœ¼ë©´ 0ì 
        console.log('ë°ì´í„° ì—†ìŒ, 0ì  ì ìš©');
    } else if (finalScore > 0 && finalScore < 5) {
        finalScore = 5; // ìµœì†Œ 5ì ì€ ë³´ì¥
        console.log('ìµœì†Œ ì ìˆ˜ 5ì  ì ìš©:', finalScore);
    }
    
    console.log('=== ë¹Œë“œì—… ì ìˆ˜ ì„¸ë¶€ ê³„ì‚° ===');
    console.log('ì´ íŒ¨ìŠ¤ ì‹œë„:', totalPassAttempts);
    console.log('ì´ íŒ¨ìŠ¤ ì„±ê³µ:', totalPassSuccess);
    console.log('íŒ¨ìŠ¤ ì„±ê³µë¥ :', passSuccessRate.toFixed(2));
    console.log('ì ìœ ìœ¨:', possession);
    console.log('íŒ¨ìŠ¤ ì„±ê³µ ì ìˆ˜:', passSuccessScore.toFixed(1));
    console.log('ì ìœ ìœ¨ ì ìˆ˜:', possessionScore.toFixed(1));
    console.log('íŒ¨ìŠ¤ í™œì„±ë„ ì ìˆ˜:', passActivityScore.toFixed(1));
    console.log('ìµœì¢… ë¹Œë“œì—… ì ìˆ˜:', finalScore.toFixed(1));
    
    // ìŠ¤íƒ€ì¼ ê²°ì •
    let style = 'direct';
    let description = 'ë‹¤ì´ë ‰íŠ¸ í”Œë ˆì´';
    
    if (possession >= 55 && passSuccessRate >= 0.8) {
        style = 'possession';
        description = 'í‹°í‚¤íƒ€ì¹´';
    } else if (possession >= 45 && passSuccessRate >= 0.7) {
        style = 'balanced';
        description = 'ê· í˜• ë¹Œë“œì—…';
    } else if (possession >= 60) {
        style = 'possession';
        description = 'ë³¼ ì ìœ í˜•';
    }
    
    return {
        score: Math.round(Math.min(Math.max(finalScore, 0), 100)),
        style: style,
        description: description,
        // ë””ë²„ê¹…ìš© ìƒì„¸ ì •ë³´
        details: {
            totalPassAttempts,
            totalPassSuccess,
            passSuccessRate: Math.round(passSuccessRate * 100),
            possession,
            passSuccessScore: Math.round(passSuccessScore),
            possessionScore: Math.round(possessionScore),
            passActivityScore: Math.round(passActivityScore)
        }
    };
}

// ì ìœ ìœ¨ í™œìš©ë„ ê³„ì‚°
function calculatePossessionUtilization(userStats, opponentStats) {
    const possessionShare = userStats.possession || 50;
    const shootTotal = userStats.shoot?.shootTotal || 0;
    const goalTotal = userStats.shoot?.goalTotal || 0;
    const effectiveShootTotal = userStats.shoot?.effectiveShootTotal || 0;
    
    console.log('ì ìœ ìœ¨ í™œìš© ê³„ì‚° ë°ì´í„°:', {
        possessionShare,
        shootTotal,
        goalTotal,
        effectiveShootTotal
    });
    
    // 1. ì ìœ ìœ¨ ì ìˆ˜ (0-40ì ) - ì ìœ ìœ¨ ìì²´ì˜ ê°€ì¹˜
    const possessionScore = Math.min((possessionShare / 60) * 40, 40);
    
    // 2. ê³µê²© íš¨ìœ¨ì„± ì ìˆ˜ (0-35ì ) - ìŠ›ë‹¹ ê³¨ ë¹„ìœ¨
    const shootingEfficiency = shootTotal > 0 ? (goalTotal / shootTotal) * 35 : 0;
    
    // 3. ê³µê²© ë¹ˆë„ ì ìˆ˜ (0-25ì ) - ì ìœ ìœ¨ ëŒ€ë¹„ ìŠ› ë¹ˆë„
    // ì ìœ ìœ¨ì´ ë†’ì„ìˆ˜ë¡ ë” ë§ì€ ìŠ›ì„ ì‹œë„í•´ì•¼ íš¨ìœ¨ì 
    const expectedShots = possessionShare * 0.8; // ì ìœ ìœ¨ 1%ë‹¹ 0.8ìŠ› ê¸°ëŒ€
    const shotFrequency = expectedShots > 0 ? Math.min((shootTotal / expectedShots) * 25, 25) : 0;
    
    // NaN ë°©ì§€
    const validPossessionScore = isNaN(possessionScore) ? 0 : possessionScore;
    const validShootingEfficiency = isNaN(shootingEfficiency) ? 0 : shootingEfficiency;
    const validShotFrequency = isNaN(shotFrequency) ? 0 : shotFrequency;
    
    const finalScore = validPossessionScore + validShootingEfficiency + validShotFrequency;
    
    console.log('ì ìœ ìœ¨ í™œìš© ì„¸ë¶€ ê³„ì‚°:', {
        possessionScore: validPossessionScore,
        shootingEfficiency: validShootingEfficiency,
        shotFrequency: validShotFrequency,
        finalScore
    });
    
    return {
        score: Math.min(Math.round(Math.max(finalScore, 0)), 100), // 0-100 ë²”ìœ„ë¡œ ì œí•œ
        efficiency: possessionShare > 55 ? 'controller' : possessionShare > 45 ? 'balanced' : 'counter',
        description: possessionShare > 55 ? 'ë³¼ ì»¨íŠ¸ë¡¤ëŸ¬' : possessionShare > 45 ? 'ê· í˜• ì¡íŒ' : 'ì¹´ìš´í„° ì–´íƒì»¤'
    };
}

// ìˆ˜ë¹„ ê°•ë„ ê³„ì‚°
function calculateDefensiveIntensity(userStats, opponentStats) {
    if (!userStats.defence) {
        return { score: 50, style: 'passive', description: 'ì•ˆì •ì  ìˆ˜ë¹„' };
    }
    
    // ì•ˆì „í•œ ê°’ ì¶”ì¶œ (ì‹¤ì œ API í•„ë“œëª…ì— ë§ê²Œ)
    const tackleTry = userStats.defence.tackleTry || 0;
    const tackleSuccess = userStats.defence.tackleSuccess || 0;
    const blockTry = userStats.defence.blockTry || 0;
    const blockSuccess = userStats.defence.blockSuccess || 0;
    const opponentPossession = opponentStats?.possession || 50;
    
    // tackleTryê°€ 0ì´ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
    if (tackleTry === 0 && blockTry === 0) {
        return { score: 50, style: 'passive', description: 'ì•ˆì •ì  ìˆ˜ë¹„' };
    }
    
    // NaN ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „í•œ ê³„ì‚°
    const tackleSuccessRate = tackleTry > 0 ? tackleSuccess / tackleTry : 0;
    const blockSuccessRate = blockTry > 0 ? blockSuccess / blockTry : 0;
    const totalDefensiveActions = tackleTry + blockTry;
    const pressureRate = opponentPossession > 0 ? totalDefensiveActions / opponentPossession : 0;
    
    // ëª¨ë“  ê°’ì´ ìœ íš¨í•œ ìˆ«ìì¸ì§€ í™•ì¸
    const validTackleSuccessRate = isNaN(tackleSuccessRate) ? 0 : tackleSuccessRate;
    const validBlockSuccessRate = isNaN(blockSuccessRate) ? 0 : blockSuccessRate;
    const validPressureRate = isNaN(pressureRate) ? 0 : pressureRate;
    
    // ìˆ˜ë¹„ ê°•ë„ ê³„ì‚° (íƒœí´ ì„±ê³µë¥  + ë¸”ë¡ ì„±ê³µë¥  + ì••ë°• ë¹ˆë„)
    const combinedSuccessRate = (validTackleSuccessRate + validBlockSuccessRate) / 2;
    const intensity = (combinedSuccessRate * 0.7 + validPressureRate * 0.3) * 100;
    const finalScore = isNaN(intensity) ? 50 : intensity;
    
    return {
        score: Math.round(Math.min(Math.max(finalScore, 0), 100)), // 0-100 ë²”ìœ„ë¡œ ì œí•œ
        style: finalScore > 70 ? 'aggressive' : finalScore > 40 ? 'active' : 'passive',
        description: finalScore > 70 ? 'ê°•ë ¥í•œ ì••ë°•' : finalScore > 40 ? 'ì ê·¹ì  ìˆ˜ë¹„' : 'ì•ˆì •ì  ìˆ˜ë¹„'
    };
}

// ê³¨ ë‹¤ì–‘ì„± ê³„ì‚°
function calculateGoalVariety(userStats) {
    const totalGoals = userStats.shoot?.goalTotal || 0;
    if (totalGoals === 0) return { score: 0, variety: 'none', description: 'ë¬´ë“ì ' };
    
    // ì•ˆì „í•œ ê°’ ì¶”ì¶œ
    const insideBox = userStats.shoot.goalInPenalty || 0;
    const outsideBox = userStats.shoot.goalOutPenalty || 0;
    const freeKick = userStats.shoot.goalFreeKick || 0;
    const penalty = userStats.shoot.goalPenaltyKick || 0;
    
    const varietyTypes = [insideBox > 0, outsideBox > 0, freeKick > 0, penalty > 0].filter(Boolean).length;
    const varietyScore = varietyTypes > 0 ? (varietyTypes / 4) * 100 : 0;
    const finalScore = isNaN(varietyScore) ? 0 : varietyScore;
    
    return {
        score: Math.round(Math.min(Math.max(finalScore, 0), 100)), // 0-100 ë²”ìœ„ë¡œ ì œí•œ
        variety: varietyTypes >= 3 ? 'versatile' : varietyTypes >= 2 ? 'varied' : 'specialized',
        description: varietyTypes >= 3 ? 'ë§ŒëŠ¥ ë“ì ì™•' : varietyTypes >= 2 ? 'ë‹¤ì±„ë¡œìš´ ê³µê²©' : 'íŠ¹í™”ëœ ë§ˆë¬´ë¦¬'
    };
}

// ì¢…í•© ê²½ê¸° ì„±í–¥ ë¶„ì„
function analyzeMatchCharacteristics(userStats, opponentStats, formation) {
    const attack = calculateAttackEfficiency(userStats);
    const buildup = calculateBuildupStyle(userStats);
    const possession = calculatePossessionUtilization(userStats, opponentStats);
    const defense = calculateDefensiveIntensity(userStats, opponentStats);
    const goalVariety = calculateGoalVariety(userStats);
    
    // ì£¼ìš” íŠ¹ì„± ê²°ì • - ì ìˆ˜ ê¸°ë°˜ ìš°ì„ ìˆœìœ„ ì„ íƒ
    const characteristicCandidates = [];
    
    // ê° íŠ¹ì„±ë³„ ì ìˆ˜ ê³„ì‚°
    if (attack.level === 'excellent' && attack.score >= 80) {
        characteristicCandidates.push({ name: 'ğŸ¯ ì •ë°€ ìŠ¤ë‚˜ì´í¼', score: attack.score });
    }
    if (buildup.style === 'possession' && buildup.score >= 75) {
        characteristicCandidates.push({ name: 'ğŸ¨ í‹°í‚¤íƒ€ì¹´ ë§ˆì—ìŠ¤íŠ¸ë¡œ', score: buildup.score });
    }
    if (possession.efficiency === 'counter' && possession.score >= 70 && attack.score >= 60) {
        characteristicCandidates.push({ name: 'âš¡ ë²ˆê°œ ì¹´ìš´í„°', score: (possession.score + attack.score) / 2 });
    }
    if (defense.style === 'aggressive' && defense.score >= 80) {
        characteristicCandidates.push({ name: 'ğŸ›¡ï¸ ì² ë²½ ìˆ˜ë¹„', score: defense.score });
    }
    if (goalVariety.variety === 'versatile' && attack.score >= 70) {
        characteristicCandidates.push({ name: 'ğŸŒŸ ë§ŒëŠ¥ ë“ì ë¨¸ì‹ ', score: attack.score + 10 });
    }
    if (buildup.score >= 60 && possession.score >= 60) {
        characteristicCandidates.push({ name: 'ğŸ­ ì°½ì¡°ì  í”Œë ˆì´ë©”ì´ì»¤', score: (buildup.score + possession.score) / 2 });
    }
    if (defense.score >= 60 && buildup.score >= 50) {
        characteristicCandidates.push({ name: 'ğŸ›¡ï¸ ì•ˆì •ì  ìˆ˜ë¹„', score: (defense.score + buildup.score) / 2 });
    }
    
    // ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ íŠ¹ì„±ë§Œ ì„ íƒ (ìµœëŒ€ 2ê°œ)
    const characteristics = characteristicCandidates
        .sort((a, b) => b.score - a.score)
        .slice(0, 2)
        .map(char => char.name);
    
    // ê¸°ë³¸ íŠ¹ì„±ì´ ì—†ìœ¼ë©´ í¬ë©”ì´ì…˜ ê¸°ë°˜ìœ¼ë¡œ ì¶”ê°€
    if (characteristics.length === 0) {
        const formationChar = getFormationBasedCharacteristic(formation);
        if (formationChar) characteristics.push(formationChar);
    }
    
    // ìµœì†Œ 1ê°œëŠ” ë³´ì¥
    if (characteristics.length === 0) {
        characteristics.push('âš–ï¸ ê· í˜• ì¡íŒ í”Œë ˆì´');
    }
    
    return {
        primaryCharacteristics: characteristics.slice(0, 2),
        scores: { attack, buildup, possession, defense, goalVariety },
        overallStyle: determineOverallStyle(attack, buildup, possession, defense),
        tacticalRecommendation: generateTacticalAdvice(attack, buildup, possession, defense)
    };
}

// í¬ë©”ì´ì…˜ ê¸°ë°˜ íŠ¹ì„±
function getFormationBasedCharacteristic(formation) {
    const formationMap = {
        '4-4-2': 'ğŸ›ï¸ í´ë˜ì‹ ì „ìˆ ',
        '4-3-3': 'ğŸ”¥ í˜„ëŒ€ì  ê³µê²©',
        '3-5-2': 'ğŸª ìœ™ë°± í™œìš©',
        '4-5-1': 'ğŸ›¡ï¸ ë¯¸ë“œí•„ë“œ ì¥ì•…',
        '5-3-2': 'ğŸ° ìˆ˜ë¹„ ì¤‘ì‹œ',
        '4-2-2-1-1': 'âš¡ FCì˜¨ë¼ì¸ ì „ìˆ '
    };
    return formationMap[formation] || 'âš–ï¸ ê· í˜• ì¡íŒ í”Œë ˆì´';
}

// ì „ì²´ì ì¸ ìŠ¤íƒ€ì¼ ê²°ì •
function determineOverallStyle(attack, buildup, possession, defense) {
    if (attack.level === 'excellent' && buildup.style === 'possession') {
        return 'ì ìœ ìœ¨ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì²´ê³„ì ì¸ ê³µê²©ìœ¼ë¡œ ë†’ì€ íš¨ìœ¨ì„±ì„ ë³´ì—¬ì¤€ ê²½ê¸°';
    } else if (possession.efficiency === 'counter' && defense.style === 'aggressive') {
        return 'íƒ„íƒ„í•œ ìˆ˜ë¹„ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ íš¨ê³¼ì ì¸ ì—­ìŠµ í”Œë ˆì´';
    } else if (buildup.style === 'possession' && possession.efficiency === 'controller') {
        return 'ë³¼ ì†Œìœ ë¥¼ í†µí•œ ê²½ê¸° ì£¼ë„ê¶Œ í™•ë³´ë¡œ ì•ˆì •ì ì¸ ê²½ê¸° ìš´ì˜';
    } else if (attack.score > 70 && possession.efficiency !== 'controller') {
        return 'ê¸°íšŒë¥¼ ë†“ì¹˜ì§€ ì•ŠëŠ” ì˜ˆë¦¬í•œ ë§ˆë¬´ë¦¬ê°€ ë‹ë³´ì¸ ê²½ê¸°';
    } else {
        return 'ê³µìˆ˜ ë°¸ëŸ°ìŠ¤ê°€ ë›°ì–´ë‚œ ì™„ì„±ë„ ë†’ì€ ê²½ê¸° ìš´ì˜';
    }
}

// ì „ìˆ ì  ì¡°ì–¸ ìƒì„±
function generateTacticalAdvice(attack, buildup, possession, defense) {
    if (attack.score < 50 && buildup.score > 70) {
        return 'ì¢‹ì€ ë¹Œë“œì—…ì— ë¹„í•´ ë§ˆë¬´ë¦¬ê°€ ì•„ì‰¬ìš°ë‹ˆ ê³¨ ê²°ì •ë ¥ í–¥ìƒì´ í•„ìš”í•©ë‹ˆë‹¤.';
    } else if (defense.score < 50 && possession.score > 70) {
        return 'ê³µê²©ì— ì§‘ì¤‘í•˜ë˜ ìˆ˜ë¹„ ì•ˆì •ì„±ì„ ë†’ì´ë©´ ë” ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    } else if (attack.score > 70 && defense.score > 70) {
        return 'ê³µìˆ˜ ë°¸ëŸ°ìŠ¤ê°€ í›Œë¥­í•©ë‹ˆë‹¤. ì´ í”Œë ˆì´ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•´ë³´ì„¸ìš”.';
    } else {
        return 'ê° ì˜ì—­ë³„ë¡œ ì¡°ê¸ˆì”© ê°œì„ í•˜ë©´ ë” ì™„ì„±ë„ ë†’ì€ ê²½ê¸°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    }
}

// ì„±ëŠ¥ ì§€í‘œ ê¸°ë°˜ ê²½ê¸° íŠ¹ì§• ë©˜íŠ¸ ìƒì„±
function generatePerformanceBasedDescription(scores) {
    const { attack, buildup, possession, defense } = scores;
    
    // í‰ê·  ì ìˆ˜ ê³„ì‚°
    const avgScore = (attack.score + buildup.score + possession.score + defense.score) / 4;
    
    // ìµœê³ /ìµœì € ì ìˆ˜ ì°¾ê¸°
    const allScores = [
        { name: 'ê³µê²©ë ¥', score: attack.score },
        { name: 'ë¹Œë“œì—…', score: buildup.score },
        { name: 'ì ìœ ìœ¨ í™œìš©', score: possession.score },
        { name: 'ìˆ˜ë¹„ ê°•ë„', score: defense.score }
    ];
    
    const maxScore = Math.max(...allScores.map(s => s.score));
    const minScore = Math.min(...allScores.map(s => s.score));
    const strongest = allScores.find(s => s.score === maxScore);
    const weakest = allScores.find(s => s.score === minScore);
    
    // ì „ì²´ì ì¸ ì„±ëŠ¥ ìˆ˜ì¤€ íŒë‹¨
    let performanceLevel = '';
    let description = '';
    
    if (avgScore >= 80) {
        performanceLevel = 'ì™„ë²½í•œ';
        description = 'ëª¨ë“  ì˜ì—­ì—ì„œ ë›°ì–´ë‚œ ì™„ì„±ë„ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²½ê¸°ì…ë‹ˆë‹¤.';
    } else if (avgScore >= 65) {
        performanceLevel = 'ìš°ìˆ˜í•œ';
        description = 'ëŒ€ë¶€ë¶„ì˜ ì˜ì—­ì—ì„œ ì•ˆì •ì ì¸ ê²½ê¸° ìš´ì˜ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.';
    } else if (avgScore >= 50) {
        performanceLevel = 'ê· í˜• ì¡íŒ';
        description = 'ê³µìˆ˜ ë°¸ëŸ°ìŠ¤ê°€ ì˜ ë§ì¶°ì§„ ê²½ê¸°ì…ë‹ˆë‹¤.';
    } else if (avgScore >= 35) {
        performanceLevel = 'ë°œì „ ê°€ëŠ¥í•œ';
        description = 'ëª‡ ê°€ì§€ ì˜ì—­ì—ì„œ ê°œì„ ì´ í•„ìš”í•œ ê²½ê¸°ì…ë‹ˆë‹¤.';
    } else {
        performanceLevel = 'ë³´ì™„ì´ í•„ìš”í•œ';
        description = 'ì „ë°˜ì ì¸ ê²½ê¸° ìš´ì˜ì—ì„œ ê°œì„ ì´ ìš”êµ¬ë©ë‹ˆë‹¤.';
    }
    
    // ê°•ì ê³¼ ì•½ì  ê¸°ë°˜ ì¶”ê°€ ì„¤ëª…
    let additionalNote = '';
    
    if (maxScore - minScore <= 15) {
        additionalNote = 'ëª¨ë“  ì˜ì—­ì´ ê³ ë¥´ê²Œ ë°œë‹¬ëœ ê· í˜•ì¡íŒ í”Œë ˆì´ë¥¼ ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.';
    } else if (strongest.score >= 70 && weakest.score <= 40) {
        additionalNote = `${strongest.name}ì´ ë›°ì–´ë‚˜ì§€ë§Œ ${weakest.name}ì—ì„œ ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
    } else if (strongest.score >= 60) {
        additionalNote = `${strongest.name}ì´ ì´ ê²½ê¸°ì˜ í•µì‹¬ ê°•ì ì´ì—ˆìŠµë‹ˆë‹¤.`;
    } else if (weakest.score <= 30) {
        additionalNote = `${weakest.name} ê°œì„ ì„ í†µí•´ ë” ë‚˜ì€ ê²½ê¸°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
    }
    
    return `${performanceLevel} ê²½ê¸° ìš´ì˜ìœ¼ë¡œ ${description} ${additionalNote}`;
}

// ì§€í‘œë³„ ì„¤ëª… ë°ì´í„°
function getMetricsInfo() {
    return {
        attack: {
            title: 'ê³µê²©ë ¥',
            description: 'ìŠ› ì •í™•ë„ì™€ ê³¨ ê²°ì •ë ¥ì„ ì¢…í•©í•œ ê³µê²© íš¨ìœ¨ì„±ì…ë‹ˆë‹¤.',
            calculation: 'ìŠ› ì •í™•ë„ 40% + ìœ íš¨ìŠ› ë¹„ìœ¨ 40% + ë°•ìŠ¤ ë‚´ ê³¨ ë¹„ìœ¨ 20%',
            example: 'ìŠ› 10íšŒ ì¤‘ 3ê³¨, ìœ íš¨ìŠ› 7íšŒ â†’ ë†’ì€ ê³µê²©ë ¥'
        },
        buildup: {
            title: 'ë¹Œë“œì—…',
            description: 'íŒ¨ìŠ¤ ì„±ê³µë¥ ê³¼ ì ìœ ìœ¨ì„ í™œìš©í•œ ê³µê²© ì „ê°œ ëŠ¥ë ¥ì…ë‹ˆë‹¤.',
            calculation: 'íŒ¨ìŠ¤ ì„±ê³µë¥  40ì  + ì ìœ ìœ¨ 40ì  + íŒ¨ìŠ¤ í™œë™ë„ 20ì ',
            example: 'íŒ¨ìŠ¤ 92íšŒ ì¤‘ 83íšŒ ì„±ê³µ, ì ìœ ìœ¨ 46% â†’ ì¤‘ê°„ ë¹Œë“œì—…'
        },
        possession: {
            title: 'ì ìœ ìœ¨ í™œìš©',
            description: 'ì ìœ ìœ¨ì„ ì–¼ë§ˆë‚˜ íš¨ê³¼ì ìœ¼ë¡œ ê³µê²©ìœ¼ë¡œ ì—°ê²°í–ˆëŠ”ì§€ ì¸¡ì •í•©ë‹ˆë‹¤.',
            calculation: 'ì ìœ ìœ¨ ê°€ì¹˜ 40ì  + ìŠ› íš¨ìœ¨ì„± 35ì  + ê³µê²© ë¹ˆë„ 25ì ',
            example: 'ì ìœ ìœ¨ 46%, ìŠ› 3íšŒ ì¤‘ 2ê³¨ â†’ ë³´í†µ ì ìœ ìœ¨ í™œìš©'
        },
        defense: {
            title: 'ìˆ˜ë¹„ ê°•ë„',
            description: 'íƒœí´ê³¼ ë¸”ë¡ ì„±ê³µë¥ , ê·¸ë¦¬ê³  ì••ë°• ë¹ˆë„ë¥¼ ì¢…í•©í•œ ìˆ˜ë¹„ ëŠ¥ë ¥ì…ë‹ˆë‹¤.',
            calculation: 'ìˆ˜ë¹„ ì„±ê³µë¥  70% + ì••ë°• ë¹ˆë„ 30%',
            example: 'íƒœí´ 11íšŒ ì¤‘ 9íšŒ ì„±ê³µ, ë¸”ë¡ 3íšŒ â†’ ë†’ì€ ìˆ˜ë¹„ ê°•ë„'
        }
    };
}

// ê²½ê¸° ì„±í–¥ ê°€ì´ë“œ ë°ì´í„°
function getTacticsGuide() {
    return {
        precision_striker: {
            name: 'ì •ë°€ ìŠ¤ë‚˜ì´í¼',
            description: 'ì •í™•í•œ ìŠˆíŒ…ê³¼ ê²°ì •ë ¥ìœ¼ë¡œ ê³¨ì„ ë…¸ë¦¬ëŠ” ê³µê²© ì¤‘ì‹¬ ìŠ¤íƒ€ì¼',
            features: 'ë†’ì€ ìŠˆíŒ… ì •í™•ë„, ë°•ìŠ¤ ë‚´ ê²°ì •ë ¥, ê³¨ ê²°ì •ë ¥, íš¨ìœ¨ì ì¸ ê³µê²©'
        },
        tiki_taka: {
            name: 'í‹°í‚¤íƒ€ì¹´ ë§ˆì—ìŠ¤íŠ¸ë¡œ',
            description: 'ì§§ì€ íŒ¨ìŠ¤ì™€ ì ìœ ìœ¨ì„ í†µí•œ ê³µê²© ì „ê°œ ìŠ¤íƒ€ì¼',
            features: 'ë†’ì€ íŒ¨ìŠ¤ ì„±ê³µë¥ , ì ìœ ìœ¨ í™œìš©, ê³µê²© ì „ê°œ, ìƒëŒ€ ì••ë°•'
        },
        lightning_counter: {
            name: 'ë²ˆê°œ ì¹´ìš´í„°',
            description: 'ë¹ ë¥¸ ì „í™˜ê³¼ ì—­ìŠµì„ í†µí•œ ê³µê²© ìŠ¤íƒ€ì¼',
            features: 'ë¹ ë¥¸ ì „í™˜, ì—­ìŠµ ê³µê²©, ìƒëŒ€ ì‹¤ìˆ˜ í™œìš©, íš¨ìœ¨ì ì¸ ë“ì '
        },
        iron_defense: {
            name: 'ì² ë²½ ìˆ˜ë¹„',
            description: 'ê°•ë ¥í•œ ìˆ˜ë¹„ë ¥ìœ¼ë¡œ ìƒëŒ€ ê³µê²©ì„ ì°¨ë‹¨í•˜ëŠ” ìŠ¤íƒ€ì¼',
            features: 'ê°•ë ¥í•œ ìˆ˜ë¹„, íƒœí´ ì„±ê³µë¥ , ì••ë°• ê°•ë„, ìƒëŒ€ ê³µê²© ì°¨ë‹¨'
        },
        scoring_machine: {
            name: 'ë§ŒëŠ¥ ë“ì  ë¨¸ì‹ ',
            description: 'ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ê³¨ì„ ë„£ëŠ” ê³µê²©ì  ìŠ¤íƒ€ì¼',
            features: 'ë‹¤ì–‘í•œ ë“ì  ë°©ë²•, ë†’ì€ ê³µê²© ë¹ˆë„, ê³¨ ê²°ì •ë ¥, ê³µê²© ì°½ì˜ì„±'
        },
        possession_control: {
            name: 'ì ìœ ìœ¨ ì œì–´',
            description: 'ê³µì„ ì˜¤ë˜ ê°€ì§€ê³  ê²½ê¸°ë¥¼ í†µì œí•˜ëŠ” ìŠ¤íƒ€ì¼',
            features: 'ë†’ì€ ì ìœ ìœ¨, ì•ˆì •ì ì¸ íŒ¨ìŠ¤, ê²½ê¸° í†µì œ, ìƒëŒ€ ì••ë°•'
        },
        high_pressure: {
            name: 'ê³ ì•• ì••ë°•',
            description: 'ìƒëŒ€ë¥¼ ê°•í•˜ê²Œ ì••ë°•í•˜ì—¬ ì‹¤ìˆ˜ë¥¼ ìœ ë„í•˜ëŠ” ìŠ¤íƒ€ì¼',
            features: 'ë†’ì€ ì••ë°• ê°•ë„, ìƒëŒ€ ì‹¤ìˆ˜ ìœ ë„, ë¹ ë¥¸ ë³¼ íšŒìˆ˜, ê³µê²© ê¸°íšŒ í™•ëŒ€'
        },
        wing_play: {
            name: 'ìœ™ í”Œë ˆì´',
            description: 'ì¸¡ë©´ì„ í™œìš©í•œ ê³µê²© ì „ê°œ ìŠ¤íƒ€ì¼',
            features: 'ìœ™ë°± í™œìš©, í¬ë¡œìŠ¤ ê³µê²©, ì¸¡ë©´ ëŒíŒŒ, ê³µê²© í­ í™•ëŒ€'
        },
        long_ball: {
            name: 'ë¡±ë³¼ ì „ìˆ ',
            description: 'ê¸´ íŒ¨ìŠ¤ì™€ ê³µì¤‘ë³¼ì„ í™œìš©í•œ ì§ì ‘ì ì¸ ê³µê²© ìŠ¤íƒ€ì¼',
            features: 'ê¸´ íŒ¨ìŠ¤, ê³µì¤‘ë³¼ í™œìš©, ì§ì ‘ì ì¸ ê³µê²©, ë¹ ë¥¸ ì „í™˜'
        },
        possession_attack: {
            name: 'ì ìœ ìœ¨ ê³µê²©',
            description: 'ì ìœ ìœ¨ì„ ê³µê²©ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” ìŠ¤íƒ€ì¼',
            features: 'ì ìœ ìœ¨ í™œìš©, ê³µê²© ì „ê°œ, ìŠˆíŒ… íš¨ìœ¨ì„±, ê³µê²© ë¹ˆë„'
        },
        defensive_counter: {
            name: 'ìˆ˜ë¹„ ì¹´ìš´í„°',
            description: 'ìˆ˜ë¹„ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì—­ìŠµ ê³µê²© ìŠ¤íƒ€ì¼',
            features: 'ì•ˆì •ì ì¸ ìˆ˜ë¹„, ì—­ìŠµ ê¸°íšŒ, íš¨ìœ¨ì ì¸ ê³µê²©, ê²½ê¸° í†µì œ'
        },
        all_out_attack: {
            name: 'ì˜¬ì•„ì›ƒ ì–´íƒ',
            description: 'ëª¨ë“  ì„ ìˆ˜ë¥¼ ê³µê²©ì— íˆ¬ì…í•˜ëŠ” ê³µê²©ì  ìŠ¤íƒ€ì¼',
            features: 'ë†’ì€ ê³µê²© ë¹ˆë„, ë§ì€ ìŠˆíŒ…, ìƒëŒ€ ìˆ˜ë¹„ ì••ë°•, ê³¨ ê¸°íšŒ í™•ëŒ€'
        },
        balanced_play: {
            name: 'ê· í˜• ì¡íŒ í”Œë ˆì´',
            description: 'ê³µê²©ê³¼ ìˆ˜ë¹„ì˜ ê· í˜•ì„ ë§ì¶˜ ì•ˆì •ì ì¸ ìŠ¤íƒ€ì¼',
            features: 'ì•ˆì •ì ì¸ ê²½ê¸° ìš´ì˜, ìƒí™© ì ì‘ë ¥, ê· í˜•ì¡íŒ ì „ìˆ , ë‹¤ì–‘í•œ í”Œë ˆì´'
        },
        classic_tactics: {
            name: 'í´ë˜ì‹ ì „ìˆ ',
            description: 'ì „í†µì ì¸ 4-4-2 í¬ë©”ì´ì…˜ì„ í™œìš©í•œ ê· í˜•ì¡íŒ ì „ìˆ ',
            features: 'ì•ˆì •ì ì¸ ìˆ˜ë¹„ë¼ì¸, ì¤‘ì› ì¥ì•…, ì–‘ìª½ ìœ™ í™œìš©, íˆ¬í†± ê³µê²©'
        },
        modern_attack: {
            name: 'í˜„ëŒ€ì  ê³µê²©',
            description: '4-3-3 í¬ë©”ì´ì…˜ ê¸°ë°˜ì˜ ê³µê²©ì ì´ê³  í˜„ëŒ€ì ì¸ ì „ìˆ ',
            features: 'ë†’ì€ ë¼ì¸, ì••ë°• ì¶•êµ¬, ìœ™ì–´ í™œìš©, ë‹¤ì–‘í•œ ê³µê²© ë£¨íŠ¸'
        },
        wingback_utilization: {
            name: 'ìœ™ë°± í™œìš©',
            description: '3-5-2 í¬ë©”ì´ì…˜ìœ¼ë¡œ ìœ™ë°±ì˜ ì˜¤ë²„ë˜í•‘ì„ ê·¹ëŒ€í™”í•˜ëŠ” ì „ìˆ ',
            features: 'ìœ™ë°± ì˜¤ë²„ë˜í•‘, ì¤‘ì•™ ìˆ˜ë¹„ ì•ˆì •ì„±, ë¯¸ë“œí•„ë“œ ìˆ˜ì  ìš°ìœ„, í¬ë¡œìŠ¤ ê³µê²©'
        },
        midfield_dominance: {
            name: 'ë¯¸ë“œí•„ë“œ ì¥ì•…',
            description: '4-5-1 í¬ë©”ì´ì…˜ìœ¼ë¡œ ì¤‘ì›ì„ ì¥ì•…í•˜ëŠ” ìˆ˜ë¹„ì  ì „ìˆ ',
            features: 'ì¤‘ì› ìˆ˜ì  ìš°ìœ„, ë³¼ ì†Œìœ ê¶Œ í™•ë³´, ì•ˆì •ì ì¸ ìˆ˜ë¹„, ì¹´ìš´í„° ì–´íƒ'
        },
        defensive_focus: {
            name: 'ìˆ˜ë¹„ ì¤‘ì‹œ',
            description: '5-3-2 í¬ë©”ì´ì…˜ìœ¼ë¡œ ìˆ˜ë¹„ ì•ˆì •ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ í•˜ëŠ” ì „ìˆ ',
            features: 'ê²¬ê³ í•œ ìˆ˜ë¹„ë¼ì¸, ìˆ˜ë¹„ ì•ˆì •ì„±, ì„¸íŠ¸í”¼ìŠ¤ ëŒ€ì‘, ì—­ìŠµ ê¸°íšŒ'
        },
        fc_online_tactics: {
            name: 'FCì˜¨ë¼ì¸ ì „ìˆ ',
            description: 'FCì˜¨ë¼ì¸ì— íŠ¹í™”ëœ 4-2-2-1-1 í¬ë©”ì´ì…˜ ì „ìˆ ',
            features: 'CAM í™œìš©, ì¤‘ê±°ë¦¬ ìŠˆíŒ…, íŒ¨ìŠ¤ í”Œë ˆì´, ê²Œì„ íŠ¹í™” ì „ìˆ '
        }
    };
}

// ì§€í‘œ ì„¤ëª… íŒì—… í‘œì‹œ
function showMetricsPopup() {
    const metrics = getMetricsInfo();
    const tacticsGuide = getTacticsGuide();
    
    const popupHTML = `
        <div class="metrics-popup-overlay" onclick="hideMetricsPopup()">
            <div class="metrics-popup" onclick="event.stopPropagation()">
                <div class="popup-header">
                    <h3>ê²½ê¸° ì •ë³´ ê°€ì´ë“œ</h3>
                    <button class="popup-close" onclick="hideMetricsPopup()">Ã—</button>
                </div>
                <div class="popup-content">
                    <!-- ê²½ê¸° ì„±í–¥ ê°€ì´ë“œ -->
                    <div class="guide-section">
                        <h4 class="guide-title">ğŸ¯ ê²½ê¸° ì„±í–¥ ê°€ì´ë“œ</h4>
                        <div class="tactics-guide">
                            ${Object.values(tacticsGuide).map(tactic => `
                                <div class="tactic-item">
                                    <div class="tactic-name">${tactic.name}</div>
                                    <div class="tactic-desc">${tactic.description}</div>
                                    <div class="tactic-features">
                                        <strong>íŠ¹ì§•:</strong> ${tactic.features}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- ê²½ê¸° ì§€í‘œ ì„¤ëª… -->
                    <div class="guide-section">
                        <h4 class="guide-title">ğŸ“Š ê²½ê¸° ì§€í‘œ ì„¤ëª…</h4>
                        ${Object.values(metrics).map(metric => `
                            <div class="metric-explanation">
                                <h5>${metric.title}</h5>
                                <p class="metric-desc">${metric.description}</p>
                                <div class="calculation-box">
                                    <strong>ê³„ì‚° ë°©ì‹:</strong> ${metric.calculation}
                                </div>
                                <div class="example-box">
                                    <strong>ì˜ˆì‹œ:</strong> ${metric.example}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', popupHTML);
    
    // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
    setTimeout(() => {
        const popup = document.querySelector('.metrics-popup-overlay');
        if (popup) popup.classList.add('show');
    }, 10);
}

// ì§€í‘œ ì„¤ëª… íŒì—… ìˆ¨ê¸°ê¸°
function hideMetricsPopup() {
    const overlay = document.querySelector('.metrics-popup-overlay');
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            overlay.remove();
        }, 300);
    }
}

// ê²½ê¸° ì„±í–¥ ì‹œê°í™” HTML ìƒì„±

// ì „ìˆ  ì •ë³´ ìƒì„± (ì‹¤ì œ ì„ ìˆ˜ ë°ì´í„° ê¸°ë°˜)
function generateTacticsInfo(userPlayers, userStats = {}, opponentStats = {}) {
    // ì‹¤ì œ í¬ë©”ì´ì…˜ ê³„ì‚°
    const formation = calculateFormationFromPlayers(userPlayers);
    
    // ìƒˆë¡œìš´ ê²½ê¸° ì„±í–¥ ë¶„ì„ (ê³µì‹ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°)
    let characteristics = null;
    let style = 'ê· í˜•';
    let message = 'ê· í˜•ì¡íŒ ì „ìˆ ë¡œ ê²½ê¸°ë¥¼ ì£¼ë„í–ˆë‹¤!';
    
    if (userStats && Object.keys(userStats).length > 0) {
        // ê³µì‹ ë°ì´í„° ê¸°ë°˜ ë¶„ì„
        characteristics = analyzeMatchCharacteristics(userStats, opponentStats, formation);
        style = characteristics.primaryCharacteristics[0] || 'âš–ï¸ ê· í˜• ì¡íŒ í”Œë ˆì´';
        message = characteristics.overallStyle;
    } else {
        // ê¸°ì¡´ í¬ë©”ì´ì…˜ ê¸°ë°˜ ë¶„ì„ (fallback)
        const startingPlayers = (userPlayers || []).filter(player => {
            const positionGroup = getPositionGroup(player.spPosition);
            return positionGroup !== 'OTHER' && positionGroup !== 'SUB';
        });
        
        const fieldPlayers = startingPlayers.filter(player => getPositionGroup(player.spPosition) !== 'GK');
        const attackingPlayers = fieldPlayers.filter(player => {
            const group = getPositionGroup(player.spPosition);
            return group === 'AM' || group === 'FW';
        });
        
        if (fieldPlayers.length > 0) {
            const attackingRatio = attackingPlayers.length / fieldPlayers.length;
            if (attackingRatio > 0.6) {
                style = 'ê³µê²©ì ';
            } else if (attackingRatio < 0.4) {
                style = 'ìˆ˜ë¹„ì ';
            }
        }
        
        const messages = {
            'ê³µê²©ì ': [
                "ê³µê²©ì ì¸ í¬ë©”ì´ì…˜ìœ¼ë¡œ ìƒëŒ€ë¥¼ ì••ë„í–ˆë‹¤!",
                "ì´ ê³µê²© í¬ë©”ì´ì…˜ìœ¼ë¡œ ê²½ê¸°ë¥¼ ì£¼ë„í–ˆë‹¤!",
                "ê³µê²©ì ì¸ ìŠ¤íƒ€ì¼ë¡œ ì™„ë²½í•œ ê²½ê¸°ë¥¼ í–ˆë‹¤!"
            ],
            'ìˆ˜ë¹„ì ': [
                "ìˆ˜ë¹„ì ì¸ í¬ë©”ì´ì…˜ìœ¼ë¡œ ì•ˆì •ì ì¸ ê²½ê¸°ë¥¼ í–ˆë‹¤!",
                "ì´ ìˆ˜ë¹„ í¬ë©”ì´ì…˜ìœ¼ë¡œ ìƒëŒ€ë¥¼ ë§‰ì•„ëƒˆë‹¤!",
                "ìˆ˜ë¹„ì ì¸ ìŠ¤íƒ€ì¼ë¡œ ê²½ê¸°ë¥¼ í†µì œí–ˆë‹¤!"
            ],
            'ê· í˜•': [
                "ê· í˜•ì¡íŒ í¬ë©”ì´ì…˜ìœ¼ë¡œ ì™„ë²½í•œ ê²½ê¸°ë¥¼ í–ˆë‹¤!",
                "ì´ í¬ë©”ì´ì…˜ìœ¼ë¡œ ìƒëŒ€ë¥¼ ì••ë„í–ˆë‹¤!",
                "ê· í˜•ì¡íŒ ì „ìˆ ë¡œ ê²½ê¸°ë¥¼ ì£¼ë„í–ˆë‹¤!"
            ]
        };
        
        const messageList = messages[style];
        message = messageList[Math.floor(Math.random() * messageList.length)];
    }
    
    return { formation, style, message, characteristics };
}

// í¬ì§€ì…˜ ì´ë¦„ ë°˜í™˜
function getPositionName(position) {
    const positions = {
        0: 'GK',   // ê³¨í‚¤í¼
        1: 'SW',   // ìŠ¤ìœ„í¼
        2: 'RWB',   // ì„¼í„°ë°±
        3: 'RB',   // ë ˆí”„íŠ¸ë°±
        4: 'RCB',   // ë¼ì´íŠ¸ë°±
        5: 'CB',  // ë ˆí”„íŠ¸ ìœ™ë°±
        6: 'LCB',  // ë¼ì´íŠ¸ ìœ™ë°±
        7: 'LB',  // ìˆ˜ë¹„í˜• ë¯¸ë“œí•„ë”
        8: 'LWB',   // ì„¼í„° ë¯¸ë“œí•„ë”
        9: 'RDM',  // ê³µê²©í˜• ë¯¸ë“œí•„ë”
        10: 'CDM',  // ë ˆí”„íŠ¸ ë¯¸ë“œí•„ë”
        11: 'LDM',  // ë¼ì´íŠ¸ ë¯¸ë“œí•„ë”
        12: 'RM',  // ë ˆí”„íŠ¸ ìœ™
        13: 'RCM',  // ë¼ì´íŠ¸ ìœ™
        14: 'CM',  // ì„¼í„° í¬ì›Œë“œ
        15: 'LCM',  // ìŠ¤íŠ¸ë¼ì´ì»¤
        16: 'LM',  // ë ˆí”„íŠ¸ í¬ì›Œë“œ
        17: 'RAM',  // ë¼ì´íŠ¸ í¬ì›Œë“œ
        18: 'CAM',  // ë ˆí”„íŠ¸ ìŠ¤íŠ¸ë¼ì´ì»¤
        19: 'LAM',  // ë¼ì´íŠ¸ ìŠ¤íŠ¸ë¼ì´ì»¤
        20: 'RF', // êµì²´ ì„ ìˆ˜
        21: 'CF', // ë ˆí”„íŠ¸ ê³µê²©í˜• ë¯¸ë“œí•„ë”
        22: 'LF', // ë¼ì´íŠ¸ ê³µê²©í˜• ë¯¸ë“œí•„ë”
        23: 'RW',  // í¬ì›Œë“œ
        24: 'RS',  // í¬ì›Œë“œ
        25: 'ST',  // í¬ì›Œë“œ
        26: 'LS',  // í¬ì›Œë“œ
        27: 'LW',  // í¬ì›Œë“œ
        28: 'SUB'  // êµì²´ ì„ ìˆ˜
    };
    return positions[position] || `POS${position}`;
}

// ì„ ìˆ˜ í¬ì§€ì…˜ì„ ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¥˜í•˜ëŠ” í•¨ìˆ˜
function getPositionGroup(position) {
    const positionName = getPositionName(position);
    
    // ìˆ˜ë¹„ìˆ˜ (Defender) - 4-2-2-1-1ì—ì„œ LB, LCB, RCB, RB
    if (['CB', 'LB', 'RB', 'LCB', 'RCB', 'LWB', 'RWB', 'SW'].includes(positionName)) {
        return 'DF';
    }
    // ìˆ˜ë¹„í˜• ë¯¸ë“œí•„ë” (Defensive Midfielder) - 4-2-2-1-1ì—ì„œ LDM, RDM
    else if (['CDM', 'LDM', 'RDM'].includes(positionName)) {
        return 'DM';
    }
    // ê³µê²©í˜• ë¯¸ë“œí•„ë” (Attacking Midfielder) - 4-2-2-1-1ì—ì„œ LM, RM, CAM
    else if (['CM', 'LCM', 'RCM', 'LM', 'RM', 'CAM', 'LAM', 'RAM'].includes(positionName)) {
        return 'AM';
    }
    // ê³µê²©ìˆ˜ (Forward) - 4-2-2-1-1ì—ì„œ ST
    else if (['ST', 'CF', 'LF', 'RF', 'LS', 'RS', 'LW', 'RW'].includes(positionName)) {
        return 'FW';
    }
    // ê³¨í‚¤í¼
    else if (positionName === 'GK') {
        return 'GK';
    }
    // ì„œë¸Œ (êµì²´ ì„ ìˆ˜)
    else if (positionName === 'SUB') {
        return 'SUB';
    }
    // ê¸°íƒ€ (êµì²´ ì„ ìˆ˜ ë“±)
    else {
        return 'OTHER';
    }
}

// ì„ ìˆ˜ ì •ë ¬ í•¨ìˆ˜: í¬ì§€ì…˜ë³„ -> í‰ì ìˆœ, ì„œë¸Œ ì„ ìˆ˜ ì¤‘ í‰ì  0ì  ì œì™¸
function sortPlayersByPositionAndRating(players) {
    // 1. ì„œë¸Œ ì„ ìˆ˜ ì¤‘ í‰ì  0ì ì¸ ì„ ìˆ˜ ì œì™¸
    const filteredPlayers = players.filter(player => {
        const isSub = getPositionGroup(player.spPosition) === 'SUB';
        const rating = player.status?.spRating || 0;
        
        // ì„œë¸Œ ì„ ìˆ˜ì´ë©´ì„œ í‰ì ì´ 0ì ì¸ ê²½ìš° ì œì™¸
        if (isSub && rating === 0) {
            return false;
        }
        return true;
    });
    
    // 2. í¬ì§€ì…˜ ê·¸ë£¹ë³„ ìš°ì„ ìˆœìœ„ ì •ì˜
    const positionPriority = {
        'FW': 1,    // ê³µê²©ìˆ˜
        'AM': 2,    // ê³µê²©í˜• ë¯¸ë“œí•„ë”
        'DM': 3,    // ìˆ˜ë¹„í˜• ë¯¸ë“œí•„ë”
        'DF': 4,    // ìˆ˜ë¹„ìˆ˜
        'GK': 5,    // ê³¨í‚¤í¼
        'SUB': 6,   // ì„œë¸Œ
        'OTHER': 7  // ê¸°íƒ€
    };
    
    // 3. ì •ë ¬: í¬ì§€ì…˜ ê·¸ë£¹ë³„ -> í‰ì  ë†’ì€ ìˆœ
    return filteredPlayers.sort((a, b) => {
        const aGroup = getPositionGroup(a.spPosition);
        const bGroup = getPositionGroup(b.spPosition);
        const aRating = a.status?.spRating || 0;
        const bRating = b.status?.spRating || 0;
        
        // í¬ì§€ì…˜ ê·¸ë£¹ ìš°ì„ ìˆœìœ„ë¡œ ë¨¼ì € ì •ë ¬
        if (positionPriority[aGroup] !== positionPriority[bGroup]) {
            return positionPriority[aGroup] - positionPriority[bGroup];
        }
        
        // ê°™ì€ í¬ì§€ì…˜ ê·¸ë£¹ ë‚´ì—ì„œëŠ” í‰ì  ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
        return bRating - aRating;
    });
}

// ì„ ìˆ˜ ëª©ë¡ HTML ìƒì„±
function createPlayersHTML(players, team) {
    if (!players || players.length === 0) {
        return '<p class="no-players">ì„ ìˆ˜ ì •ë³´ ì—†ìŒ</p>';
    }
    
    // ì„ ìˆ˜ ì •ë ¬: í¬ì§€ì…˜ë³„ -> í‰ì ìˆœ, ì„œë¸Œ ì„ ìˆ˜ ì¤‘ í‰ì  0ì  ì œì™¸
    const sorted = sortPlayersByPositionAndRating(players);

    return sorted.map(player => {
        const position = player.spPositionDesc || getPositionName(player.spPosition);
        const seasonBadge = renderSeasonBadge(player.season);
        const rating = player.status.spRating || 0;
        const goals = player.status.goal || 0;
        const assists = player.status.assist || 0;
        const ratingClass = rating >= 7 ? 'high' : rating >= 6 ? 'medium' : 'low';
        
        return `
            <div class="player-card ${team}">
                <div class="player-header">
                    <span class="player-name">${player.spName}</span>
                    <span class="player-position">${position}</span>
                    ${seasonBadge}
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <span class="stat-label">í‰ì </span>
                        <span class="stat-value rating ${ratingClass}">${rating.toFixed(1)}</span>
                    </div>
                    ${goals > 0 ? `<div class="stat-item"><span class="stat-label">ê³¨</span><span class="stat-value goal">${goals}</span></div>` : ''}
                    ${assists > 0 ? `<div class="stat-item"><span class="stat-label">ë„ì›€</span><span class="stat-value assist">${assists}</span></div>` : ''}
                    <div class="stat-item">
                        <span class="stat-label">ìŠˆíŒ…</span>
                        <span class="stat-value">${player.status.shoot || 0}</span>
                    </div>
                </div>
                ${(player.status.yellowCard || player.status.redCard) ? `
                    <div class="player-cards">
                        ${player.status.yellowCard ? '<span class="yellow-card">âš ï¸</span>' : ''}
                        ${player.status.redCard ? '<span class="red-card">ğŸŸ¥</span>' : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// ì‹œì¦Œ ë±ƒì§€ ë Œë”ë§
function renderSeasonBadge(season) {
    if (!season) return '';
    const label = season.className || `Season ${season.seasonId || ''}`;
    const img = season.seasonImg ? `<img src="${season.seasonImg}" alt="${label}" class="season-img" onerror="this.style.display='none'"/>` : '';
    return `<span class="season-badge" title="${label}">${img}${label}</span>`;
}

// í¬ì§€ì…˜ë³„ ë¶„ì„ HTML ìƒì„±
function createPositionAnalysisHTML(players) {
    const positionStats = {
        'FW': { count: 0, totalRating: 0, goals: 0, assists: 0 },
        'AM': { count: 0, totalRating: 0, goals: 0, assists: 0 },
        'DM': { count: 0, totalRating: 0, goals: 0, assists: 0 },
        'DF': { count: 0, totalRating: 0, goals: 0, assists: 0 },
        'GK': { count: 0, totalRating: 0, goals: 0, assists: 0 },
        'SUB': { count: 0, totalRating: 0, goals: 0, assists: 0 }
    };
    
    // ì •ë ¬ëœ ì„ ìˆ˜ ëª©ë¡ ì‚¬ìš© (ì„œë¸Œ ì„ ìˆ˜ ì¤‘ í‰ì  0ì  ì œì™¸ëœ ëª©ë¡)
    const sortedPlayers = sortPlayersByPositionAndRating(players);
    
    sortedPlayers.forEach(player => {
        const group = getPositionGroup(player.spPosition);
        
        if (positionStats[group]) {
            positionStats[group].count++;
            positionStats[group].totalRating += player.status?.spRating || 0;
            positionStats[group].goals += player.status?.goal || 0;
            positionStats[group].assists += player.status?.assist || 0;
        }
    });
    
    // í¬ì§€ì…˜ ê·¸ë£¹ ìˆœì„œëŒ€ë¡œ í‘œì‹œ (FW -> AM -> DM -> DF -> GK -> SUB)
    const positionOrder = ['FW', 'AM', 'DM', 'DF', 'GK', 'SUB'];
    
    return positionOrder.map(position => {
        const stats = positionStats[position];
        if (stats.count === 0) return '';
        
        const avgRating = (stats.totalRating / stats.count).toFixed(1);
        const positionName = position === 'FW' ? 'ê³µê²©ìˆ˜' : 
                           position === 'AM' ? 'ê³µê²©í˜• ë¯¸ë“œí•„ë”' :
                           position === 'DM' ? 'ìˆ˜ë¹„í˜• ë¯¸ë“œí•„ë”' :
                           position === 'DF' ? 'ìˆ˜ë¹„ìˆ˜' :
                           position === 'GK' ? 'ê³¨í‚¤í¼' :
                           position === 'SUB' ? 'ì„œë¸Œ' : position;
        
        return `
            <div class="position-stat">
                <span class="position-name">${positionName}</span>
                <span class="position-count">${stats.count}ëª…</span>
                <span class="position-rating">í‰ì  ${avgRating}</span>
                <span class="position-contribution">${stats.goals}ê³¨ ${stats.assists}ë„ì›€</span>
            </div>
        `;
    }).filter(html => html !== '').join('');
}

// ì£¼ìš” ì„ ìˆ˜ HTML ìƒì„±
function createKeyPlayersHTML(userPlayers, opponentPlayers) {
    const allPlayers = [...(userPlayers || []), ...(opponentPlayers || [])];
    
    // ì •ë ¬ëœ ì„ ìˆ˜ ëª©ë¡ ì‚¬ìš© (í¬ì§€ì…˜ë³„, í‰ì ìˆœ ì •ë ¬)
    const sortedPlayers = sortPlayersByPositionAndRating(allPlayers);
    
    // í‰ì  ê¸°ì¤€ ìƒìœ„ 3ëª… (ì •ë ¬ëœ ëª©ë¡ì—ì„œ)
    const topPlayers = sortedPlayers
        .filter(player => (player.status?.spRating || 0) > 0)
        .slice(0, 3);
    
    // ê³¨ ë„£ì€ ì„ ìˆ˜ë“¤ (ì •ë ¬ëœ ëª©ë¡ì—ì„œ)
    const goalScorers = sortedPlayers.filter(player => (player.status?.goal || 0) > 0);
    
    return `
        <div class="key-players-grid">
            ${topPlayers.length > 0 ? `
                <div class="top-rated">
                    <h6>ìµœê³  í‰ì </h6>
                    ${topPlayers.map(player => `
                        <div class="key-player">
                            <span class="player-name">${player.spName}</span>
                            <span class="player-rating">${(player.status.spRating || 0).toFixed(1)}</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            ${goalScorers.length > 0 ? `
                <div class="goal-scorers">
                    <h6>ë“ì ì</h6>
                    ${goalScorers.map(player => `
                        <div class="key-player">
                            <span class="player-name">${player.spName}</span>
                            <span class="player-goals">${player.status.goal}ê³¨</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

// ê²½ê¸° íŠ¹ì§• ë¶„ì„ í•¨ìˆ˜
function analyzePlayerCharacteristics(userInfo) {
    if (!userInfo || !userInfo.matches || userInfo.matches.length === 0) {
        return {
            playStyle: 'ë°ì´í„° ë¶€ì¡±',
            mainStrength: 'ë¶„ì„ ë¶ˆê°€',
            gameTendency: 'ì •ë³´ ì—†ìŒ'
        };
    }
    
    const matches = userInfo.matches;
    const totalMatches = matches.length;
    
    // ê¸°ë³¸ í†µê³„ ê³„ì‚°
    let totalGoals = 0;
    let totalAssists = 0;
    let totalWins = 0;
    let totalDraws = 0;
    let totalLosses = 0;
    let totalGoalsConceded = 0;
    
    matches.forEach(match => {
        // ì‹¤ì œ API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •
        if (match.userGoals !== undefined) {
            totalGoals += match.userGoals;
        }
        
        if (match.opponentGoals !== undefined) {
            totalGoalsConceded += match.opponentGoals;
        }
        
        // ê²½ê¸° ê²°ê³¼ ìˆ˜ì§‘ (1: ìŠ¹, 2: íŒ¨, 0: ë¬´)
        if (match.matchResult === 1) totalWins++;
        else if (match.matchResult === 0) totalDraws++;
        else if (match.matchResult === 2) totalLosses++;
        
        // ì–´ì‹œìŠ¤íŠ¸ëŠ” ì„ ìˆ˜ë³„ ë°ì´í„°ì—ì„œ ìˆ˜ì§‘
        if (match.userPlayers && Array.isArray(match.userPlayers)) {
            match.userPlayers.forEach(player => {
                if (player.status && player.status.assist !== undefined) {
                    totalAssists += player.status.assist;
                }
            });
        }
    });
    
    const winRate = totalMatches > 0 ? (totalWins / totalMatches) * 100 : 0;
    const avgGoals = totalMatches > 0 ? totalGoals / totalMatches : 0;
    const avgAssists = totalMatches > 0 ? totalAssists / totalMatches : 0;
    const avgGoalsConceded = totalMatches > 0 ? totalGoalsConceded / totalMatches : 0;
    
    // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶œë ¥
    console.log('ê²½ê¸° íŠ¹ì§• ë¶„ì„ ë°ì´í„°:', {
        totalMatches,
        totalWins,
        totalDraws,
        totalLosses,
        totalGoals,
        totalAssists,
        totalGoalsConceded,
        winRate: winRate.toFixed(2) + '%',
        avgGoals: avgGoals.toFixed(2),
        avgAssists: avgAssists.toFixed(2),
        avgGoalsConceded: avgGoalsConceded.toFixed(2)
    });
    
    // ë°ì´í„°ê°€ ë¶€ì¡±í•œ ê²½ìš° ê¸°ë³¸ê°’ ë°˜í™˜ (10ê²½ê¸° ê¸°ì¤€)
    if (totalMatches < 10) {
        return {
            playStyle: `ë¶„ì„ì¤‘ (${totalMatches}/10ê²½ê¸°)`,
            mainStrength: `ë¶„ì„ì¤‘ (${totalMatches}/10ê²½ê¸°)`,
            gameTendency: `ë¶„ì„ì¤‘ (${totalMatches}/10ê²½ê¸°)`
        };
    }
    
    // í”Œë ˆì´ ìŠ¤íƒ€ì¼ ë¶„ì„ (10ê²½ê¸° ê¸°ì¤€) - ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ì„ íƒ
    const styleCandidates = [];
    
    // ê° ìŠ¤íƒ€ì¼ë³„ ì ìˆ˜ ê³„ì‚°
    if (avgGoals > 2.0 && winRate > 60) {
        styleCandidates.push({ name: 'ê³µê²©ì ', score: (avgGoals * 20) + (winRate * 0.3) });
    }
    if (avgGoals < 0.5 && avgGoalsConceded < 1.0) {
        styleCandidates.push({ name: 'ìˆ˜ë¹„ì ', score: ((1.0 - avgGoalsConceded) * 50) + (winRate * 0.3) });
    }
    if (avgAssists > 1.5 && avgGoals > 0.8) {
        styleCandidates.push({ name: 'ì°½ì¡°ì ', score: (avgAssists * 25) + (avgGoals * 15) });
    }
    if (winRate > 75 && avgGoalsConceded < 1.2) {
        styleCandidates.push({ name: 'ì „ìˆ ì ', score: (winRate * 0.4) + ((1.2 - avgGoalsConceded) * 30) });
    }
    if (avgGoals > 1.2 && avgAssists > 0.8) {
        styleCandidates.push({ name: 'ì˜¬ë¼ìš´ë“œ', score: (avgGoals * 15) + (avgAssists * 20) + (winRate * 0.2) });
    }
    
    // ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ ìŠ¤íƒ€ì¼ ì„ íƒ
    const playStyle = styleCandidates.length > 0 
        ? styleCandidates.reduce((max, current) => current.score > max.score ? current : max).name
        : 'ê· í˜•í˜•';
    
    // ì£¼ìš” ê°•ì  ë¶„ì„ (10ê²½ê¸° ê¸°ì¤€) - ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ì„ íƒ
    const strengthCandidates = [];
    
    // ê° ê°•ì ë³„ ì ìˆ˜ ê³„ì‚°
    if (avgGoals > 1.8 && winRate > 60) {
        strengthCandidates.push({ name: 'ë“ì ë ¥', score: (avgGoals * 30) + (winRate * 0.4) });
    }
    if (avgAssists > 1.2 && avgGoals > 0.6) {
        strengthCandidates.push({ name: 'í”Œë ˆì´ë©”ì´í‚¹', score: (avgAssists * 35) + (avgGoals * 20) });
    }
    if (winRate > 70 && avgGoalsConceded < 1.0) {
        strengthCandidates.push({ name: 'ìŠ¹ë¶€ì‚¬', score: (winRate * 0.5) + ((1.0 - avgGoalsConceded) * 40) });
    }
    if (avgGoalsConceded < 0.8 && winRate > 60) {
        strengthCandidates.push({ name: 'ìˆ˜ë¹„ë ¥', score: ((0.8 - avgGoalsConceded) * 60) + (winRate * 0.3) });
    }
    if (avgGoals > 1.0 && avgAssists > 0.6 && winRate > 55) {
        strengthCandidates.push({ name: 'ì˜¬ë¼ìš´ë“œ', score: (avgGoals * 20) + (avgAssists * 25) + (winRate * 0.3) });
    }
    if (avgGoals > 1.5) {
        strengthCandidates.push({ name: 'ê³µê²©ë ¥', score: avgGoals * 25 });
    }
    if (avgAssists > 1.0) {
        strengthCandidates.push({ name: 'ì°½ì¡°ë ¥', score: avgAssists * 30 });
    }
    
    // ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ ê°•ì  ì„ íƒ
    const mainStrength = strengthCandidates.length > 0 
        ? strengthCandidates.reduce((max, current) => current.score > max.score ? current : max).name
        : 'ì•ˆì •ì„±';
    
    // ê²½ê¸° ì„±í–¥ ë¶„ì„ (10ê²½ê¸° ê¸°ì¤€) - ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ì„ íƒ
    const tendencyCandidates = [];
    
    // ê° ì„±í–¥ë³„ ì ìˆ˜ ê³„ì‚° (ë” ë†’ì€ ì ìˆ˜ = ë” íŠ¹ì§•ì )
    if (avgGoals >= 2.2 && winRate >= 70) {
        tendencyCandidates.push({ name: 'ì •ë°€ ìŠ¤ë‚˜ì´í¼', score: (avgGoals * 40) + (winRate * 0.6) });
    }
    if (avgAssists >= 1.5 && winRate >= 70) {
        tendencyCandidates.push({ name: 'í‹°í‚¤íƒ€ì¹´ ë§ˆì—ìŠ¤íŠ¸ë¡œ', score: (avgAssists * 45) + (winRate * 0.6) });
    }
    if (avgGoals >= 1.8 && avgAssists >= 1.2 && winRate >= 75) {
        tendencyCandidates.push({ name: 'ë²ˆê°œ ì¹´ìš´í„°', score: (avgGoals * 30) + (avgAssists * 35) + (winRate * 0.8) });
    }
    if (avgGoalsConceded <= 0.7 && winRate >= 70) {
        tendencyCandidates.push({ name: 'ì² ë²½ ìˆ˜ë¹„', score: ((0.7 - avgGoalsConceded) * 80) + (winRate * 0.6) });
    }
    if (avgGoals >= 1.8 && avgAssists >= 1.3 && winRate >= 70) {
        tendencyCandidates.push({ name: 'ë§ŒëŠ¥ ë“ì ë¨¸ì‹ ', score: (avgGoals * 35) + (avgAssists * 40) + (winRate * 0.6) });
    }
    if (avgAssists >= 1.3 && winRate >= 75) {
        tendencyCandidates.push({ name: 'ì ìœ ìœ¨ ì œì–´', score: (avgAssists * 50) + (winRate * 0.8) });
    }
    if (avgGoalsConceded <= 0.9 && winRate >= 70) {
        tendencyCandidates.push({ name: 'ê³ ì•• ì••ë°•', score: ((0.9 - avgGoalsConceded) * 70) + (winRate * 0.6) });
    }
    if (avgAssists >= 1.1 && winRate >= 65) {
        tendencyCandidates.push({ name: 'ìœ™ í”Œë ˆì´', score: (avgAssists * 40) + (winRate * 0.5) });
    }
    if (avgGoals >= 1.6 && winRate >= 65) {
        tendencyCandidates.push({ name: 'ë¡±ë³¼ ì „ìˆ ', score: (avgGoals * 35) + (winRate * 0.5) });
    }
    if (avgGoalsConceded <= 1.0 && avgGoals >= 1.3 && winRate >= 65) {
        tendencyCandidates.push({ name: 'ìˆ˜ë¹„ ì¹´ìš´í„°', score: ((1.0 - avgGoalsConceded) * 50) + (avgGoals * 25) + (winRate * 0.5) });
    }
    if (avgGoals >= 2.0 && winRate >= 60) {
        tendencyCandidates.push({ name: 'ì˜¬ì•„ì›ƒ ì–´íƒ', score: (avgGoals * 45) + (winRate * 0.4) });
    }
    if (avgAssists >= 1.0 && avgGoals >= 1.0 && winRate >= 60) {
        tendencyCandidates.push({ name: 'ì°½ì¡°ì  í”Œë ˆì´ë©”ì´ì»¤', score: (avgAssists * 35) + (avgGoals * 30) + (winRate * 0.4) });
    }
    if (avgGoalsConceded <= 1.1 && winRate >= 60) {
        tendencyCandidates.push({ name: 'ì•ˆì •ì  ìˆ˜ë¹„', score: ((1.1 - avgGoalsConceded) * 60) + (winRate * 0.4) });
    }
    
    // ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ ì„±í–¥ ì„ íƒ
    const gameTendency = tendencyCandidates.length > 0 
        ? tendencyCandidates.reduce((max, current) => current.score > max.score ? current : max).name
        : 'ê· í˜• ì¡íŒ í”Œë ˆì´';
    
    // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶œë ¥
    console.log('=== í”Œë ˆì´ì–´ íŠ¹ì§• ë¶„ì„ ê²°ê³¼ ===');
    console.log('ìŠ¤íƒ€ì¼ í›„ë³´ë“¤:', styleCandidates);
    console.log('ì„ íƒëœ ìŠ¤íƒ€ì¼:', playStyle);
    console.log('ê°•ì  í›„ë³´ë“¤:', strengthCandidates);
    console.log('ì„ íƒëœ ê°•ì :', mainStrength);
    console.log('ì„±í–¥ í›„ë³´ë“¤:', tendencyCandidates);
    console.log('ì„ íƒëœ ì„±í–¥:', gameTendency);
    
    const result = {
        playStyle,
        mainStrength,
        gameTendency
    };
    
    // ë¶„ì„ ê²°ê³¼ ë¡œê·¸ ì¶œë ¥
    console.log('ê²½ê¸° íŠ¹ì§• ë¶„ì„ ê²°ê³¼:', result);
    
    return result;
}

// ê²½ê¸° íŠ¹ì§• í‘œì‹œ í•¨ìˆ˜
function displayPlayerCharacteristics(userInfo) {
    const characteristics = analyzePlayerCharacteristics(userInfo);
    
    // í”Œë ˆì´ ìŠ¤íƒ€ì¼
    playStyle.textContent = characteristics.playStyle;
    playStyle.className = 'characteristic-value';
    if (characteristics.playStyle === 'ê³µê²©ì ') {
        playStyle.classList.add('offensive');
    } else if (characteristics.playStyle === 'ìˆ˜ë¹„ì ') {
        playStyle.classList.add('defensive');
    } else if (characteristics.playStyle === 'ì°½ì¡°ì ') {
        playStyle.classList.add('creative');
    } else if (characteristics.playStyle === 'ì „ìˆ ì ') {
        playStyle.classList.add('tactical');
    } else if (characteristics.playStyle.includes('ë¶„ì„ì¤‘')) {
        playStyle.classList.add('analyzing');
    } else {
        playStyle.classList.add('balanced');
    }
    
    // ì£¼ìš” ê°•ì 
    mainStrength.textContent = characteristics.mainStrength;
    mainStrength.className = 'characteristic-value';
    if (characteristics.mainStrength === 'ë“ì ë ¥') {
        mainStrength.classList.add('offensive');
    } else if (characteristics.mainStrength === 'ìˆ˜ë¹„ë ¥') {
        mainStrength.classList.add('defensive');
    } else if (characteristics.mainStrength === 'í”Œë ˆì´ë©”ì´í‚¹') {
        mainStrength.classList.add('creative');
    } else if (characteristics.mainStrength === 'ìŠ¹ë¶€ì‚¬') {
        mainStrength.classList.add('tactical');
    } else if (characteristics.mainStrength.includes('ë¶„ì„ì¤‘')) {
        mainStrength.classList.add('analyzing');
    } else {
        mainStrength.classList.add('balanced');
    }
    
    // ê²½ê¸° ì„±í–¥
    gameTendency.textContent = characteristics.gameTendency;
    gameTendency.className = 'characteristic-value';
    if (characteristics.gameTendency === 'ê³µê²©ì ') {
        gameTendency.classList.add('aggressive');
    } else if (characteristics.gameTendency === 'ìˆ˜ë¹„ì ') {
        gameTendency.classList.add('defensive');
    } else if (characteristics.gameTendency === 'ì°½ì¡°ì ') {
        gameTendency.classList.add('creative');
    } else if (characteristics.gameTendency === 'ì „ìˆ ì ') {
        gameTendency.classList.add('tactical');
    } else if (characteristics.gameTendency.includes('ë¶„ì„ì¤‘')) {
        gameTendency.classList.add('analyzing');
    } else {
        gameTendency.classList.add('balanced');
    }
}

// ê²€ìƒ‰ ê¸°ë¡ì— ì¶”ê°€
function addToSearchHistory(nickname) {
    if (!nickname || nickname.trim() === '') return;
    
    const trimmedNickname = nickname.trim();
    
    // ê¸°ì¡´ ê¸°ë¡ì—ì„œ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    searchHistory = searchHistory.filter(item => item.nickname !== trimmedNickname);
    
    // ìƒˆ ê¸°ë¡ì„ ë§¨ ì•ì— ì¶”ê°€
    searchHistory.unshift({
        nickname: trimmedNickname,
        timestamp: new Date().toISOString()
    });
    
    // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ ì €ì¥
    searchHistory = searchHistory.slice(0, 10);
    
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem('fcData_searchHistory', JSON.stringify(searchHistory));
    
    // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    updateDropdown();
}

// ì¦ê²¨ì°¾ê¸° í† ê¸€
function toggleFavorite(nickname) {
    const trimmedNickname = nickname.trim();
    const existingIndex = favorites.findIndex(item => item.nickname === trimmedNickname);
    
    if (existingIndex > -1) {
        // ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°
        favorites.splice(existingIndex, 1);
    } else {
        // ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€
        favorites.unshift({
            nickname: trimmedNickname,
            timestamp: new Date().toISOString()
        });
    }
    
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem('fcData_favorites', JSON.stringify(favorites));
    
    // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    updateDropdown();
}

// ì¦ê²¨ì°¾ê¸°ì¸ì§€ í™•ì¸
function isFavorite(nickname) {
    return favorites.some(item => item.nickname === nickname);
}

// ê²€ìƒ‰ ê¸°ë¡ì—ì„œ ì œê±°
function removeFromHistory(nickname) {
    searchHistory = searchHistory.filter(item => item.nickname !== nickname);
    localStorage.setItem('fcData_searchHistory', JSON.stringify(searchHistory));
    updateDropdown();
}

// ì¦ê²¨ì°¾ê¸° ëª¨ë‘ ì‚­ì œ
function clearAllFavorites() {
    if (confirm('ëª¨ë“  ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        favorites = [];
        localStorage.setItem('fcData_favorites', JSON.stringify(favorites));
        updateDropdown();
    }
}

// ê²€ìƒ‰ ê¸°ë¡ ëª¨ë‘ ì‚­ì œ
function clearAllHistory() {
    if (confirm('ëª¨ë“  ê²€ìƒ‰ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        searchHistory = [];
        localStorage.setItem('fcData_searchHistory', JSON.stringify(searchHistory));
        updateDropdown();
    }
}

// ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
function updateDropdown() {
    // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸
    if (favorites.length === 0) {
        favoritesList.innerHTML = '<div class="empty-message">ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
        favoritesList.innerHTML = favorites.map(item => `
            <div class="dropdown-item" data-nickname="${item.nickname}">
                <div class="item-info">
                    <div class="item-name">${item.nickname}</div>
                    <div class="item-time">ì¦ê²¨ì°¾ê¸°</div>
                </div>
                <div class="item-actions">
                    <button class="favorite-btn favorited" onclick="event.stopPropagation(); toggleFavorite('${item.nickname}')" title="ì¦ê²¨ì°¾ê¸° í•´ì œ">â­</button>
                </div>
            </div>
        `).join('');
    }
    
    // ê²€ìƒ‰ ê¸°ë¡ ëª©ë¡ ì—…ë°ì´íŠ¸
    if (searchHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-message">ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
        historyList.innerHTML = searchHistory.map(item => `
            <div class="dropdown-item" data-nickname="${item.nickname}">
                <div class="item-info">
                    <div class="item-name">${item.nickname}</div>
                    <div class="item-time">${formatTime(item.timestamp)}</div>
                </div>
                <div class="item-actions">
                    <button class="favorite-btn ${isFavorite(item.nickname) ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite('${item.nickname}')" title="${isFavorite(item.nickname) ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€'}">â­</button>
                    <button class="remove-btn" onclick="event.stopPropagation(); removeFromHistory('${item.nickname}')" title="ê¸°ë¡ ì‚­ì œ">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }
}

// ì‹œê°„ í¬ë§·íŒ…
function formatTime(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diff = now - time;
    
    if (diff < 60000) { // 1ë¶„ ë¯¸ë§Œ
        return 'ë°©ê¸ˆ ì „';
    } else if (diff < 3600000) { // 1ì‹œê°„ ë¯¸ë§Œ
        return `${Math.floor(diff / 60000)}ë¶„ ì „`;
    } else if (diff < 86400000) { // 1ì¼ ë¯¸ë§Œ
        return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
    } else {
        return time.toLocaleDateString('ko-KR');
    }
}

// ë“œë¡­ë‹¤ìš´ í‘œì‹œ/ìˆ¨ê¹€
function showDropdown() {
    if (favorites.length > 0 || searchHistory.length > 0) {
        searchDropdown.style.display = 'block';
        selectedIndex = -1;
    }
}

function hideDropdown() {
    searchDropdown.style.display = 'none';
    selectedIndex = -1;
}

// í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
function handleKeyNavigation(e) {
    if (searchDropdown.style.display === 'none') return;
    
    const items = searchDropdown.querySelectorAll('.dropdown-item');
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection();
            break;
        case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection();
            break;
        case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                const nickname = items[selectedIndex].dataset.nickname;
                nicknameInput.value = nickname;
                hideDropdown();
                searchUser();
            }
            break;
        case 'Escape':
            hideDropdown();
            break;
    }
}

// ì„ íƒëœ í•­ëª© ì—…ë°ì´íŠ¸
function updateSelection() {
    const items = searchDropdown.querySelectorAll('.dropdown-item');
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
    });
}

// ì²« í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ëŠ” í•¨ìˆ˜
function resetToHomePage() {
    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    playerBasicInfo.style.display = 'none';
    tabContainer.style.display = 'none';
    errorSection.style.display = 'none';
    
    // ê²€ìƒ‰ ì…ë ¥ì°½ ì´ˆê¸°í™”
    nicknameInput.value = '';
    nicknameInput.focus();
    
    // ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
    hideDropdown();
    
    // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    currentUserInfo = null;
    currentMatchOffset = 10;
    
    // ë¡œë”© ìƒíƒœ í•´ì œ
    loading.style.display = 'none';
    searchBtn.disabled = false;
    
    console.log('ì²« í™”ë©´ìœ¼ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤.');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('load', function() {
    initTheme();
    nicknameInput.focus();
    
    // teamDetailPanel ì´ˆê¸°í™”
    const teamDetailPanel = document.getElementById('teamDetailPanel');
    if (teamDetailPanel) {
        teamDetailPanel.innerHTML = `
            <div class="team-detail-placeholder">
                <div class="placeholder-icon">âš½</div>
                <h4>êµ¬ë‹¨ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h4>
                <p>ìœ„ì—ì„œ êµ¬ë‹¨ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        // displayëŠ” ì„¤ì •í•˜ì§€ ì•ŠìŒ (êµ¬ë‹¨ë³„ ë°ì´í„° íƒ­ í´ë¦­ ì‹œ í‘œì‹œë¨)
    }
    
    // FC Data ë¡œê³  í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    const logo = document.getElementById('logo');
    if (logo) {
        logo.addEventListener('click', resetToHomePage);
    }
    
    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    searchBtn.addEventListener('click', function() {
        const nickname = nicknameInput.value.trim();
        if (nickname) {
            searchUser();
            hideDropdown();
        }
    });
    
    // ì—”í„°í‚¤ ê²€ìƒ‰ ì´ë²¤íŠ¸
    nicknameInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                searchUser();
                hideDropdown();
            }
        }
    });
    
    // ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸
    nicknameInput.addEventListener('focus', function() {
        updateDropdown();
        showDropdown();
    });
    
    // ì…ë ¥ì°½ ì…ë ¥ ì´ë²¤íŠ¸
    nicknameInput.addEventListener('input', function() {
        if (this.value.trim() === '') {
            showDropdown();
        } else {
            hideDropdown();
        }
    });
    
    // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
    nicknameInput.addEventListener('keydown', handleKeyNavigation);
    
    // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ìˆ¨ê¸°ê¸°
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-input-container')) {
            hideDropdown();
        }
    });
    
    // ë“œë¡­ë‹¤ìš´ ì•„ì´í…œ í´ë¦­ ì´ë²¤íŠ¸
    searchDropdown.addEventListener('click', function(e) {
        const item = e.target.closest('.dropdown-item');
        if (item) {
            const nickname = item.dataset.nickname;
            nicknameInput.value = nickname;
            hideDropdown();
            searchUser();
        }
    });
    
    // ì¦ê²¨ì°¾ê¸°/ê²€ìƒ‰ê¸°ë¡ ëª¨ë‘ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    clearFavoritesBtn.addEventListener('click', clearAllFavorites);
    clearHistoryBtn.addEventListener('click', clearAllHistory);
    
    // ì´ˆê¸° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    updateDropdown();
    
    // í¬ë©”ì´ì…˜ ê³„ì‚° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°œë°œìš©)
    setTimeout(() => {
        testFormationCalculation();
    }, 1000);
    
    // íŠ¹ì§• ê°€ì´ë“œ íŒì—… ì´ë²¤íŠ¸
    setupCharacteristicsGuide();
    
    // ìµœê³ ì˜ ì„ ìˆ˜ ê°€ì´ë“œ íŒì—… ì´ë²¤íŠ¸
    setupTopPlayersGuide();
});

// íŠ¹ì§• ê°€ì´ë“œ íŒì—… ì„¤ì •
function setupCharacteristicsGuide() {
    const popup = document.getElementById('characteristicsGuidePopup');
    const closeBtn = document.getElementById('closeGuideBtn');
    const guideTitle = document.getElementById('guideTitle');
    const guideContent = document.getElementById('guideContent');
    
    // íŒì—… ë‹«ê¸°
    function closeGuide() {
        popup.classList.remove('show');
        setTimeout(() => {
            popup.style.display = 'none';
        }, 300);
    }
    
    // íŒì—… ì—´ê¸°
    function openGuide(type) {
        const guideData = getCharacteristicsGuideData(type);
        guideTitle.textContent = guideData.title;
        guideContent.innerHTML = guideData.content;
        popup.style.display = 'flex';
        setTimeout(() => {
            popup.classList.add('show');
        }, 10);
    }
    
    // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    closeBtn.addEventListener('click', closeGuide);
    
    // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
    popup.addEventListener('click', function(e) {
        if (e.target === popup) {
            closeGuide();
        }
    });
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && popup.classList.contains('show')) {
            closeGuide();
        }
    });
    
    // íŠ¹ì§• ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.addEventListener('click', function(e) {
        const characteristicItem = e.target.closest('.characteristic-item');
        if (characteristicItem) {
            const label = characteristicItem.querySelector('.characteristic-label').textContent;
            if (label === 'ìŠ¤íƒ€ì¼') {
                openGuide('style');
            } else if (label === 'ê°•ì ') {
                openGuide('strength');
            } else if (label === 'ì„±í–¥') {
                openGuide('tendency');
            }
        }
    });
}

// ìµœê³ ì˜ ì„ ìˆ˜ ê°€ì´ë“œ íŒì—… ì„¤ì •
function setupTopPlayersGuide() {
    const popup = document.getElementById('topPlayersGuidePopup');
    const closeBtn = document.getElementById('closeTopPlayersGuideBtn');
    const guideBtn = document.getElementById('topPlayersGuideBtn');
    
    // íŒì—… ë‹«ê¸°
    function closeGuide() {
        popup.classList.remove('show');
        setTimeout(() => {
            popup.style.display = 'none';
        }, 300);
    }
    
    // íŒì—… ì—´ê¸°
    function openGuide() {
        popup.style.display = 'flex';
        setTimeout(() => {
            popup.classList.add('show');
        }, 10);
    }
    
    // ê°€ì´ë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if (guideBtn) {
        guideBtn.addEventListener('click', openGuide);
    }
    
    // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    if (closeBtn) {
        closeBtn.addEventListener('click', closeGuide);
    }
    
    // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
    if (popup) {
        popup.addEventListener('click', function(e) {
            if (e.target === popup) {
                closeGuide();
            }
        });
    }
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && popup.classList.contains('show')) {
            closeGuide();
        }
    });
}

// íŠ¹ì§• ê°€ì´ë“œ ë°ì´í„°
function getCharacteristicsGuideData(type) {
    const guides = {
        style: {
            title: 'í”Œë ˆì´ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ',
            content: `
                <div class="guide-section">
                    <h4>ê³µê²© ë°©ì‹ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë¶„ë¥˜</h4>
                    <div class="guide-item">
                        <div class="guide-item-name">ì˜¬ë¼ìš´ë“œ</div>
                        <div class="guide-item-desc">ê³µê²©ê³¼ ì–´ì‹œìŠ¤íŠ¸ ëª¨ë‘ ë›°ì–´ë‚œ ì™„ì „í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.5ê³¨ + ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.0ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ê³µê²©ì </div>
                        <div class="guide-item-desc">ê³µê²© ì¤‘ì‹¬ì´ì§€ë§Œ íŒ€í”Œë ˆì´ë„ í•˜ëŠ” í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.5ê³¨ + ì–´ì‹œìŠ¤íŠ¸ 0.5-0.9ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ìŠ¤íŠ¸ë¼ì´ì»¤</div>
                        <div class="guide-item-desc">ìˆœìˆ˜í•œ ê³¨ ê²°ì •ë ¥ì— íŠ¹í™”ëœ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.5ê³¨ + ì–´ì‹œìŠ¤íŠ¸ < 0.5ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">í”Œë ˆì´ë©”ì´ì»¤</div>
                        <div class="guide-item-desc">ê³µê²©ë³´ë‹¤ íŒ€í”Œë ˆì´ì— íŠ¹í™”ëœ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  1.0-1.4ê³¨ + ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.0ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ê· í˜•í˜•</div>
                        <div class="guide-item-desc">ê³µê²©ê³¼ ì–´ì‹œìŠ¤íŠ¸ê°€ ê· í˜• ì¡íŒ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  1.0-1.4ê³¨ + ì–´ì‹œìŠ¤íŠ¸ 0.5-0.9ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì°½ì¡°ì </div>
                        <div class="guide-item-desc">ì–´ì‹œìŠ¤íŠ¸ íŠ¹í™”, ë“ì ì€ ë³´ì¡° ì—­í• </div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  0.5-0.9ê³¨ + ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.0ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ìˆ˜ë¹„í˜•</div>
                        <div class="guide-item-desc">ìˆ˜ë¹„ ì¤‘ì‹¬ì˜ ì•ˆì •ì ì¸ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  0.5-0.9ê³¨ + ì–´ì‹œìŠ¤íŠ¸ < 0.5ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ìˆ˜ë¹„ì </div>
                        <div class="guide-item-desc">ê°•ë ¥í•œ ìˆ˜ë¹„ë ¥ìœ¼ë¡œ ê²½ê¸°ë¥¼ í†µì œí•˜ëŠ” í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  < 0.5ê³¨ + ì‹¤ì  < 1.0ê³¨</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì „ìˆ ì </div>
                        <div class="guide-item-desc">ì „ëµì  ì‚¬ê³ ë¡œ ë†’ì€ ìŠ¹ë¥ ì„ ê¸°ë¡í•˜ëŠ” í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ìŠ¹ë¥  > 75% + ì‹¤ì  < 1.2ê³¨</div>
                    </div>
                </div>
            `
        },
        strength: {
            title: 'ì£¼ìš” ê°•ì  ê°€ì´ë“œ',
            content: `
                <div class="guide-section">
                    <h4>íŠ¹í™” ëŠ¥ë ¥ì— ë”°ë¥¸ ê°•ì  ë¶„ë¥˜</h4>
                    <div class="guide-item">
                        <div class="guide-item-name">ê³¨ ê²°ì •ë ¥</div>
                        <div class="guide-item-desc">ë›°ì–´ë‚œ ë“ì  ëŠ¥ë ¥ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> í‰ê·  ë“ì  â‰¥ 1.8ê³¨</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">íŒ€í”Œë ˆì´</div>
                        <div class="guide-item-desc">ë›°ì–´ë‚œ ì–´ì‹œìŠ¤íŠ¸ ëŠ¥ë ¥ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> í‰ê·  ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.2ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ìˆ˜ë¹„ë ¥</div>
                        <div class="guide-item-desc">íƒì›”í•œ ìˆ˜ë¹„ ëŠ¥ë ¥ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> í‰ê·  ì‹¤ì  â‰¤ 1.0ê³¨</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ìŠ¹ë¶€ì‚¬</div>
                        <div class="guide-item-desc">ì¤‘ìš”í•œ ìˆœê°„ ìŠ¹ë¦¬ ëŠ¥ë ¥ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ìŠ¹ë¥  â‰¥ 75%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì „ìˆ ê°€</div>
                        <div class="guide-item-desc">ì „ëµì  ì‚¬ê³  ëŠ¥ë ¥ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì˜¬ë¼ìš´ë“œ</div>
                        <div class="guide-item-desc">ê³µê²©ê³¼ íŒ€í”Œë ˆì´ ëª¨ë‘ ìš°ìˆ˜í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.5ê³¨ + ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.0ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ë“ì ë ¥</div>
                        <div class="guide-item-desc">ë›°ì–´ë‚œ ê³¨ ê²°ì •ë ¥ê³¼ ë†’ì€ ìŠ¹ë¥ ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> í‰ê·  ë“ì  > 1.8ê³¨ + ìŠ¹ë¥  > 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">í”Œë ˆì´ë©”ì´í‚¹</div>
                        <div class="guide-item-desc">ë›°ì–´ë‚œ ì–´ì‹œìŠ¤íŠ¸ ëŠ¥ë ¥ê³¼ ë“ì ë ¥ì„ ê²¸ë¹„í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> í‰ê·  ì–´ì‹œìŠ¤íŠ¸ > 1.2ê°œ + ë“ì  > 0.6ê³¨</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ê³µê²©ë ¥</div>
                        <div class="guide-item-desc">ê°•ë ¥í•œ ë“ì  ëŠ¥ë ¥ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> í‰ê·  ë“ì  > 1.5ê³¨</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì°½ì¡°ë ¥</div>
                        <div class="guide-item-desc">ë›°ì–´ë‚œ ì–´ì‹œìŠ¤íŠ¸ ëŠ¥ë ¥ì„ ë³´ìœ í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> í‰ê·  ì–´ì‹œìŠ¤íŠ¸ > 1.0ê°œ</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì•ˆì •ì„±</div>
                        <div class="guide-item-desc">ê¾¸ì¤€í•˜ê³  ì•ˆì •ì ì¸ í”Œë ˆì´ë¥¼ ë³´ì—¬ì£¼ëŠ” í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ìœ„ ì¡°ê±´ë“¤ì„ ë§Œì¡±í•˜ì§€ ì•ŠëŠ” ê²½ìš°</div>
                    </div>
                </div>
            `
        },
        tendency: {
            title: 'ê²½ê¸° ì„±í–¥ ê°€ì´ë“œ',
            content: `
                <div class="guide-section">
                    <h4>ê²½ê¸° ìš´ì˜ ì² í•™ì— ë”°ë¥¸ ì„±í–¥ ë¶„ë¥˜</h4>
                    <div class="guide-item">
                        <div class="guide-item-name">ì •ë°€ ìŠ¤ë‚˜ì´í¼</div>
                        <div class="guide-item-desc">ì •í™•í•œ ìŠˆíŒ…ê³¼ ê²°ì •ë ¥ìœ¼ë¡œ ê³¨ì„ ë…¸ë¦¬ëŠ” ê³µê²© ì¤‘ì‹¬ ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.8ê³¨ + ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">í‹°í‚¤íƒ€ì¹´ ë§ˆì—ìŠ¤íŠ¸ë¡œ</div>
                        <div class="guide-item-desc">ì§§ì€ íŒ¨ìŠ¤ì™€ ì ìœ ìœ¨ì„ í†µí•œ ê³µê²© ì „ê°œ ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.2ê°œ + ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ë²ˆê°œ ì¹´ìš´í„°</div>
                        <div class="guide-item-desc">ë¹ ë¥¸ ì „í™˜ê³¼ ì—­ìŠµì„ í†µí•œ ê³µê²© ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.5ê³¨ + ì–´ì‹œìŠ¤íŠ¸ â‰¥ 0.8ê°œ + ìŠ¹ë¥  â‰¥ 65%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì² ë²½ ìˆ˜ë¹„</div>
                        <div class="guide-item-desc">ê°•ë ¥í•œ ìˆ˜ë¹„ë ¥ìœ¼ë¡œ ìƒëŒ€ ê³µê²©ì„ ì°¨ë‹¨í•˜ëŠ” ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì‹¤ì  â‰¤ 1.0ê³¨ + ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ë§ŒëŠ¥ ë“ì ë¨¸ì‹ </div>
                        <div class="guide-item-desc">ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ê³¨ì„ ë„£ëŠ” ê³µê²©ì  ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.5ê³¨ + ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.0ê°œ + ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì ìœ ìœ¨ ì œì–´</div>
                        <div class="guide-item-desc">ê³µì„ ì˜¤ë˜ ê°€ì§€ê³  ê²½ê¸°ë¥¼ í†µì œí•˜ëŠ” ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.0ê°œ + ìŠ¹ë¥  â‰¥ 65%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ê³ ì•• ì••ë°•</div>
                        <div class="guide-item-desc">ìƒëŒ€ë¥¼ ê°•í•˜ê²Œ ì••ë°•í•˜ì—¬ ì‹¤ìˆ˜ë¥¼ ìœ ë„í•˜ëŠ” ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì‹¤ì  â‰¤ 1.2ê³¨ + ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ìœ™ í”Œë ˆì´</div>
                        <div class="guide-item-desc">ì¸¡ë©´ì„ í™œìš©í•œ ê³µê²© ì „ê°œ ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì–´ì‹œìŠ¤íŠ¸ â‰¥ 0.8ê°œ + ìŠ¹ë¥  â‰¥ 55%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ë¡±ë³¼ ì „ìˆ </div>
                        <div class="guide-item-desc">ê¸´ íŒ¨ìŠ¤ì™€ ê³µì¤‘ë³¼ì„ í™œìš©í•œ ì§ì ‘ì ì¸ ê³µê²© ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.2ê³¨ + ìŠ¹ë¥  â‰¥ 55%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ìˆ˜ë¹„ ì¹´ìš´í„°</div>
                        <div class="guide-item-desc">ìˆ˜ë¹„ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì—­ìŠµ ê³µê²© ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì‹¤ì  â‰¤ 1.3ê³¨ + ë“ì  â‰¥ 1.0ê³¨ + ìŠ¹ë¥  â‰¥ 55%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì˜¬ì•„ì›ƒ ì–´íƒ</div>
                        <div class="guide-item-desc">ëª¨ë“  ì„ ìˆ˜ë¥¼ ê³µê²©ì— íˆ¬ì…í•˜ëŠ” ê³µê²©ì  ìŠ¤íƒ€ì¼</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ë“ì  â‰¥ 1.8ê³¨ + ìŠ¹ë¥  â‰¥ 50%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ê· í˜• ì¡íŒ í”Œë ˆì´</div>
                        <div class="guide-item-desc">ê³µìˆ˜ ë°¸ëŸ°ìŠ¤ê°€ ë›°ì–´ë‚œ ì™„ì„±ë„ ë†’ì€ ê²½ê¸° ìš´ì˜</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ìœ„ ì¡°ê±´ë“¤ì„ ë§Œì¡±í•˜ì§€ ì•ŠëŠ” ê²½ìš°</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì°½ì¡°ì  í”Œë ˆì´ë©”ì´ì»¤</div>
                        <div class="guide-item-desc">ë›°ì–´ë‚œ ì°½ì¡°ë ¥ê³¼ ë“ì ë ¥ì„ ê²¸ë¹„í•œ í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì–´ì‹œìŠ¤íŠ¸ â‰¥ 1.0ê°œ + ë“ì  â‰¥ 1.0ê³¨ + ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                    <div class="guide-item">
                        <div class="guide-item-name">ì•ˆì •ì  ìˆ˜ë¹„</div>
                        <div class="guide-item-desc">ì•ˆì •ì ì¸ ìˆ˜ë¹„ë ¥ìœ¼ë¡œ ê²½ê¸°ë¥¼ í†µì œí•˜ëŠ” í”Œë ˆì´ì–´</div>
                        <div class="guide-item-features"><strong>ì¡°ê±´:</strong> ì‹¤ì  â‰¤ 1.1ê³¨ + ìŠ¹ë¥  â‰¥ 60%</div>
                    </div>
                </div>
            `
        }
    };
    
    return guides[type] || { title: 'ê°€ì´ë“œ', content: 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.' };
}

// êµ¬ë‹¨ë³„ ë°ì´í„° ê´€ë ¨ ìš”ì†Œë“¤
const teamDataContent = document.getElementById('teamDataContent');
const teamLoading = document.getElementById('teamLoading');
const teamCardsContainer = document.getElementById('teamCardsContainer');
const noTeamData = document.getElementById('noTeamData');
const teamCardGuide = document.getElementById('teamCardGuide');

// ìŠ¬ë¼ì´ë” ê´€ë ¨ ìš”ì†Œë“¤
const teamCardsSlider = document.getElementById('teamCardsSlider');
const teamCardsTrack = document.getElementById('teamCardsTrack');
const teamSliderPrevBtn = document.getElementById('teamSliderPrevBtn');
const teamSliderNextBtn = document.getElementById('teamSliderNextBtn');

// êµ¬ë‹¨ë³„ ë°ì´í„° ê´€ë ¨ ë³€ìˆ˜ë“¤
let teamFormationData = {};
let currentUserData = null;

// ìŠ¬ë¼ì´ë” ê´€ë ¨ ë³€ìˆ˜ë“¤
let currentSlideIndex = 0;
let totalSlides = 0;
let cardsPerSlide = 2; // 1x2 ë°°ì—´ì´ë¯€ë¡œ 2ê°œì”©

// Top players slider variables
let topPlayersCurrentSlideIndex = 0;
let topPlayersTotalSlides = 0;

// êµ¬ë‹¨ë³„ ë°ì´í„° ìºì‹œ
let teamDataCache = null;
let teamDataLoaded = false;

// í¬ë©”ì´ì…˜ ë¶„ì„ ê´€ë ¨ ìš”ì†Œë“¤
const formationDataContent = document.getElementById('formationDataContent');
const formationLoading = document.getElementById('formationLoading');
const formationLayout = document.getElementById('formationLayout');
const formationPerformanceTrack = document.getElementById('formationPerformanceTrack');
const formationSliderPrevBtn = document.getElementById('formationSliderPrevBtn');
const formationSliderNextBtn = document.getElementById('formationSliderNextBtn');
const formationGroupsContainer = document.getElementById('formationGroupsContainer');
const noFormationData = document.getElementById('noFormationData');

// í¬ë©”ì´ì…˜ ë¶„ì„ ìºì‹œ
let formationDataCache = null;
let formationDataLoaded = false;

// í¬ë©”ì´ì…˜ ìŠ¬ë¼ì´ë” ë³€ìˆ˜
let formationCurrentSlideIndex = 0;
let formationTotalSlides = 0;
const formationCardsPerSlide = 3;

// êµ¬ë‹¨ë³„ ë°ì´í„° ë¶„ì„ í•¨ìˆ˜ (ë™ì¼ ì„ ìˆ˜ 11ëª… ì¶œì „ ê²½ê¸°)
async function analyzeTeamData() {
    console.log('êµ¬ë‹¨ë³„ ë°ì´í„° ë¶„ì„ ì‹œì‘');
    console.log('currentUserData:', currentUserData);
    console.log('currentUserInfo:', currentUserInfo);
    
    // êµ¬ë‹¨ë³„ ë°ì´í„°ì—ì„œëŠ” 100ê²½ê¸°ë¥¼ ë¡œë“œí•´ì„œ ë¶„ì„
    let matchesToAnalyze = null;
    
    if (currentUserInfo && currentUserInfo.ouid) {
        try {
            console.log('100ê²½ê¸° ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...');
            showTeamLoading('100ê²½ê¸° ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...');
            
            // ì´ˆê¸° 10ê²½ê¸° ë°ì´í„°ë¡œ ì‹œì‘
            matchesToAnalyze = [...(currentUserInfo.matches || [])];
            console.log('ì´ˆê¸° ê²½ê¸° ìˆ˜:', matchesToAnalyze.length);
            
            // ë”ë³´ê¸° APIë¥¼ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•´ì„œ 100ê²½ê¸°ê¹Œì§€ ê°€ì ¸ì˜¤ê¸°
            let offset = matchesToAnalyze.length; // í˜„ì¬ ë¡œë“œëœ ê²½ê¸° ìˆ˜ë¶€í„° ì‹œì‘
            const targetCount = 100;
            const batchSize = 10;
            const maxAttempts = 10; // ìµœëŒ€ 10ë²ˆ ì‹œë„ (100ê²½ê¸°ê¹Œì§€)
            let attempts = 0;
            
            while (matchesToAnalyze.length < targetCount && attempts < maxAttempts) {
                try {
                    console.log(`${attempts + 1}ë²ˆì§¸ ë”ë³´ê¸° API í˜¸ì¶œ ì¤‘... (í˜„ì¬ ${matchesToAnalyze.length}ê²½ê¸°, offset: ${offset})`);
                    
                    // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    showTeamLoading(`ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘... (${matchesToAnalyze.length}/${targetCount}ê²½ê¸°)`);
                    
                    const response = await fetch(`/api/more-matches/${currentUserInfo.ouid}/${offset}/${batchSize}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.matches && data.matches.length > 0) {
                            // ìƒˆë¡œìš´ ê²½ê¸°ë¥¼ ê¸°ì¡´ ê²½ê¸° ì•ì— ì¶”ê°€í•˜ì—¬ ìµœì‹ ìˆœ ìœ ì§€
                            matchesToAnalyze = [...data.matches, ...matchesToAnalyze];
                            offset += data.matches.length; // ì‹¤ì œ ê°€ì ¸ì˜¨ ê²½ê¸° ìˆ˜ë§Œí¼ offset ì¦ê°€
                            attempts++;
                            console.log(`ë”ë³´ê¸° API í˜¸ì¶œ ì„±ê³µ: ${data.matches.length}ê²½ê¸° ì¶”ê°€, ì´ ${matchesToAnalyze.length}ê²½ê¸°`);
                            
                            // 100ê²½ê¸°ì— ë„ë‹¬í–ˆìœ¼ë©´ ì¤‘ë‹¨
                            if (matchesToAnalyze.length >= targetCount) {
                                console.log(`ëª©í‘œ ${targetCount}ê²½ê¸°ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.`);
                                break;
                            }
                        } else {
                            console.log('ë” ì´ìƒ ê°€ì ¸ì˜¬ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            break;
                        }
                    } else {
                        console.log('ë”ë³´ê¸° API í˜¸ì¶œ ì‹¤íŒ¨');
                        break;
                    }
                } catch (error) {
                    console.log('ë”ë³´ê¸° API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:', error);
                    break;
                }
            }
            
            console.log('ìµœì¢… ê²½ê¸° ìˆ˜:', matchesToAnalyze.length);
        } catch (error) {
            console.log('100ê²½ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨, ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©:', error);
            matchesToAnalyze = currentUserInfo?.matches || currentUserData?.matches;
        }
    } else {
        matchesToAnalyze = currentUserInfo?.matches || currentUserData?.matches;
    }
    
    if (!matchesToAnalyze || matchesToAnalyze.length === 0) {
        console.log('ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê²½ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        showNoTeamData();
        return;
    }

    console.log('ë¶„ì„í•  ê²½ê¸° ìˆ˜:', matchesToAnalyze.length);
    showTeamLoading(`ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘... (${matchesToAnalyze.length}ê²½ê¸°)`);
    
    // ìµœê³ ì˜ ì„ ìˆ˜ ë°ì´í„° ê³„ì‚° ë° í‘œì‹œ
    displayTeamTopPlayers(matchesToAnalyze);
    
    try {
        // ê²½ê¸°ë³„ ì„ ìˆ˜ ê·¸ë£¹ ë¶„ì„ (7ëª… ì´ìƒ ê²¹ì¹˜ëŠ” ì„ ìˆ˜ë“¤ ê¸°ì¤€)
        const matchGroups = [];
        
        for (const match of matchesToAnalyze) {
            try {
                console.log('ê²½ê¸° ì²˜ë¦¬ ì¤‘:', match.matchId, 'userPlayers:', match.userPlayers?.length);
                
                if (match.userPlayers && match.userPlayers.length >= 11) {
                    // ì¶œì „í•œ ì„ ìˆ˜ë§Œ í•„í„°ë§ (status.spRatingì´ ìˆëŠ” ì„ ìˆ˜ë“¤)
                    const playingPlayers = match.userPlayers.filter(player => 
                        player.status && player.status.spRating && player.status.spRating > 0
                    );
                    
                    console.log('ì „ì²´ ì„ ìˆ˜:', match.userPlayers.length, 'ì¶œì „ ì„ ìˆ˜:', playingPlayers.length);
                    
                    if (playingPlayers.length >= 7) { // 7ëª… ì´ìƒì´ë©´ í¬í•¨
                        console.log('7ëª… ì´ìƒ ì¶œì „ ê²½ê¸° ë°œê²¬:', match.matchId, 'ì¶œì „ ì„ ìˆ˜:', playingPlayers.length);
                        
                        matchGroups.push({
                            matchId: match.matchId,
                            matchDate: match.matchDate,
                            result: match.matchResult === 1 ? 'ìŠ¹' : match.matchResult === 2 ? 'íŒ¨' : 'ë¬´',
                            matchType: match.matchType,
                            players: playingPlayers,
                            // userStats ì •ë³´ ì¶”ê°€
                            userStats: match.userStats,
                            opponentStats: match.opponentStats,
                            userGoals: match.userGoals,
                            opponentGoals: match.opponentGoals
                        });
                    } else {
                        console.log('7ëª… ë¯¸ë§Œ:', playingPlayers.length);
                    }
                } else {
                    console.log('ì„ ìˆ˜ ë°ì´í„° ì—†ìŒ:', match.userPlayers?.length || 0);
                }
            } catch (error) {
                console.error('ê²½ê¸° ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨:', error);
            }
        }
        
        console.log('ì´ ê²½ê¸° ìˆ˜:', matchGroups.length);
        
        // 7ëª… ì´ìƒ ê²¹ì¹˜ëŠ” ì„ ìˆ˜ë“¤ë¡œ ê·¸ë£¹í™”
        const playerGroups = groupMatchesByOverlappingPlayers(matchGroups);
        
        console.log('ë°œê²¬ëœ ë™ì¼ ì„ ìˆ˜ ê·¸ë£¹ ìˆ˜:', playerGroups.length);
        console.log('ê·¸ë£¹ë³„ ê²½ê¸° ìˆ˜:', playerGroups.map(g => g.matches.length));
        
        // ì´ë¯¸ 2ê²½ê¸° ì´ìƒìœ¼ë¡œ í•„í„°ë§ë˜ì–´ ìˆìŒ
        const filteredGroups = playerGroups;
        
        if (filteredGroups.length === 0) {
            showNoTeamData();
            return;
        }
        
        // ê·¸ë£¹ë³„ í†µê³„ ê³„ì‚°
        const groupStats = filteredGroups.map(group => {
            const stats = calculateFormationStats(group.matches);
            return {
                ...group,
                ...stats
            };
        });
        
        // ìµœê·¼ ê²½ê¸° ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì´ ìœ„ì—)
        groupStats.sort((a, b) => new Date(b.lastMatchDate) - new Date(a.lastMatchDate));
        
        teamFormationData = groupStats;
        const formations = groupStats; // formations ë³€ìˆ˜ ì •ì˜
        displayTeamFormationCards(formations);
        
        // ë°ì´í„°ë¥¼ ìºì‹œì— ì €ì¥
        teamDataCache = {
            formations: formations,
            matches: matchesToAnalyze || []
        };
        teamDataLoaded = true;
        console.log('êµ¬ë‹¨ë³„ ë°ì´í„°ê°€ ìºì‹œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        console.log('ìºì‹œ ì €ì¥ í›„ ìƒíƒœ:', 'teamDataLoaded:', teamDataLoaded, 'teamDataCache:', teamDataCache);
        
    } catch (error) {
        console.error('êµ¬ë‹¨ë³„ ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨:', error);
        showNoTeamData();
    }
}

// 7ëª… ì´ìƒ ê²¹ì¹˜ëŠ” ì„ ìˆ˜ë“¤ë¡œ ê²½ê¸° ê·¸ë£¹í™”
function groupMatchesByOverlappingPlayers(matchGroups) {
    const groups = [];
    const processedMatches = new Set();
    
    for (let i = 0; i < matchGroups.length; i++) {
        if (processedMatches.has(i)) continue;
        
        const currentMatch = matchGroups[i];
        const group = {
            players: [...currentMatch.players],
            matches: [currentMatch],
            playerIds: new Set(currentMatch.players.map(p => p.spId))
        };
        
        // í˜„ì¬ ê²½ê¸°ì™€ 7ëª… ì´ìƒ ê²¹ì¹˜ëŠ” ë‹¤ë¥¸ ê²½ê¸°ë“¤ ì°¾ê¸°
        for (let j = i + 1; j < matchGroups.length; j++) {
            if (processedMatches.has(j)) continue;
            
            const otherMatch = matchGroups[j];
            const otherPlayerIds = new Set(otherMatch.players.map(p => p.spId));
            
            // ê²¹ì¹˜ëŠ” ì„ ìˆ˜ ìˆ˜ ê³„ì‚°
            const intersection = new Set([...group.playerIds].filter(id => otherPlayerIds.has(id)));
            
            if (intersection.size >= 7) {
                console.log(`ê²½ê¸° ${currentMatch.matchId}ì™€ ${otherMatch.matchId}ëŠ” ${intersection.size}ëª… ê²¹ì¹¨`);
                
                // ê·¸ë£¹ì— ê²½ê¸° ì¶”ê°€
                group.matches.push(otherMatch);
                
                // ìƒˆë¡œìš´ ì„ ìˆ˜ë“¤ ì¶”ê°€
                otherMatch.players.forEach(player => {
                    if (!group.playerIds.has(player.spId)) {
                        group.players.push(player);
                        group.playerIds.add(player.spId);
                    }
                });
                
                processedMatches.add(j);
            }
        }
        
        // 2ê²½ê¸° ì´ìƒì¸ ê·¸ë£¹ë§Œ ì¶”ê°€
        if (group.matches.length >= 2) {
            groups.push(group);
            console.log(`ê·¸ë£¹ ìƒì„±: ${group.matches.length}ê²½ê¸°, ${group.players.length}ëª… ì„ ìˆ˜`);
        }
        
        processedMatches.add(i);
    }
    
    return groups;
}

// ë™ì¼ ì„ ìˆ˜ ê·¸ë£¹ í‚¤ ìƒì„± (7ëª… ì´ìƒ ê²¹ì¹˜ëŠ” ì„ ìˆ˜ë“¤ ê¸°ì¤€)
function generatePlayerGroupKey(players) {
    // ì„ ìˆ˜ IDë§Œìœ¼ë¡œ ì •ë ¬í•˜ì—¬ í‚¤ ìƒì„±
    const sortedPlayerIds = players
        .map(player => player.spId)
        .sort()
        .join('|');
    return sortedPlayerIds;
}

// í¬ë©”ì´ì…˜ í†µê³„ ê³„ì‚°
function calculateFormationStats(matches) {
    let totalGoals = 0;
    let totalConceded = 0;
    let wins = 0;
    let draws = 0;
    let losses = 0;
    let totalRating = 0;
    
    console.log(`ğŸ“Š calculateFormationStats í˜¸ì¶œ - ê²½ê¸° ìˆ˜: ${matches.length}`);
    if (matches.length > 0) {
        console.log('ì²« ë²ˆì§¸ ê²½ê¸° ë°ì´í„° êµ¬ì¡°:', {
            hasMatchResult: 'matchResult' in matches[0],
            matchResult: matches[0].matchResult,
            hasUserGoals: 'userGoals' in matches[0],
            userGoals: matches[0].userGoals,
            hasOpponentGoals: 'opponentGoals' in matches[0],
            opponentGoals: matches[0].opponentGoals,
            hasUserPlayers: 'userPlayers' in matches[0],
            userPlayersCount: matches[0].userPlayers?.length
        });
    }
    
    for (const match of matches) {
        // ê²½ê¸° ê²°ê³¼ë³„ ì¹´ìš´íŠ¸
        const matchResult = match.matchResult !== undefined ? match.matchResult : match.result;
        
        // matchResultê°€ ìˆ«ìì¸ ê²½ìš° (0: ë¬´, 1: ìŠ¹, 2: íŒ¨)
        if (typeof matchResult === 'number') {
            if (matchResult === 1) wins++;
            else if (matchResult === 0) draws++;
            else if (matchResult === 2) losses++;
        }
        // matchResultê°€ ë¬¸ìì—´ì¸ ê²½ìš°
        else if (typeof matchResult === 'string') {
            if (matchResult === 'ìŠ¹') wins++;
            else if (matchResult === 'ë¬´') draws++;
            else if (matchResult === 'íŒ¨') losses++;
        }
        
        // ë“ì /ì‹¤ì 
        totalGoals += (match.userGoals || match.userScore || 0);
        totalConceded += (match.opponentGoals || match.opponentScore || 0);
        
        // ì„ ìˆ˜ë³„ í‰ì  í•©ê³„ (userPlayers ì‚¬ìš©)
        const players = match.userPlayers || match.players || [];
        for (const player of players) {
            totalRating += player.status?.spRating || 0;
        }
    }
    
    console.log(`ê³„ì‚° ê²°ê³¼: ìŠ¹=${wins}, ë¬´=${draws}, íŒ¨=${losses}, ì´ë“ì =${totalGoals}, ì´ì‹¤ì =${totalConceded}`);
    
    const matchCount = matches.length;
    const winRate = matchCount > 0 ? (wins / matchCount) * 100 : 0;
    const avgRating = matchCount > 0 ? totalRating / (matchCount * 11) : 0;
    const avgGoals = matchCount > 0 ? totalGoals / matchCount : 0;
    const avgConcede = matchCount > 0 ? totalConceded / matchCount : 0;
    
    // ê²½ê¸° ê¸°ê°„ ê³„ì‚°
    let firstMatchDate = null;
    let lastMatchDate = null;
    
    if (matches.length > 0) {
        const sortedMatches = [...matches].sort((a, b) => new Date(a.matchDate) - new Date(b.matchDate));
        firstMatchDate = sortedMatches[0].matchDate;
        lastMatchDate = sortedMatches[sortedMatches.length - 1].matchDate;
    }
    
    return {
        matchCount,
        winRate: Math.round(winRate * 10) / 10,
        avgRating: Math.round(avgRating * 10) / 10,
        avgGoals,
        avgConcede,
        wins,
        draws,
        losses,
        firstMatchDate,
        lastMatchDate
    };
}

// êµ¬ë‹¨ë³„ í¬ë©”ì´ì…˜ ì¹´ë“œ í‘œì‹œ
function displayTeamFormationCards(formations) {
    console.log('displayTeamFormationCards í˜¸ì¶œë¨, formations ìˆ˜:', formations.length);
    console.log('teamCardsTrack:', teamCardsTrack);
    
    // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
    if (teamCardsTrack) {
        teamCardsTrack.innerHTML = '';
    }
    
    // ìŠ¬ë¼ì´ë” ë³€ìˆ˜ ì´ˆê¸°í™”
    currentSlideIndex = 0;
    totalSlides = Math.ceil(formations.length / cardsPerSlide);
    
    // ìŠ¬ë¼ì´ë“œë³„ë¡œ ì¹´ë“œ ê·¸ë£¹í™”
    for (let slideIndex = 0; slideIndex < totalSlides; slideIndex++) {
        const slide = document.createElement('div');
        slide.className = 'team-slide';
        
        // í˜„ì¬ ìŠ¬ë¼ì´ë“œì— ë“¤ì–´ê°ˆ ì¹´ë“œë“¤ (ìµœëŒ€ 2ê°œ)
        const startIndex = slideIndex * cardsPerSlide;
        const endIndex = Math.min(startIndex + cardsPerSlide, formations.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            const formation = formations[i];
            formation.formationId = i;
            const card = createTeamFormationCard(formation, i);
            slide.appendChild(card);
            console.log('ì¹´ë“œ ìƒì„±ë¨:', i, formation);
        }
        
        if (teamCardsTrack) {
            teamCardsTrack.appendChild(slide);
        }
    }
    
    // ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateSliderButtons();
    
    // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    setupSliderEventListeners();
    
    hideTeamLoading();
    const teamLayout = document.getElementById('teamLayout');
    if (teamLayout) {
        teamLayout.style.display = 'flex';
        console.log('teamLayout í‘œì‹œë¨');
    } else {
        console.error('teamLayout ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // teamDetailPanel í‘œì‹œ (ê°€ì´ë“œ)
    const teamDetailPanel = document.getElementById('teamDetailPanel');
    if (teamDetailPanel) {
        teamDetailPanel.style.display = 'block';
        console.log('teamDetailPanel ê°€ì´ë“œ í‘œì‹œë¨');
    }
    
    // teamCardGuide ìˆ¨ê¸°ê¸° (êµ¬ë‹¨ ì¹´ë“œê°€ í‘œì‹œë˜ë¯€ë¡œ)
    if (teamCardGuide) {
        teamCardGuide.style.display = 'none';
        console.log('teamCardGuide ìˆ¨ê¹€ (êµ¬ë‹¨ ì¹´ë“œ í‘œì‹œë¨)');
    }
    
    console.log('ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” ì™„ë£Œ - ì´ ìŠ¬ë¼ì´ë“œ:', totalSlides, 'í˜„ì¬ ìŠ¬ë¼ì´ë“œ:', currentSlideIndex);
}

// í¬ë©”ì´ì…˜ ì¹´ë“œ ìƒì„± (ê°„ì†Œí™”)
function createTeamFormationCard(formation, index) {
    const card = document.createElement('div');
    card.className = 'team-formation-card';
    card.dataset.formationId = index;
    
    // í´ëŸ½ ë²ˆí˜¸ + ëŒ€í‘œ ì„ ìˆ˜ 3ëª…ìœ¼ë¡œ ì´ë¦„ ìƒì„±
    const groupName = generatePlayerGroupName(index, formation.players);
    
    card.innerHTML = `
        <div class="team-formation-header">
            <div class="team-formation-name-container">
                <span class="team-formation-club">${groupName.clubName}</span>
                <span class="team-formation-players">${groupName.playerNames}</span>
            </div>
        </div>
        
        <div class="team-formation-stats">
            <div class="team-stat-single-row">
                <span class="team-stat-label">ìŠ¹ë¥  :</span>
                <span class="team-stat-value win-rate">${formation.winRate}%</span>
                <span class="team-stat-label">í‰ê·  í‰ì  :</span>
                <span class="team-stat-value">${formation.avgRating}</span>
                <span class="team-stat-label">ê²½ê¸°ìˆ˜ :</span>
                <span class="team-stat-value">${formation.matchCount}</span>
            </div>
        </div>
        
        <div class="team-formation-footer">
            <div class="team-match-period">${formatDate(formation.firstMatchDate)} ~ ${formatDate(formation.lastMatchDate)}</div>
        </div>
    `;
    
    // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
    card.addEventListener('click', () => {
        showFormationDetail(formation);
    });
    
    return card;
}

// ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupSliderEventListeners() {
    if (teamSliderPrevBtn) {
        teamSliderPrevBtn.addEventListener('click', () => {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                updateSliderPosition();
                updateSliderButtons();
            }
        });
    }
    
    if (teamSliderNextBtn) {
        teamSliderNextBtn.addEventListener('click', () => {
            if (currentSlideIndex < totalSlides - 1) {
                currentSlideIndex++;
                updateSliderPosition();
                updateSliderButtons();
            }
        });
    }
}

// ìŠ¬ë¼ì´ë” ìœ„ì¹˜ ì—…ë°ì´íŠ¸
function updateSliderPosition() {
    if (teamCardsTrack) {
        const translateX = -currentSlideIndex * 100; // ê° ìŠ¬ë¼ì´ë“œëŠ” 100% ë„ˆë¹„
        teamCardsTrack.style.transform = `translateX(${translateX}%)`;
        console.log('ìŠ¬ë¼ì´ë” ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', currentSlideIndex, 'translateX:', translateX);
    }
}

// ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSliderButtons() {
    if (teamSliderPrevBtn) {
        teamSliderPrevBtn.disabled = currentSlideIndex === 0;
    }
    
    if (teamSliderNextBtn) {
        teamSliderNextBtn.disabled = currentSlideIndex >= totalSlides - 1;
    }
    
    console.log('ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ - í˜„ì¬:', currentSlideIndex, 'ì´:', totalSlides);
}

// ë™ì¼ ì„ ìˆ˜ ê·¸ë£¹ ì´ë¦„ ìƒì„± (í´ëŸ½ ë²ˆí˜¸ + ëŒ€í‘œ ì„ ìˆ˜ 3ëª…)
function generatePlayerGroupName(groupIndex, players) {
    // ê° ì„ ìˆ˜ì˜ í‰ê·  í‰ì  ê³„ì‚° (ëª¨ë“  ê²½ê¸°ì—ì„œì˜ í‰ê· )
    const playerAvgRatings = players.map(player => {
        let totalRating = 0;
        let matchCount = 0;
        
        // í•´ë‹¹ ì„ ìˆ˜ê°€ ì¶œì „í•œ ëª¨ë“  ê²½ê¸°ì—ì„œì˜ í‰ì  í•©ê³„
        players.forEach(p => {
            if (p.spId === player.spId && p.status && p.status.spRating > 0) {
                totalRating += p.status.spRating;
                matchCount++;
            }
        });
        
        const avgRating = matchCount > 0 ? totalRating / matchCount : 0;
        return {
            ...player,
            avgRating: avgRating
        };
    });
    
    // í‰ê·  í‰ì ì´ ë†’ì€ ìƒìœ„ 3ëª… ì„ ìˆ˜ ì„ íƒ
    const topPlayers = playerAvgRatings
        .filter(player => player.avgRating > 0)
        .sort((a, b) => b.avgRating - a.avgRating)
        .slice(0, 3)
        .map(player => player.spName);
    
    const playerNames = topPlayers.length > 0 ? topPlayers.join(', ') : 'ì„ ìˆ˜ ì—†ìŒ';
    return {
        clubName: `êµ¬ë‹¨ ${groupIndex + 1}`,
        playerNames: playerNames
    };
}

// ì„ ìˆ˜ ì•„ì´í…œ ìƒì„±
function createTeamPlayerItem(player) {
    const positionName = getPositionName(player.spPosition);
    const rating = player.status.spRating || 0;
    
    return `
        <div class="team-player-item">
            <img src="${player.seasonImg}" alt="${player.spName}" class="team-player-image">
            <div class="team-player-name">${player.spName}</div>
            <div class="team-player-position">${positionName}</div>
            <div class="team-player-rating">${rating}</div>
        </div>
    `;
}

// ë™ì¼ ì„ ìˆ˜ ê·¸ë£¹ ìƒì„¸ ì •ë³´ í‘œì‹œ (ì˜¤ë¥¸ìª½ íŒ¨ë„)
function showFormationDetail(group) {
    console.log('showFormationDetail í˜¸ì¶œë¨:', group);
    
    // teamCardGuide ìˆ¨ê¸°ê¸°
    if (teamCardGuide) {
        teamCardGuide.style.display = 'none';
        console.log('teamCardGuide ìˆ¨ê¹€');
    }
    
    const detailPanel = document.getElementById('teamDetailPanel');
    if (!detailPanel) {
        console.error('teamDetailPanel ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const groupName = generatePlayerGroupName(group.formationId || 0, group.players);
    console.log('groupName:', groupName);
    
    // ì„ ìˆ˜ë³„ ì„±ê³¼ ë°ì´í„° ê³„ì‚°
    const playerStats = calculatePlayerStats(group);
    console.log('playerStats:', playerStats);
    
    // êµ¬ë‹¨ í†µê³„ ê³„ì‚°
    const teamStats = calculateTeamStats(group);
    console.log('teamStats:', teamStats);
    
                detailPanel.innerHTML = `
                    <div class="team-detail-header">
                        <div class="team-detail-title">
                            <h3>${groupName.clubName} : ${groupName.playerNames}</h3>
                            <p>ë™ì¼ ì„ ìˆ˜ 11ëª… ì¶œì „ â€¢ ${group.matchCount}ê²½ê¸°</p>
                        </div>
                    </div>
                    
                    <!-- êµ¬ë‹¨ í†µê³„ ì˜ì—­ -->
                        <div class="team-detail-content">
                    <div class="team-stats-section" id="teamStatsSection">
                        <h4 class="team-stats-title" id="teamStatsTitle">${groupName.clubName} í†µê³„</h4>
                        <div class="team-stats-cards">
                            <div class="stat-card">
                                <div class="stat-label">ìŠ¹ë¥ </div>
                                <div class="stat-value" id="teamWinRate">${teamStats.winRate}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">í‰ê·  í‰ì </div>
                                <div class="stat-value" id="teamAvgRating">${group.avgRating}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ê·¼ê±°ë¦¬</div>
                                <div class="stat-value" id="teamCloseRangeSuccess">${teamStats.closeRangeSuccess}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ì¤‘ê±°ë¦¬</div>
                                <div class="stat-value" id="teamMidRangeSuccess">${teamStats.midRangeSuccess}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">í—¤ë”©</div>
                                <div class="stat-value" id="teamHeadingSuccess">${teamStats.headingSuccess}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ìˆ˜ë¹„</div>
                                <div class="stat-value" id="teamDefenseSuccess">${teamStats.defenseSuccess}%</div>
                            </div>
                        </div>
                    </div>
                     </div>
                     
                    <div class="team-detail-content">
                        <div class="player-stats-section">
                            <h4>ì„ ìˆ˜ë³„ ì„±ê³¼</h4>
                            <div class="player-stats-table-container">
                                <table class="player-stats-table">
                                    <thead>
                                        <tr>
                                            <th class="player-info-header">ì„ ìˆ˜ ì •ë³´</th>
                                            <th class="stats-header sortable" data-sort="totalMatches">ê²½ê¸°ìˆ˜ <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable active" data-sort="avgRating">í‰ê·  í‰ì  <span class="sort-icon">â†“</span></th>
                                            <th class="stats-header sortable" data-sort="goals">ì´ê³¨ <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable" data-sort="assists">ì–´ì‹œìŠ¤íŠ¸ <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable" data-sort="passSuccessRate">íŒ¨ìŠ¤ <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable" data-sort="dribbleSuccessRate">ë“œë¦¬ë¸” <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable" data-sort="possessionSuccessRate">ë³¼ ì†Œìœ  <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable" data-sort="aerialSuccessRate">ê³µì¤‘ë³¼ <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable" data-sort="blockSuccessRate">ë¸”ë¡ë¥  <span class="sort-icon">â†•</span></th>
                                            <th class="stats-header sortable" data-sort="tackleSuccessRate">íƒœí´ë¥  <span class="sort-icon">â†•</span></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(() => {
                                            // ì„ ìˆ˜ë³„ ìƒì„¸ ë°ì´í„° ì €ì¥
                                            currentPlayerStatsDetails = {};
                                            playerStats.forEach(player => {
                                                currentPlayerStatsDetails[player.spId] = {
                                                    ...player,
                                                    // ì¶”ê°€ ìƒì„¸ ë°ì´í„°
                                                    passTry: player.passTry || 0,
                                                    passSuccess: player.passSuccess || 0,
                                                    dribbleTry: player.dribbleTry || 0,
                                                    dribbleSuccess: player.dribbleSuccess || 0,
                                                    possessionTry: player.possessionTry || 0,
                                                    possessionSuccess: player.possessionSuccess || 0,
                                                    aerialDuels: player.aerialDuels || 0,
                                                    aerialDuelsWon: player.aerialDuelsWon || 0,
                                                    blockTry: player.blockTry || 0,
                                                    blocks: player.blocks || 0,
                                                    tackleTry: player.tackleTry || 0,
                                                    tackles: player.tackles || 0
                                                };
                                            });
                                            return playerStats.map(player => createPlayerStatsCard(player)).join('');
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
    
    // teamDetailPanel í‘œì‹œ
    detailPanel.style.display = 'block';
    console.log('teamDetailPanel í‘œì‹œë¨');
    
    // í†µê³„ ê°’ì— ìƒ‰ìƒ ì ìš©
    applyStatColors(teamStats, group);
    
    // ì¹´ë“œ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateSelectedCard(group);
    
    // í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥ ì´ˆê¸°í™”
    initializeTableSorting();
}

// êµ¬ë‹¨ í†µê³„ ê³„ì‚°
function calculateTeamStats(group) {
    const matches = group.matches || [];
    if (matches.length === 0) {
        return {
            winRate: 0,
            closeRangeSuccess: 0,
            midRangeSuccess: 0,
            headingSuccess: 0,
            defenseSuccess: 0
        };
    }
    
    let totalWins = 0;
    let totalCloseRangeGoals = 0;
    let totalCloseRangeAttempts = 0;
    let totalMidRangeGoals = 0;
    let totalMidRangeAttempts = 0;
    let totalHeadingGoals = 0;
    let totalHeadingAttempts = 0;
    let totalBlockSuccess = 0;
    let totalBlockTry = 0;
    let totalTackleSuccess = 0;
    let totalTackleTry = 0;
    
    matches.forEach(match => {
        // ìŠ¹ë¥  ê³„ì‚°
        if (match.result === 'ìŠ¹') totalWins++;
        
        // íŒ€ ì „ì²´ ìŠˆíŒ… í†µê³„ (userStats.shootì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        if (match.userStats && match.userStats.shoot) {
            const shoot = match.userStats.shoot;
            
            // ë””ë²„ê¹…: shoot ê°ì²´ì˜ ì£¼ìš” í•„ë“œ í™•ì¸
            console.log(`ê²½ê¸° ${match.matchId} shoot ê°ì²´ í‚¤ë“¤:`, Object.keys(shoot));
            console.log(`ê²½ê¸° ${match.matchId} shoot ë°ì´í„°:`, {
                goalTotal: shoot.goalTotal,
                goalInPenalty: shoot.goalInPenalty,
                goalOutPenalty: shoot.goalOutPenalty,
                goalHeading: shoot.goalHeading,
                shootTotal: shoot.shootTotal,
                shootInPenalty: shoot.shootInPenalty,
                shootOutPenalty: shoot.shootOutPenalty,
                shootHeading: shoot.shootHeading
            });
            
            // ê·¼ê±°ë¦¬ ì„±ê³µë¥  (í˜ë„í‹°ë°•ìŠ¤ ì•ˆ) - FIFA Online 4 API ì‹¤ì œ í•„ë“œëª… ì‚¬ìš©
            const goalInPenalty = shoot.goalInPenalty || shoot.goalInPenaltyBox || shoot.goalInBox || shoot.goalInsideBox || 0;
            const shootInPenalty = shoot.shootInPenalty || shoot.shootInPenaltyBox || shoot.shootInBox || shoot.shootInsideBox || 0;
            totalCloseRangeGoals += goalInPenalty;
            totalCloseRangeAttempts += shootInPenalty;
            
            // ì¤‘ê±°ë¦¬ ì„±ê³µë¥  (í˜ë„í‹°ë°•ìŠ¤ ë°–) - FIFA Online 4 API ì‹¤ì œ í•„ë“œëª… ì‚¬ìš©
            const goalOutPenalty = shoot.goalOutPenalty || shoot.goalOutPenaltyBox || shoot.goalOutBox || shoot.goalOutsideBox || 0;
            const shootOutPenalty = shoot.shootOutPenalty || shoot.shootOutPenaltyBox || shoot.shootOutBox || shoot.shootOutsideBox || 0;
            totalMidRangeGoals += goalOutPenalty;
            totalMidRangeAttempts += shootOutPenalty;
            
            // í—¤ë”© ì„±ê³µë¥  - FIFA Online 4 API ì‹¤ì œ í•„ë“œëª… ì‚¬ìš©
            const goalHeading = shoot.goalHeading || shoot.goalHead || shoot.headingGoal || shoot.goalHeader || 0;
            const shootHeading = shoot.shootHeading || shoot.shootHead || shoot.headingShoot || shoot.shootHeader || 0;
            totalHeadingGoals += goalHeading;
            totalHeadingAttempts += shootHeading;
            
            console.log(`ê²½ê¸° ${match.matchId} íŒ€ ìŠˆíŒ… í†µê³„:`, {
                goalInPenalty, shootInPenalty,
                goalOutPenalty, shootOutPenalty,
                goalHeading, shootHeading
            });
        } else {
            console.log(`ê²½ê¸° ${match.matchId}: íŒ€ ìŠˆíŒ… ë°ì´í„° ì—†ìŒ`);
            console.log(`ê²½ê¸° ${match.matchId} userStats:`, match.userStats);
        }
        
        // ìˆ˜ë¹„ í†µê³„ëŠ” ê°œë³„ ì„ ìˆ˜ ë°ì´í„° í•©ì‚° (ë¸”ë¡ + íƒœí´)
        match.players.forEach(player => {
            const blockSuccess = player.status?.blockSuccess || 0;
            const blockTry = player.status?.blockTry || 0;
            const tackleSuccess = player.status?.tackleSuccess || 0;
            const tackleTry = player.status?.tackleTry || 0;
            
            totalBlockSuccess += blockSuccess;
            totalBlockTry += blockTry;
            totalTackleSuccess += tackleSuccess;
            totalTackleTry += tackleTry;
        });
    });
    
    // ì„±ê³µë¥  ê³„ì‚°
    const winRate = Math.round((totalWins / matches.length) * 100);
    const closeRangeSuccess = totalCloseRangeAttempts > 0 ? Math.round((totalCloseRangeGoals / totalCloseRangeAttempts) * 100) : 0;
    const midRangeSuccess = totalMidRangeAttempts > 0 ? Math.round((totalMidRangeGoals / totalMidRangeAttempts) * 100) : 0;
    const headingSuccess = totalHeadingAttempts > 0 ? Math.round((totalHeadingGoals / totalHeadingAttempts) * 100) : 0;
    
    console.log('êµ¬ë‹¨ í†µê³„ ê³„ì‚° ê²°ê³¼:', {
        totalCloseRangeGoals, totalCloseRangeAttempts, closeRangeSuccess,
        totalMidRangeGoals, totalMidRangeAttempts, midRangeSuccess,
        totalHeadingGoals, totalHeadingAttempts, headingSuccess
    });
    
    // ìˆ˜ë¹„ ì„±ê³µë¥  (ë¸”ë¡ê³¼ íƒœí´ì˜ í•©ê³„)
    const totalDefenseSuccess = totalBlockSuccess + totalTackleSuccess;
    const totalDefenseTry = totalBlockTry + totalTackleTry;
    const defenseSuccess = totalDefenseTry > 0 ? Math.round((totalDefenseSuccess / totalDefenseTry) * 100) : 0;
    
    return {
        winRate,
        closeRangeSuccess,
        midRangeSuccess,
        headingSuccess,
        defenseSuccess
    };
}

// í†µê³„ ê°’ì— ìƒ‰ìƒ ì ìš©
function applyStatColors(stats, group) {
    // êµ¬ë‹¨ë³„ ë°ì´í„° íŒ¨ë„ ë‚´ì˜ ìš”ì†Œë“¤ë§Œ ì„ íƒ (ëŒ€ì‹œë³´ë“œì™€ ID ì¶©ëŒ ë°©ì§€)
    const detailPanel = document.getElementById('teamDetailPanel');
    if (!detailPanel) return;
    
    const winRate = detailPanel.querySelector('#teamWinRate');
    const avgRating = detailPanel.querySelector('#teamAvgRating');
    const closeRangeSuccess = detailPanel.querySelector('#teamCloseRangeSuccess');
    const midRangeSuccess = detailPanel.querySelector('#teamMidRangeSuccess');
    const headingSuccess = detailPanel.querySelector('#teamHeadingSuccess');
    const defenseSuccess = detailPanel.querySelector('#teamDefenseSuccess');
    
    if (winRate) {
        winRate.className = `stat-value ${getStatClass(stats.winRate, 'winRate')}`;
    }
    
    if (avgRating) {
        avgRating.className = `stat-value ${getStatClass(parseFloat(group.avgRating), 'rating')}`;
    }
    
    if (closeRangeSuccess) {
        closeRangeSuccess.className = `stat-value ${getStatClass(stats.closeRangeSuccess, 'success')}`;
    }
    
    if (midRangeSuccess) {
        midRangeSuccess.className = `stat-value ${getStatClass(stats.midRangeSuccess, 'success')}`;
    }
    
    if (headingSuccess) {
        headingSuccess.className = `stat-value ${getStatClass(stats.headingSuccess, 'success')}`;
    }
    
    if (defenseSuccess) {
        defenseSuccess.className = `stat-value ${getStatClass(stats.defenseSuccess, 'success')}`;
    }
}

// í†µê³„ ê°’ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ë°˜í™˜
function getStatClass(value, type) {
    if (type === 'winRate') {
        if (value >= 70) return 'high';
        if (value >= 50) return 'medium';
        return 'low';
    } else if (type === 'success') {
        if (value >= 60) return 'high';
        if (value >= 40) return 'medium';
        return 'low';
    } else if (type === 'rating') {
        if (value >= 7.0) return 'high';
        if (value >= 6.0) return 'medium';
        return 'low';
    }
    return '';
}

// ì„ ìˆ˜ë³„ ì„±ê³¼ ë°ì´í„° ê³„ì‚°
function calculatePlayerStats(group) {
    const playerStatsMap = new Map();
    
    // ê° ê²½ê¸°ì—ì„œì˜ ì„ ìˆ˜ ì„±ê³¼ ìˆ˜ì§‘
    group.matches.forEach(match => {
        match.players.forEach(player => {
            const playerId = player.spId;
            
            if (!playerStatsMap.has(playerId)) {
                playerStatsMap.set(playerId, {
                    spId: player.spId,
                    spName: player.spName,
                    spPosition: player.spPosition,
                    spGrade: player.spGrade,
                    seasonImg: player.seasonImg,
                    season: player.season, // ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ season ì •ë³´ ì €ì¥
                    totalMatches: 0,
                    totalRating: 0,
                    avgRating: 0,
                    maxRating: 0,
                    minRating: 10,
                    goals: 0,
                    assists: 0,
                    // íŒ¨ìŠ¤ í†µê³„
                    passSuccess: 0,
                    passTry: 0,
                    passSuccessRate: 0,
                    // ë“œë¦¬ë¸” í†µê³„
                    dribbleSuccess: 0,
                    dribbleTry: 0,
                    dribbleSuccessRate: 0,
                    // ë³¼ ì†Œìœ  í†µê³„
                    possessionSuccess: 0,
                    possessionTry: 0,
                    possessionSuccessRate: 0,
                    // ìˆ˜ë¹„ í†µê³„
                    blocks: 0,
                    blockTry: 0,
                    blockSuccessRate: 0,
                    tackles: 0,
                    tackleTry: 0,
                    tackleSuccessRate: 0,
                    // ê³µì¤‘ë³¼ í†µê³„
                    aerialDuels: 0,
                    aerialDuelsWon: 0,
                    aerialSuccessRate: 0,
                    matches: []
                });
            }
            
            const stats = playerStatsMap.get(playerId);
            const rating = player.status.spRating || 0;
            
            stats.totalMatches++;
            stats.totalRating += rating;
            stats.maxRating = Math.max(stats.maxRating, rating);
            stats.minRating = Math.min(stats.minRating, rating);
            stats.goals += player.status.goal || 0;
            stats.assists += player.status.assist || 0;
            
            // íŒ¨ìŠ¤ í†µê³„
            stats.passSuccess += player.status.passSuccess || player.status.pass || 0;
            stats.passTry += player.status.passTry || player.status.passTry || 0;
            
            // ë“œë¦¬ë¸” í†µê³„
            stats.dribbleSuccess += player.status.dribbleSuccess || player.status.dribble || 0;
            stats.dribbleTry += player.status.dribbleTry || player.status.dribbleTry || 0;
            
            // ë³¼ ì†Œìœ  í†µê³„ (íŒ¨ìŠ¤ì™€ ë“œë¦¬ë¸”ì˜ ì¡°í•©ìœ¼ë¡œ ì¶”ì •)
            stats.possessionSuccess += (player.status.passSuccess || player.status.pass || 0) + (player.status.dribbleSuccess || player.status.dribble || 0);
            stats.possessionTry += (player.status.passTry || player.status.passTry || 0) + (player.status.dribbleTry || player.status.dribbleTry || 0);
            
            // ìˆ˜ë¹„ í†µê³„
            const blockCount = player.status.blockSuccess || player.status.block || 0;
            const blockTryCount = player.status.blockTry || 0;
            const tackleCount = player.status.tackleSuccess || player.status.tackle || 0;
            const tackleTryCount = player.status.tackleTry || 0;
            
            stats.blocks += blockCount;
            stats.blockTry += blockTryCount;
            stats.tackles += tackleCount;
            stats.tackleTry += tackleTryCount;
            
            // ê³µì¤‘ë³¼ í†µê³„
            const aerialTry = player.status.aerialTry || 0;
            const aerialSuccess = player.status.aerialSuccess || 0;
            stats.aerialDuels += aerialTry;
            stats.aerialDuelsWon += aerialSuccess;
            
            // ê³¨í‚¤í¼ ì„ ë°© (ê³¨í‚¤í¼ í¬ì§€ì…˜ì¸ ê²½ìš°)
            if (player.spPosition === 1) { // ê³¨í‚¤í¼ í¬ì§€ì…˜
                const saveCount = player.status.goal || 0; // ê³¨í‚¤í¼ì˜ ê²½ìš° ê³¨ì„ ì„ ë°©ìœ¼ë¡œ ê°„ì£¼
                stats.saves += saveCount;
            }
            
            // ë””ë²„ê¹… ë¡œê·¸
            if (blockCount > 0 || tackleCount > 0) {
                console.log(`ì„ ìˆ˜ ${player.spName}: ë¸”ë¡=${blockCount}, íƒœí´=${tackleCount}`);
            }
            
            stats.matches.push({
                matchId: match.matchId,
                matchDate: match.matchDate,
                rating: rating,
                goal: player.status.goal || 0,
                assist: player.status.assist || 0,
                matchResult: match.matchResult
            });
        });
    });
    
    // í‰ê·  í‰ì  ë° ì„±ê³µë¥  ê³„ì‚° ë° ì •ë ¬
    const playerStats = Array.from(playerStatsMap.values()).map(stats => {
        // ê³µì¤‘ë³¼ ì„±ê³µë¥  ê³„ì‚°
        stats.aerialSuccessRate = stats.aerialDuels > 0 ? Math.round((stats.aerialDuelsWon / stats.aerialDuels) * 100) : 0;
        
        // ë¸”ë¡ ì„±ê³µë¥  ê³„ì‚°
        stats.blockSuccessRate = stats.blockTry > 0 ? Math.round((stats.blocks / stats.blockTry) * 100) : 0;
        
        // íƒœí´ ì„±ê³µë¥  ê³„ì‚°
        stats.tackleSuccessRate = stats.tackleTry > 0 ? Math.round((stats.tackles / stats.tackleTry) * 100) : 0;
        stats.avgRating = stats.totalMatches > 0 ? (stats.totalRating / stats.totalMatches).toFixed(1) : 0;
        
        // íŒ¨ìŠ¤ ì„±ê³µë¥  ê³„ì‚°
        stats.passSuccessRate = stats.passTry > 0 ? Math.round((stats.passSuccess / stats.passTry) * 100) : 0;
        
        // ë“œë¦¬ë¸” ì„±ê³µë¥  ê³„ì‚°
        stats.dribbleSuccessRate = stats.dribbleTry > 0 ? Math.round((stats.dribbleSuccess / stats.dribbleTry) * 100) : 0;
        
        // ë³¼ ì†Œìœ  ì„±ê³µë¥  ê³„ì‚°
        stats.possessionSuccessRate = stats.possessionTry > 0 ? Math.round((stats.possessionSuccess / stats.possessionTry) * 100) : 0;
        
        // ë””ë²„ê¹… ë¡œê·¸
        console.log(`ì„ ìˆ˜ ${stats.spName}: ë¸”ë¡=${stats.blocks}, íƒœí´=${stats.tackles}, ì„ ë°©=${stats.saves}`);
        
        return stats;
    }).sort((a, b) => b.avgRating - a.avgRating);
    
    return playerStats;
}

// ì„ ìˆ˜ ì„±ê³¼ ì¹´ë“œ ìƒì„±
function createPlayerStatsCard(player) {
    const positionName = getPositionName(player.spPosition);
    const ratingColor = getRatingColor(player.avgRating);
    
    // ì‹œì¦Œ ì´ë¯¸ì§€ ì²˜ë¦¬ - ë³´ë¼ìƒ‰ ë°•ìŠ¤ ì—†ì´ ì§ì ‘ ì´ë¯¸ì§€ í‘œì‹œ
    let seasonDisplay;
    if (player.season?.seasonImg) {
        seasonDisplay = `<img src="${player.season.seasonImg}" alt="ì‹œì¦Œ" class="season-image" onerror="this.style.display='none'"/>`;
    } else if (player.seasonImg && player.seasonImg !== 'N/A' && player.seasonImg.includes('http')) {
        seasonDisplay = `<img src="${player.seasonImg}" alt="ì‹œì¦Œ" class="season-image" onerror="this.style.display='none'"/>`;
    } else {
        // ì‹œì¦Œ IDê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ê³µê°„ìœ¼ë¡œ ì²˜ë¦¬
        seasonDisplay = `<div class="season-placeholder"></div>`;
    }
    
    return `
        <tr class="player-stats-row">
            <td class="player-info-cell">
                <div class="player-info">
                    <div class="player-position-badge">${positionName}</div>
                    ${seasonDisplay}
                    <div class="player-grade-badge">+${player.spGrade}</div>
                    <div class="player-name">${player.spName}</div>
                </div>
            </td>
            <td class="stats-cell">${player.totalMatches}ê²½ê¸°</td>
            <td class="stats-cell rating-${ratingColor}">${player.avgRating}</td>
            <td class="stats-cell">${player.goals}ê³¨</td>
            <td class="stats-cell">${player.assists}ê°œ</td>
            <td class="stats-cell clickable-percent" data-player-id="${player.spId}" data-stat-type="pass" onclick="showPlayerStatPopup('${player.spId}', 'pass', '${player.spName}')">${player.passSuccessRate}%</td>
            <td class="stats-cell clickable-percent" data-player-id="${player.spId}" data-stat-type="dribble" onclick="showPlayerStatPopup('${player.spId}', 'dribble', '${player.spName}')">${player.dribbleSuccessRate}%</td>
            <td class="stats-cell clickable-percent" data-player-id="${player.spId}" data-stat-type="possession" onclick="showPlayerStatPopup('${player.spId}', 'possession', '${player.spName}')">${player.possessionSuccessRate}%</td>
            <td class="stats-cell clickable-percent" data-player-id="${player.spId}" data-stat-type="aerial" onclick="showPlayerStatPopup('${player.spId}', 'aerial', '${player.spName}')">${player.aerialSuccessRate || 0}%</td>
            <td class="stats-cell clickable-percent" data-player-id="${player.spId}" data-stat-type="block" onclick="showPlayerStatPopup('${player.spId}', 'block', '${player.spName}')">${player.blockSuccessRate || 0}%</td>
            <td class="stats-cell clickable-percent" data-player-id="${player.spId}" data-stat-type="tackle" onclick="showPlayerStatPopup('${player.spId}', 'tackle', '${player.spName}')">${player.tackleSuccessRate || 0}%</td>
        </tr>
    `;
}

// í‰ì ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜
function getRatingColor(rating) {
    const numRating = parseFloat(rating);
    if (numRating >= 8.0) return 'rating-excellent';
    if (numRating >= 7.0) return 'rating-good';
    if (numRating >= 6.0) return 'rating-average';
    return 'rating-poor';
}

// í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥ ì´ˆê¸°í™”
function initializeTableSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    let currentSort = { column: 'avgRating', direction: 'desc' }; // ê¸°ë³¸ê°’: í‰ê·  í‰ì  ë‚´ë¦¼ì°¨ìˆœ
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.sort;
            
            // ê°™ì€ ì»¬ëŸ¼ì„ í´ë¦­í•˜ë©´ ë°©í–¥ ì „í™˜, ë‹¤ë¥¸ ì»¬ëŸ¼ì„ í´ë¦­í•˜ë©´ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.direction = 'desc';
            }
            currentSort.column = column;
            
            // ì •ë ¬ ì‹¤í–‰
            sortPlayerTable(column, currentSort.direction);
            
            // í—¤ë” ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            updateSortIcons(column, currentSort.direction);
        });
    });
}

// ì„ ìˆ˜ í…Œì´ë¸” ì •ë ¬
function sortPlayerTable(column, direction) {
    const tbody = document.querySelector('.player-stats-table tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        // ê° ì»¬ëŸ¼ì— ë§ëŠ” ë°ì´í„° ì¶”ì¶œ
        switch (column) {
            case 'totalMatches':
                aValue = parseInt(a.cells[1].textContent.replace('ê²½ê¸°', ''));
                bValue = parseInt(b.cells[1].textContent.replace('ê²½ê¸°', ''));
                break;
            case 'avgRating':
                aValue = parseFloat(a.cells[2].textContent);
                bValue = parseFloat(b.cells[2].textContent);
                break;
            case 'goals':
                aValue = parseInt(a.cells[3].textContent.replace('ê³¨', ''));
                bValue = parseInt(b.cells[3].textContent.replace('ê³¨', ''));
                break;
            case 'assists':
                aValue = parseInt(a.cells[4].textContent.replace('ê°œ', ''));
                bValue = parseInt(b.cells[4].textContent.replace('ê°œ', ''));
                break;
            case 'passSuccessRate':
                aValue = parseInt(a.cells[5].textContent.replace('%', ''));
                bValue = parseInt(b.cells[5].textContent.replace('%', ''));
                break;
            case 'dribbleSuccessRate':
                aValue = parseInt(a.cells[6].textContent.replace('%', ''));
                bValue = parseInt(b.cells[6].textContent.replace('%', ''));
                break;
            case 'possessionSuccessRate':
                aValue = parseInt(a.cells[7].textContent.replace('%', ''));
                bValue = parseInt(b.cells[7].textContent.replace('%', ''));
                break;
            case 'aerialSuccessRate':
                aValue = parseInt(a.cells[8].textContent.replace('%', ''));
                bValue = parseInt(b.cells[8].textContent.replace('%', ''));
                break;
            case 'blockSuccessRate':
                aValue = parseInt(a.cells[9].textContent.replace('%', ''));
                bValue = parseInt(b.cells[9].textContent.replace('%', ''));
                break;
            case 'tackleSuccessRate':
                aValue = parseInt(a.cells[10].textContent.replace('%', ''));
                bValue = parseInt(b.cells[10].textContent.replace('%', ''));
                break;
            default:
                return 0;
        }
        
        // NaN ì²˜ë¦¬
        if (isNaN(aValue)) aValue = 0;
        if (isNaN(bValue)) bValue = 0;
        
        // ì •ë ¬ ë°©í–¥ì— ë”°ë¼ ë¹„êµ
        if (direction === 'asc') {
            return aValue - bValue;
        } else {
            return bValue - aValue;
        }
    });
    
    // ì •ë ¬ëœ í–‰ë“¤ì„ ë‹¤ì‹œ í…Œì´ë¸”ì— ì¶”ê°€
    rows.forEach(row => tbody.appendChild(row));
}

// ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
function updateSortIcons(activeColumn, direction) {
    const sortableHeaders = document.querySelectorAll('.sortable');
    
    sortableHeaders.forEach(header => {
        const icon = header.querySelector('.sort-icon');
        const column = header.dataset.sort;
        
        if (column === activeColumn) {
            header.classList.add('active');
            icon.textContent = direction === 'asc' ? 'â†‘' : 'â†“';
        } else {
            header.classList.remove('active');
            icon.textContent = 'â†•';
        }
    });
}

// ì„ íƒëœ ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSelectedCard(selectedFormation) {
    const cards = document.querySelectorAll('.team-formation-card');
    cards.forEach(card => {
        card.classList.remove('selected');
    });
    
    // ì„ íƒëœ ì¹´ë“œì— selected í´ë˜ìŠ¤ ì¶”ê°€
    const selectedCard = document.querySelector(`[data-formation-id="${selectedFormation.formationId || 0}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
}

// í¬ë©”ì´ì…˜ ìƒì„¸ ëª¨ë‹¬ ìƒì„±
function createFormationDetailModal(formation) {
    const modal = document.createElement('div');
    modal.className = 'team-formation-modal-overlay';
    
    const formationName = generateFormationName(formation.players);
    
    modal.innerHTML = `
        <div class="team-formation-modal">
            <div class="team-formation-modal-header">
                <div class="team-formation-modal-title">
                    <h3>${formationName}</h3>
                    <p>ë™ì¼ ì„ ìˆ˜ 11ëª… ì¶œì „ â€¢ ${formation.matchCount}ê²½ê¸°</p>
                </div>
                <button class="team-formation-modal-close">&times;</button>
            </div>
            <div class="team-formation-modal-content">
                <div class="team-formation-matches">
                    ${formation.matches.map(match => createFormationMatchItem(match)).join('')}
                </div>
            </div>
        </div>
    `;
    
    return modal;
}

// í¬ë©”ì´ì…˜ ê²½ê¸° ì•„ì´í…œ ìƒì„±
function createFormationMatchItem(match) {
    const resultClass = match.matchResult === 'ìŠ¹' ? 'win' : match.matchResult === 'íŒ¨' ? 'lose' : 'draw';
    
    return `
        <div class="team-formation-match-item">
            <div class="team-formation-match-header">
                <div class="team-formation-match-date">${formatDate(match.matchDate)}</div>
                <div class="team-formation-match-result ${resultClass}">${match.matchResult}</div>
            </div>
            <div class="team-formation-match-details">
                <div class="team-formation-match-opponent">vs ìƒëŒ€íŒ€</div>
                <div class="team-formation-match-score">${getMatchScore(match.matchId)}</div>
                <div class="team-formation-match-opponent">${match.matchType === 50 ? 'ê³µì‹ê²½ê¸°' : 'ì¹œì„ ê²½ê¸°'}</div>
            </div>
            <div class="team-formation-match-players">
                ${match.players.map(player => createFormationMatchPlayer(player)).join('')}
            </div>
        </div>
    `;
}

// í¬ë©”ì´ì…˜ ê²½ê¸° ì„ ìˆ˜ ì•„ì´í…œ ìƒì„±
function createFormationMatchPlayer(player) {
    const positionName = getPositionName(player.spPosition);
    const rating = player.status.spRating || 0;
    const goals = player.status.goal || 0;
    const assists = player.status.assist || 0;
    
    return `
        <div class="team-formation-match-player">
            <img src="${player.seasonImg}" alt="${player.spName}" class="team-formation-match-player-image">
            <div class="team-formation-match-player-name">${player.spName}</div>
            <div class="team-formation-match-player-stats">
                <div class="team-formation-match-player-stat">
                    <div class="team-formation-match-player-stat-label">í‰ì </div>
                    <div class="team-formation-match-player-stat-value rating">${rating}</div>
                </div>
                <div class="team-formation-match-player-stat">
                    <div class="team-formation-match-player-stat-label">ê³¨</div>
                    <div class="team-formation-match-player-stat-value goals">${goals}</div>
                </div>
                <div class="team-formation-match-player-stat">
                    <div class="team-formation-match-player-stat-label">ì–´ì‹œ</div>
                    <div class="team-formation-match-player-stat-value assists">${assists}</div>
                </div>
            </div>
        </div>
    `;
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeFormationDetailModal(modal) {
    modal.classList.remove('show');
    setTimeout(() => {
        document.body.removeChild(modal);
    }, 300);
}

// ë¡œë”© í‘œì‹œ
function showTeamLoading(message = 'êµ¬ë‹¨ë³„ ë°ì´í„° ë¶„ì„ ì¤‘...') {
    if (teamLoading) {
        teamLoading.style.display = 'flex';
        
        // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        const loadingText = teamLoading.querySelector('span');
        if (loadingText) {
            loadingText.textContent = message;
        }
    }
    
    if (teamCardsContainer) teamCardsContainer.style.display = 'none';
    if (noTeamData) noTeamData.style.display = 'none';
}

// ë¡œë”© ìˆ¨ê¸°ê¸°
function hideTeamLoading() {
    if (teamLoading) {
        teamLoading.style.display = 'none';
    }
}

// êµ¬ë‹¨ë³„ ë°ì´í„° ì´ˆê¸°í™”
function clearTeamData() {
    console.log('êµ¬ë‹¨ë³„ ë°ì´í„° ì´ˆê¸°í™” ì¤‘...');
    
    // ëª¨ë“  ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
    if (teamLoading) teamLoading.style.display = 'none';
    if (teamCardsContainer) teamCardsContainer.style.display = 'none';
    if (noTeamData) noTeamData.style.display = 'none';
    
    // teamDetailPanelì€ ê°€ì´ë“œë¡œ ì´ˆê¸°í™” (ìˆ¨ê¸°ì§€ ì•ŠìŒ)
    if (teamDetailPanel) {
        teamDetailPanel.innerHTML = `
            <div class="team-detail-placeholder">
                <div class="placeholder-icon">âš½</div>
                <h4>êµ¬ë‹¨ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h4>
                <p>ìœ„ì—ì„œ êµ¬ë‹¨ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        `;
    }
    
    // teamCardGuide í‘œì‹œ (ë‹¤ë¥¸ íƒ­ì—ì„œ ëŒì•„ì˜¬ ë•Œ)
    if (teamCardGuide) {
        teamCardGuide.style.display = 'block';
    }
    
    // ìµœê³ ì˜ ì„ ìˆ˜ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    const topPlayersSection = document.getElementById('topPlayersSection');
    if (topPlayersSection) {
        topPlayersSection.style.display = 'none';
    }
    
    // ì¹´ë“œ ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°
    if (teamCardsContainer) {
        teamCardsContainer.innerHTML = '';
    }
    
    // teamLayout ìˆ¨ê¸°ê¸°
    const teamLayout = document.getElementById('teamLayout');
    if (teamLayout) {
        teamLayout.style.display = 'none';
    }
    
    // teamCardsTrack ë¹„ìš°ê¸°
    const teamCardsTrack = document.getElementById('teamCardsTrack');
    if (teamCardsTrack) {
        teamCardsTrack.innerHTML = '';
        teamCardsTrack.style.transform = 'translateX(0%)';
    }
    
    // topPlayersTrack ë¹„ìš°ê¸°
    const topPlayersTrack = document.getElementById('topPlayersTrack');
    if (topPlayersTrack) {
        topPlayersTrack.innerHTML = '';
        topPlayersTrack.style.transform = 'translateX(0%)';
    }
    
    // ìƒì„¸ íŒ¨ë„ ì´ˆê¸°í™”ëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨
    
    // ë°ì´í„° ë³€ìˆ˜ ì´ˆê¸°í™”
    teamFormationData = {};
    
    // ìŠ¬ë¼ì´ë” ë³€ìˆ˜ ì´ˆê¸°í™”
    currentSlideIndex = 0;
    totalSlides = 0;
    topPlayersCurrentSlideIndex = 0;
    topPlayersTotalSlides = 0;
    
    // ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
    const teamSliderPrevBtn = document.getElementById('teamSliderPrevBtn');
    const teamSliderNextBtn = document.getElementById('teamSliderNextBtn');
    const topPlayersPrevBtn = document.getElementById('topPlayersPrevBtn');
    const topPlayersNextBtn = document.getElementById('topPlayersNextBtn');
    
    if (teamSliderPrevBtn) teamSliderPrevBtn.disabled = true;
    if (teamSliderNextBtn) teamSliderNextBtn.disabled = true;
    if (topPlayersPrevBtn) {
        topPlayersPrevBtn.disabled = true;
        topPlayersPrevBtn.style.display = 'none';
    }
    if (topPlayersNextBtn) {
        topPlayersNextBtn.disabled = true;
        topPlayersNextBtn.style.display = 'none';
    }
    
    console.log('êµ¬ë‹¨ë³„ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
}

// ë°ì´í„° ì—†ìŒ í‘œì‹œ
function showNoTeamData() {
    console.log('ë°ì´í„° ì—†ìŒ í‘œì‹œ');
    hideTeamLoading();
    teamCardsContainer.style.display = 'none';
    noTeamData.style.display = 'block';
}

// í¬ì§€ì…˜ ì´ë¦„ ë³€í™˜

// ê²½ê¸° ì ìˆ˜ ê°€ì ¸ì˜¤ê¸° (ê°„ë‹¨í•œ êµ¬í˜„)
function getMatchScore(matchId) {
    // ì‹¤ì œë¡œëŠ” ê²½ê¸° ìƒì„¸ ì •ë³´ì—ì„œ ì ìˆ˜ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
    // ì„ì‹œë¡œ ëœë¤ ì ìˆ˜ ë°˜í™˜
    const scores = ['1-0', '2-1', '3-2', '2-0', '1-1', '0-1', '1-2'];
    return scores[Math.floor(Math.random() * scores.length)];
}

// ë‚ ì§œ í¬ë§·íŒ…
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

// êµ¬ë‹¨ë³„ ë°ì´í„°ìš© ìµœê³ ì˜ ì„ ìˆ˜ ë°ì´í„° í‘œì‹œ
function displayTeamTopPlayers(matches) {
    console.log('ìµœê³ ì˜ ì„ ìˆ˜ ë°ì´í„° ê³„ì‚° ì¤‘...');
    
    const playerStats = {};
    
    // ëª¨ë“  ê²½ê¸°ì—ì„œ ì„ ìˆ˜ í†µê³„ ìˆ˜ì§‘
    matches.forEach(match => {
        if (match.userPlayers) {
            match.userPlayers.forEach(player => {
                if (player.status && player.status.spRating) {
                    const playerId = player.spId;
                    const playerName = player.spName;
                    
                    if (!playerStats[playerId]) {
                        playerStats[playerId] = {
                            name: playerName,
                            spId: playerId,
                            seasonId: player.seasonId || player.spId || 'default',
                            season: player.season || null, // season ì •ë³´ ì¶”ê°€
                            goals: 0,
                            assists: 0,
                            appearances: 0,
                            totalRating: 0,
                            avgRating: 0,
                            // ìŠˆíŒ… ê´€ë ¨ í†µê³„
                            totalShots: 0,
                            effectiveShots: 0,
                            // íŒ¨ìŠ¤ ê´€ë ¨ í†µê³„
                            passTry: 0,
                            // ìˆ˜ë¹„ ê´€ë ¨ í†µê³„
                            blocks: 0,
                            blockTry: 0,
                            tackles: 0,
                            tackleTry: 0,
                            intercepts: 0,
                            // ê³µì¤‘ë³¼ ê´€ë ¨ í†µê³„
                            aerialDuels: 0,
                            aerialDuelsWon: 0,
                            // ë©€í‹° ê¸°ì—¬ë„ í†µê³„
                            multiContribution: 0
                        };
                    }
                    
                    // í†µê³„ ëˆ„ì 
                    playerStats[playerId].goals += player.status.goal || 0;
                    playerStats[playerId].assists += player.status.assist || 0;
                    playerStats[playerId].appearances += 1;
                    playerStats[playerId].totalRating += player.status.spRating || 0;
                    
                    // ìŠˆíŒ… ê´€ë ¨ í†µê³„
                    playerStats[playerId].totalShots += player.status.shoot || 0;
                    playerStats[playerId].effectiveShots += player.status.effectiveShoot || 0;
                    
                    // íŒ¨ìŠ¤ ê´€ë ¨ í†µê³„
                    playerStats[playerId].passTry += player.status.passTry || 0;
                    
                    // ìˆ˜ë¹„ ê´€ë ¨ í†µê³„
                    playerStats[playerId].blocks += player.status.blockSuccess || player.status.block || 0;
                    playerStats[playerId].blockTry += player.status.blockTry || 0;
                    playerStats[playerId].tackles += player.status.tackleSuccess || player.status.tackle || 0;
                    playerStats[playerId].tackleTry += player.status.tackleTry || 0;
                    playerStats[playerId].intercepts += player.status.intercept || 0;
                    
                    // ê³µì¤‘ë³¼ ê´€ë ¨ í†µê³„ (APIì—ì„œ ì œê³µí•˜ëŠ” ì •í™•í•œ í•„ë“œëª… ì‚¬ìš©)
                    const aerialTry = player.status.aerialTry || 0;
                    const aerialSuccess = player.status.aerialSuccess || 0;
                    playerStats[playerId].aerialDuels += aerialTry;
                    playerStats[playerId].aerialDuelsWon += aerialSuccess;
                    
                    // ë©€í‹° ê¸°ì—¬ë„ í†µê³„ (ê³¨ + ì–´ì‹œìŠ¤íŠ¸ + ë¸”ë¡ + íƒœí´ + ì¸í„°ì…‰íŠ¸)
                    const multiContribution = (player.status.goal || 0) + 
                                           (player.status.assist || 0) + 
                                           (player.status.blockSuccess || player.status.block || 0) + 
                                           (player.status.tackleSuccess || player.status.tackle || 0) + 
                                           (player.status.intercept || 0);
                    playerStats[playerId].multiContribution += multiContribution;
                    
                    // ë””ë²„ê¹…: ê³µì¤‘ë³¼ ë°ì´í„° í™•ì¸
                    if (aerialTry > 0 || aerialSuccess > 0) {
                        console.log(`ì„ ìˆ˜ ${playerName} ê³µì¤‘ë³¼ ë°ì´í„°:`, { aerialTry, aerialSuccess });
                    }
                    
                    // ë””ë²„ê¹…: ê³µì¤‘ë³¼ ë°ì´í„° í™•ì¸ (ì²˜ìŒ ëª‡ ëª…ë§Œ)
                    if (playerId === Object.keys(playerStats)[0]) {
                        console.log(`ì„ ìˆ˜ ${playerName} ê³µì¤‘ë³¼ ë°ì´í„°:`, { 
                            aerialTry: player.status.aerialTry, 
                            aerialSuccess: player.status.aerialSuccess 
                        });
                    }
                }
            });
        }
    });
    
    // í‰ê·  í‰ì  ë° ì„±ê³µë¥  ê³„ì‚°
    Object.values(playerStats).forEach(player => {
        player.avgRating = player.appearances > 0 ? (player.totalRating / player.appearances).toFixed(1) : 0;
        
        // ë“ì  ì„±ê³µë¥  ê³„ì‚°
        player.goalSuccessRate = player.totalShots > 0 ? Math.round((player.goals / player.totalShots) * 100) : 0;
        
        // ë„ì›€ ì„±ê³µë¥  ê³„ì‚° (ì–´ì‹œìŠ¤íŠ¸/íŒ¨ìŠ¤ì‹œë„)
        player.assistSuccessRate = player.passTry > 0 ? Math.round((player.assists / player.passTry) * 100) : 0;
        
        // ìˆ˜ë¹„ ì„±ê³µë¥  ê³„ì‚° (ë¸”ë¡ + íƒœí´ + ì¸í„°ì…‰íŠ¸)
        // ì¸í„°ì…‰íŠ¸ëŠ” ì‹œë„ íšŸìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬
        const totalDefenseTry = player.blockTry + player.tackleTry;
        const totalDefenseSuccess = player.blocks + player.tackles + player.intercepts;
        
        // ì¸í„°ì…‰íŠ¸ê°€ ìˆëŠ” ê²½ìš° ê°€ì¤‘ì¹˜ ì ìš© (ì¸í„°ì…‰íŠ¸ëŠ” 100% ì„±ê³µìœ¼ë¡œ ê°„ì£¼)
        if (player.intercepts > 0) {
            // ì¸í„°ì…‰íŠ¸ë¥¼ ì‹œë„ íšŸìˆ˜ì— ì¶”ê°€ (ì¸í„°ì…‰íŠ¸ ì‹œë„ = ì¸í„°ì…‰íŠ¸ ì„±ê³µ)
            const adjustedDefenseTry = totalDefenseTry + player.intercepts;
            const adjustedDefenseSuccess = totalDefenseSuccess;
            player.defenseSuccessRate = adjustedDefenseTry > 0 ? Math.round((adjustedDefenseSuccess / adjustedDefenseTry) * 100) : 0;
        } else {
            player.defenseSuccessRate = totalDefenseTry > 0 ? Math.round((totalDefenseSuccess / totalDefenseTry) * 100) : 0;
        }
        
        // ê³µì¤‘ë³¼ ì„±ê³µë¥  ê³„ì‚° (aerialSuccess/aerialTry)
        player.aerialSuccessRate = player.aerialDuels > 0 ? Math.round((player.aerialDuelsWon / player.aerialDuels) * 100) : 0;
        
        // ë©€í‹° ê¸°ì—¬ë„ ê³„ì‚° (ê²½ê¸°ë‹¹ í‰ê· )
        player.multiContributionRate = player.appearances > 0 ? (player.multiContribution / player.appearances).toFixed(1) : 0;
    });
    
    // ìµœê³ ì˜ ì„ ìˆ˜ë“¤ ì°¾ê¸°
    const players = Object.values(playerStats);
    
    if (players.length === 0) {
        console.log('ì„ ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ê° ë¶„ì•¼ë³„ Top 4 ì„ ìˆ˜ë“¤
    const topRated = players
        .sort((a, b) => parseFloat(b.avgRating) - parseFloat(a.avgRating))
        .slice(0, 4);
    
    const topScorers = players
        .sort((a, b) => b.goals - a.goals)
        .slice(0, 4);
    
    const topAssisters = players
        .sort((a, b) => b.assists - a.assists)
        .slice(0, 4);
    
    // ìˆ˜ë¹„ ì„±ê³µë¥  ë””ë²„ê¹…
    console.log('ìˆ˜ë¹„ ì„±ê³µë¥  ë””ë²„ê¹…:');
    const defensePlayers = players.filter(p => p.blocks > 0 || p.tackles > 0 || p.intercepts > 0);
    console.log('ìˆ˜ë¹„ ë°ì´í„°ê°€ ìˆëŠ” ì„ ìˆ˜ë“¤:', defensePlayers.map(p => ({
        name: p.name,
        blocks: p.blocks,
        tackles: p.tackles,
        intercepts: p.intercepts,
        blockTry: p.blockTry,
        tackleTry: p.tackleTry,
        defenseSuccessRate: p.defenseSuccessRate
    })));
    
    const topDefenseSuccess = players
        .filter(p => p.defenseSuccessRate > 0)
        .sort((a, b) => b.defenseSuccessRate - a.defenseSuccessRate)
        .slice(0, 4);
    
    console.log('ìˆ˜ë¹„ ì„±ê³µë¥  Top 4:', topDefenseSuccess.map(p => ({
        name: p.name,
        defenseSuccessRate: p.defenseSuccessRate,
        blocks: p.blocks,
        tackles: p.tackles,
        intercepts: p.intercepts
    })));
    
    const topGoalSuccess = players
        .filter(p => p.goalSuccessRate > 0)
        .sort((a, b) => b.goalSuccessRate - a.goalSuccessRate)
        .slice(0, 4);
    
    const topAssistSuccess = players
        .filter(p => p.assistSuccessRate > 0)
        .sort((a, b) => b.assistSuccessRate - a.assistSuccessRate)
        .slice(0, 4);
    
    // ê³µì¤‘ë³¼ ì„±ê³µë¥  ë””ë²„ê¹…
    console.log('ê³µì¤‘ë³¼ ì„±ê³µë¥  ë””ë²„ê¹…:');
    const aerialPlayers = players.filter(p => p.aerialDuels > 0 || p.aerialDuelsWon > 0);
    console.log('ê³µì¤‘ë³¼ ë°ì´í„°ê°€ ìˆëŠ” ì„ ìˆ˜ë“¤:', aerialPlayers.map(p => ({
        name: p.name,
        aerialDuels: p.aerialDuels,
        aerialDuelsWon: p.aerialDuelsWon,
        aerialSuccessRate: p.aerialSuccessRate
    })));
    
    const topMultiContribution = players
        .filter(p => p.multiContribution > 0) // ë©€í‹° ê¸°ì—¬ë„ê°€ ìˆëŠ” ì„ ìˆ˜ë“¤ë§Œ
        .sort((a, b) => parseFloat(b.multiContributionRate) - parseFloat(a.multiContributionRate))
        .slice(0, 4);
    
    let topAerialSuccess = players
        .filter(p => p.aerialDuels > 0) // ê³µì¤‘ë³¼ ì‹œë„ê°€ ìˆëŠ” ì„ ìˆ˜ë“¤ë§Œ
        .sort((a, b) => b.aerialSuccessRate - a.aerialSuccessRate)
        .slice(0, 4);
    
    // ê³µì¤‘ë³¼ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ëª¨ë“  ì„ ìˆ˜ë¥¼ í‘œì‹œ (0% ì„±ê³µë¥ ë¡œ)
    if (topAerialSuccess.length === 0) {
        topAerialSuccess = players
            .sort((a, b) => b.aerialSuccessRate - a.aerialSuccessRate)
            .slice(0, 4);
    }
    
    console.log('ê³µì¤‘ë³¼ ì„±ê³µë¥  Top 4:', topAerialSuccess.map(p => ({
        name: p.name,
        aerialSuccessRate: p.aerialSuccessRate
    })));
    
    // ìŠ¬ë¼ì´ë“œ ë°ì´í„° ìƒì„±
    const slides = [
        {
            title: 'â­ ìµœê³  í‰ì ',
            icon: 'â­',
            players: topRated.map((player, index) => {
                console.log(`ì„ ìˆ˜ ${player.name}: spId=${player.spId}, seasonId=${player.seasonId}, season=${player.season}`);
                return {
                    name: player.name,
                    stats: `${player.avgRating}ì `,
                    rank: index + 1,
                    spId: player.spId,
                    seasonId: player.seasonId || player.spId || 'default',
                    season: player.season
                };
            })
        },
        {
            title: 'âš½ ìµœë‹¤ ë“ì ',
            icon: 'âš½',
            players: topScorers.map((player, index) => ({
                name: player.name,
                stats: `${player.goals}ê³¨`,
                rank: index + 1,
                spId: player.spId,
                seasonId: player.seasonId || 'default',
                season: player.season
            }))
        },
        {
            title: 'ğŸ…°ï¸ ìµœë‹¤ ë„ì›€',
            icon: 'ğŸ…°ï¸',
            players: topAssisters.map((player, index) => ({
                name: player.name,
                stats: `${player.assists}ë„ì›€`,
                rank: index + 1,
                spId: player.spId,
                seasonId: player.seasonId || 'default',
                season: player.season
            }))
        },
        {
            title: 'ğŸ›¡ï¸ ìˆ˜ë¹„ ì„±ê³µ',
            icon: 'ğŸ›¡ï¸',
            players: topDefenseSuccess.map((player, index) => ({
                name: player.name,
                stats: `${player.defenseSuccessRate}%`,
                rank: index + 1,
                spId: player.spId,
                seasonId: player.seasonId || 'default',
                season: player.season
            }))
        },
        {
            title: 'ğŸ† ë©€í‹° ê¸°ì—¬ë„',
            icon: 'ğŸ†',
            players: topMultiContribution.map((player, index) => ({
                name: player.name,
                stats: `${player.multiContributionRate}ì `,
                rank: index + 1,
                spId: player.spId,
                seasonId: player.seasonId || 'default',
                season: player.season
            }))
        },
        {
            title: 'ğŸ¯ ë“ì  ì„±ê³µë¥ ',
            icon: 'ğŸ¯',
            players: topGoalSuccess.map((player, index) => ({
                name: player.name,
                stats: `${player.goalSuccessRate}%`,
                rank: index + 1,
                spId: player.spId,
                seasonId: player.seasonId || 'default',
                season: player.season
            }))
        },
        {
            title: 'ğŸ“Š ë„ì›€ ì„±ê³µë¥ ',
            icon: 'ğŸ“Š',
            players: topAssistSuccess.map((player, index) => ({
                name: player.name,
                stats: `${player.assistSuccessRate}%`,
                rank: index + 1,
                spId: player.spId,
                seasonId: player.seasonId || 'default',
                season: player.season
            }))
        },
        {
            title: 'ğŸ’¥ ê³µì¤‘ë³¼ ì„±ê³µë¥ ',
            icon: 'ğŸ’¥',
            players: topAerialSuccess.map((player, index) => ({
                name: player.name,
                stats: `${player.aerialSuccessRate || 0}%`,
                rank: index + 1,
                spId: player.spId,
                seasonId: player.seasonId || 'default',
                season: player.season
            }))
        }
    ];
    
    // ìŠ¬ë¼ì´ë” ìƒíƒœ ì´ˆê¸°í™”
    topPlayersCurrentSlideIndex = 0;
    topPlayersTotalSlides = slides.length;
    
    // ìŠ¬ë¼ì´ë” ìƒì„±
    createTopPlayersSlider(slides);
    
    // ì‹¤ì œ ê²½ê¸° ìˆ˜ ì—…ë°ì´íŠ¸
    const actualMatchCount = document.getElementById('actualMatchCount');
    if (actualMatchCount) {
        actualMatchCount.textContent = matches.length;
    }
    
    // ì„¹ì…˜ í‘œì‹œ
    const topPlayersSection = document.getElementById('topPlayersSection');
    if (topPlayersSection) {
        topPlayersSection.style.display = 'block';
    }
    
    console.log('ìµœê³ ì˜ ì„ ìˆ˜ ë°ì´í„° í‘œì‹œ ì™„ë£Œ');
}

// ìµœê³ ì˜ ì„ ìˆ˜ ìŠ¬ë¼ì´ë” ìƒì„±
function createTopPlayersSlider(slides) {
    const track = document.getElementById('topPlayersTrack');
    if (!track) return;
    
    // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
    track.innerHTML = '';
    
    // ìŠ¬ë¼ì´ë“œ ìƒì„± (4ê°œì”© ê·¸ë£¹í™”)
    const slidesPerView = 4;
    topPlayersTotalSlides = Math.ceil(slides.length / slidesPerView);
    topPlayersCurrentSlideIndex = 0;
    
    // ìŠ¬ë¼ì´ë” íŠ¸ë™ ìœ„ì¹˜ ì´ˆê¸°í™”
    track.style.transform = 'translateX(0%)';
    
    for (let i = 0; i < topPlayersTotalSlides; i++) {
        const slideElement = document.createElement('div');
        slideElement.className = 'top-players-slide';
        
        const startIndex = i * slidesPerView;
        const endIndex = Math.min(startIndex + slidesPerView, slides.length);
        const slideData = slides.slice(startIndex, endIndex);
        
        slideElement.innerHTML = slideData.map(slide => `
            <div class="top-player-category">
                <h5>${slide.title}</h5>
                <div class="top-players-list">
                            ${slide.players.map((player, index) => {
                                if (index === 0) {
                                    // 1ë“± - ì‚¬ì§„ í‘œì‹œ
                                    return `
                                        <div class="top-player-item first-place">
                                            <img src="https://fo4.dn.nexoncdn.co.kr/live/externalAssets/common/playersAction/p${player.spId || 'default'}.png" 
                                                 alt="${player.name}" 
                                                 class="player-image" 
                                                 onerror="this.src='https://fo4.dn.nexoncdn.co.kr/live/externalAssets/common/playersAction/p100000000.png'">
                                            <div class="player-info">
                                                ${player.season?.seasonImg ? `<img src="${player.season.seasonImg}" alt="ì‹œì¦Œ" class="season-badge" onerror="this.style.display='none'"/>` : ''}
                                                <div class="player-name">${player.name}</div>
                                            </div>
                                            <div class="player-stats">${player.stats}</div>
                                        </div>
                                    `;
                                } else {
                                    // 2-4ë“± - ì‹œì¦Œì´ë¯¸ì§€+ì´ë¦„ (ìˆœìœ„ í…ìŠ¤íŠ¸ ì œê±°)
                                    return `
                                        <div class="top-player-item">
                                            <div class="player-info">
                                                ${player.season?.seasonImg ? `<img src="${player.season.seasonImg}" alt="ì‹œì¦Œ" class="season-badge" onerror="this.style.display='none'"/>` : ''}
                                                <div class="player-name">${player.name}</div>
                                            </div>
                                            <div class="player-stats">${player.stats}</div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                </div>
            </div>
        `).join('');
        
        track.appendChild(slideElement);
    }
    
    // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupTopPlayersSlider();
    
    // ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™” ë° í‘œì‹œ
    const prevBtn = document.getElementById('topPlayersPrevBtn');
    const nextBtn = document.getElementById('topPlayersNextBtn');
    
    if (prevBtn) {
        prevBtn.disabled = true;
        prevBtn.style.display = topPlayersTotalSlides > 1 ? 'flex' : 'none';
    }
    if (nextBtn) {
        nextBtn.disabled = topPlayersTotalSlides <= 1;
        nextBtn.style.display = topPlayersTotalSlides > 1 ? 'flex' : 'none';
    }
}

// ìµœê³ ì˜ ì„ ìˆ˜ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupTopPlayersSlider() {
    const prevBtn = document.getElementById('topPlayersPrevBtn');
    const nextBtn = document.getElementById('topPlayersNextBtn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            if (topPlayersCurrentSlideIndex > 0) {
                topPlayersCurrentSlideIndex--;
                updateTopPlayersSliderPosition();
                updateTopPlayersSliderButtons();
            }
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            if (topPlayersCurrentSlideIndex < topPlayersTotalSlides - 1) {
                topPlayersCurrentSlideIndex++;
                updateTopPlayersSliderPosition();
                updateTopPlayersSliderButtons();
            }
        });
    }
    
    // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
    updateTopPlayersSliderButtons();
}

// ìµœê³ ì˜ ì„ ìˆ˜ ìŠ¬ë¼ì´ë” ìœ„ì¹˜ ì—…ë°ì´íŠ¸
function updateTopPlayersSliderPosition() {
    const track = document.getElementById('topPlayersTrack');
    if (!track) return;
    
    const slideWidth = 100; // 100% per slide
    const translateX = -topPlayersCurrentSlideIndex * slideWidth;
    track.style.transform = `translateX(${translateX}%)`;
}

// ìµœê³ ì˜ ì„ ìˆ˜ ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateTopPlayersSliderButtons() {
    const prevBtn = document.getElementById('topPlayersPrevBtn');
    const nextBtn = document.getElementById('topPlayersNextBtn');
    
    if (prevBtn) {
        prevBtn.disabled = topPlayersCurrentSlideIndex === 0;
    }
    
    if (nextBtn) {
        nextBtn.disabled = topPlayersCurrentSlideIndex === topPlayersTotalSlides - 1;
    }
}

// ìµœê³ ì˜ ì„ ìˆ˜ ìš”ì†Œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€)
function updateTopPlayerElement(elementId, playerName, stats) {
    const element = document.getElementById(elementId);
    if (element) {
        const nameElement = element.querySelector('.player-name');
        const statsElement = element.querySelector('.player-stats');
        
        if (nameElement) nameElement.textContent = playerName;
        if (statsElement) statsElement.textContent = stats;
    }
}

// í¬ë©”ì´ì…˜ ë¶„ì„ í•¨ìˆ˜ë“¤
async function analyzeFormationData() {
    console.log('=== í¬ë©”ì´ì…˜ ë¶„ì„ ì‹œì‘ ===');
    
    // 100ê²½ê¸°ë¥¼ ë¡œë“œí•´ì„œ ë¶„ì„
    let matchesToAnalyze = null;
    
    if (currentUserInfo && currentUserInfo.ouid) {
        try {
            console.log('ğŸ“Š 100ê²½ê¸° ë°ì´í„° ë¡œë“œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘');
            showFormationLoading('ğŸ“Š 100ê²½ê¸° ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...');
            
            // ì´ˆê¸° ê²½ê¸° ë°ì´í„°ë¡œ ì‹œì‘
            matchesToAnalyze = [...(currentUserInfo.matches || [])];
            console.log(`âœ… ì´ˆê¸° ê²½ê¸° ìˆ˜: ${matchesToAnalyze.length}ê²½ê¸°`);
            
            // ë”ë³´ê¸° APIë¥¼ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•´ì„œ 100ê²½ê¸°ê¹Œì§€ ê°€ì ¸ì˜¤ê¸°
            let offset = matchesToAnalyze.length;
            const targetCount = 100;
            const batchSize = 10;
            const maxAttempts = 10;
            let attempts = 0;
            
            console.log(`ğŸ“¥ ì¶”ê°€ ê²½ê¸° ë¡œë“œ ì‹œì‘ (ëª©í‘œ: ${targetCount}ê²½ê¸°)`);
            
            while (matchesToAnalyze.length < targetCount && attempts < maxAttempts) {
                attempts++;
                const currentProgress = Math.round((matchesToAnalyze.length / targetCount) * 100);
                console.log(`â³ [${attempts}/${maxAttempts}] ì¶”ê°€ ê²½ê¸° ë¡œë“œ ì¤‘... (${matchesToAnalyze.length}/${targetCount} - ${currentProgress}%)`);
                showFormationLoading(`ğŸ“¥ ê²½ê¸° ë°ì´í„° ë¡œë“œ ì¤‘... (${matchesToAnalyze.length}/${targetCount} - ${currentProgress}%)`);
                
                try {
                    const response = await fetch(`/api/user/matches/${currentUserInfo.ouid}?offset=${offset}&limit=${batchSize}`);
                    
                    if (!response.ok) {
                        console.log(`âš ï¸ ë” ì´ìƒ ê²½ê¸° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ìƒíƒœ: ${response.status})`);
                        break;
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.matches && data.matches.length > 0) {
                        matchesToAnalyze = [...matchesToAnalyze, ...data.matches];
                        offset = matchesToAnalyze.length;
                        console.log(`âœ… ${data.matches.length}ê²½ê¸° ì¶”ê°€ë¨. í˜„ì¬ ì´ ${matchesToAnalyze.length}ê²½ê¸°`);
                    } else {
                        console.log('â„¹ï¸ ë” ì´ìƒ ê°€ì ¸ì˜¬ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        break;
                    }
                } catch (error) {
                    console.error('âŒ ê²½ê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    break;
                }
            }
            
            console.log(`ğŸ¯ ìµœì¢… ë¡œë“œëœ ê²½ê¸° ìˆ˜: ${matchesToAnalyze.length}ê²½ê¸°`);
        } catch (error) {
            console.log('âŒ 100ê²½ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨, ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©:', error);
            matchesToAnalyze = currentUserInfo?.matches || currentUserData?.matches;
        }
    } else {
        matchesToAnalyze = currentUserInfo?.matches || currentUserData?.matches;
    }
    
    if (!matchesToAnalyze || matchesToAnalyze.length === 0) {
        console.log('âš ï¸ ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê²½ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        showNoFormationData();
        return;
    }
    
    console.log(`ğŸ” í¬ë©”ì´ì…˜ ë¶„ì„ ì‹œì‘: ${matchesToAnalyze.length}ê²½ê¸°`);
    showFormationLoading(`ğŸ” í¬ë©”ì´ì…˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘... (${matchesToAnalyze.length}ê²½ê¸°)`);
    
    try {
        // í¬ë©”ì´ì…˜ë³„ ê²½ê¸° ê·¸ë£¹í™”
        console.log('ğŸ“‚ 1ë‹¨ê³„: í¬ë©”ì´ì…˜ë³„ ê²½ê¸° ê·¸ë£¹í™” ì‹œì‘...');
        showFormationLoading('ğŸ“‚ í¬ë©”ì´ì…˜ë³„ ê²½ê¸°ë¥¼ ê·¸ë£¹í™”í•˜ëŠ” ì¤‘...');
        
        const formationGroups = {};
        
        for (const match of matchesToAnalyze) {
            try {
                const formation = match.formation || calculateFormationFromPlayers(match.userPlayers || []);
                
                if (!formationGroups[formation]) {
                    formationGroups[formation] = [];
                }
                
                formationGroups[formation].push(match);
            } catch (error) {
                console.error('âŒ ê²½ê¸° ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨:', error);
            }
        }
        
        const formationList = Object.keys(formationGroups).sort((a, b) => 
            formationGroups[b].length - formationGroups[a].length
        );
        console.log(`âœ… ë°œê²¬ëœ í¬ë©”ì´ì…˜: ${formationList.join(', ')}`);
        formationList.forEach(formation => {
            console.log(`   - ${formation}: ${formationGroups[formation].length}ê²½ê¸°`);
        });
        
        // í¬ë©”ì´ì…˜ë³„ ì„±ê³¼ ê³„ì‚°
        console.log('ğŸ“Š 2ë‹¨ê³„: í¬ë©”ì´ì…˜ë³„ ì„±ê³¼ ê³„ì‚° ì¤‘...');
        showFormationLoading('ğŸ“Š í¬ë©”ì´ì…˜ë³„ ì„±ê³¼ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...');
        
        const formationPerformances = [];
        for (const [formation, matches] of Object.entries(formationGroups)) {
            if (matches.length > 0) {
                const stats = calculateFormationStats(matches);
                formationPerformances.push({
                    formation,
                    matchCount: matches.length,
                    ...stats
                });
                console.log(`   ${formation}: ${matches.length}ê²½ê¸° (ìŠ¹ë¥  ${stats.winRate}%)`);
            }
        }
        
        // ê²½ê¸° ìˆ˜ê°€ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬
        formationPerformances.sort((a, b) => b.matchCount - a.matchCount);
        console.log(`âœ… ${formationPerformances.length}ê°œ í¬ë©”ì´ì…˜ ì„±ê³¼ ê³„ì‚° ì™„ë£Œ`);
        
        // ê° í¬ë©”ì´ì…˜ ë‚´ì—ì„œ ë™ì¼í•œ ì„ ìˆ˜ ê·¸ë£¹í™”
        console.log('ğŸ‘¥ 3ë‹¨ê³„: í¬ë©”ì´ì…˜ ë‚´ ì„ ìˆ˜ ê·¸ë£¹ ë¶„ì„ ì¤‘...');
        showFormationLoading('ğŸ‘¥ ë™ì¼ ì„ ìˆ˜ ê·¸ë£¹ì„ ë¶„ì„í•˜ëŠ” ì¤‘...');
        
        const formationDetailedGroups = {};
        let totalGroups = 0;
        
        for (const [formation, matches] of Object.entries(formationGroups)) {
            const playerGroups = groupMatchesByOverlappingPlayers(
                matches.map(match => ({
                    match: match,
                    players: match.userPlayers || []
                }))
            );
            
            formationDetailedGroups[formation] = playerGroups.map(group => {
                // group.matchesëŠ” { match, players } í˜•íƒœì´ë¯€ë¡œ ì‹¤ì œ matchë§Œ ì¶”ì¶œ
                const actualMatches = group.matches.map(item => item.match || item);
                const stats = calculateFormationStats(actualMatches);
                return {
                    formation,
                    matchCount: actualMatches.length,
                    players: group.players,
                    matches: actualMatches,
                    ...stats
                };
            });
            
            totalGroups += playerGroups.length;
            console.log(`   ${formation}: ${playerGroups.length}ê°œ ê·¸ë£¹ ë°œê²¬`);
        }
        
        console.log(`âœ… ì´ ${totalGroups}ê°œ ì„ ìˆ˜ ê·¸ë£¹ ë¶„ì„ ì™„ë£Œ`);
        
        // ìºì‹œì— ì €ì¥
        formationDataCache = {
            performances: formationPerformances,
            detailedGroups: formationDetailedGroups,
            matches: matchesToAnalyze,
            matchesData: formationGroups // í¬ë©”ì´ì…˜ë³„ ê²½ê¸° ë°ì´í„° ì¶”ê°€
        };
        formationDataLoaded = true;
        
        console.log('ğŸ’¾ ë¶„ì„ ê²°ê³¼ ìºì‹œì— ì €ì¥ ì™„ë£Œ');
        console.log('=== í¬ë©”ì´ì…˜ ë¶„ì„ ì™„ë£Œ ===');
        console.log(`ğŸ“‹ ìš”ì•½: ${matchesToAnalyze.length}ê²½ê¸° â†’ ${formationPerformances.length}ê°œ í¬ë©”ì´ì…˜ â†’ ${totalGroups}ê°œ ê·¸ë£¹`);
        
        // ë°ì´í„° í‘œì‹œ
        showFormationLoading('ğŸ¨ ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ì¤‘...');
        displayFormationPerformances(formationPerformances);
        
        // ì´ˆê¸° ê°€ì´ë“œ í‘œì‹œ
        showFormationGroupsGuide('í¬ë©”ì´ì…˜ ì„±ê³¼ ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ í•´ë‹¹ í¬ë©”ì´ì…˜ì˜ ìƒì„¸ ê·¸ë£¹ ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”.');
        
        // ê·¸ë£¹ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        window.formationGroupsData = formationDetailedGroups;
        window.formationMatchesData = formationGroups; // í¬ë©”ì´ì…˜ë³„ ì „ì²´ ê²½ê¸° ë°ì´í„° ì €ì¥
        
        hideFormationLoading();
        console.log('âœ¨ í¬ë©”ì´ì…˜ ë¶„ì„ íƒ­ í‘œì‹œ ì™„ë£Œ!');
        
    } catch (error) {
        console.error('âŒ í¬ë©”ì´ì…˜ ë¶„ì„ ì‹¤íŒ¨:', error);
        showNoFormationData();
    }
}

// í¬ë©”ì´ì…˜ë³„ ì„±ê³¼ í‘œì‹œ (ìŠ¬ë¼ì´ë”)
function displayFormationPerformances(performances) {
    if (!formationPerformanceTrack) return;
    
    // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
    formationPerformanceTrack.innerHTML = '';
    formationCurrentSlideIndex = 0;
    formationTotalSlides = Math.ceil(performances.length / formationCardsPerSlide);
    
    // ìŠ¬ë¼ì´ë“œë³„ë¡œ ì¹´ë“œ ê·¸ë£¹í™”
    for (let slideIndex = 0; slideIndex < formationTotalSlides; slideIndex++) {
        const slide = document.createElement('div');
        slide.className = 'formation-performance-slide';
        
        const startIdx = slideIndex * formationCardsPerSlide;
        const endIdx = Math.min(startIdx + formationCardsPerSlide, performances.length);
        
        for (let i = startIdx; i < endIdx; i++) {
            const perf = performances[i];
            const card = document.createElement('div');
            card.className = 'formation-performance-card';
            
            const winRateClass = perf.winRate >= 50 ? 'good' : 'bad';
            const avgGoalsClass = perf.avgGoals >= 2 ? 'good' : '';
            const avgConcedeClass = perf.avgConcede <= 1.5 ? 'good' : 'bad';
            
            card.innerHTML = `
                <div class="formation-performance-header">
                    <div class="formation-name">${perf.formation}</div>
                    <div class="formation-match-count">${perf.matchCount}ê²½ê¸°</div>
                </div>
                <div class="formation-performance-stats">
                    <div class="formation-stat-item">
                        <span class="formation-stat-label">ìŠ¹ë¥ </span>
                        <span class="formation-stat-value ${winRateClass}">${perf.winRate}%</span>
                    </div>
                    <div class="formation-stat-item">
                        <span class="formation-stat-label">í‰ê· ë“ì </span>
                        <span class="formation-stat-value ${avgGoalsClass}">${perf.avgGoals.toFixed(1)}</span>
                    </div>
                    <div class="formation-stat-item">
                        <span class="formation-stat-label">í‰ê· ì‹¤ì </span>
                        <span class="formation-stat-value ${avgConcedeClass}">${perf.avgConcede.toFixed(1)}</span>
                    </div>
                </div>
            `;
            
            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            card.addEventListener('click', () => {
                selectFormationPerformance(perf, card);
            });
            
            slide.appendChild(card);
        }
        
        formationPerformanceTrack.appendChild(slide);
    }
    
    // ìŠ¬ë¼ì´ë” ë²„íŠ¼ ì„¤ì •
    updateFormationSliderButtons();
    
    // ìŠ¬ë¼ì´ë” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    if (formationSliderPrevBtn) {
        formationSliderPrevBtn.onclick = () => moveFormationSlide(-1);
    }
    if (formationSliderNextBtn) {
        formationSliderNextBtn.onclick = () => moveFormationSlide(1);
    }
}

// í¬ë©”ì´ì…˜ ìŠ¬ë¼ì´ë” ì´ë™
function moveFormationSlide(direction) {
    formationCurrentSlideIndex += direction;
    
    // ë²”ìœ„ ì²´í¬
    if (formationCurrentSlideIndex < 0) {
        formationCurrentSlideIndex = 0;
    } else if (formationCurrentSlideIndex >= formationTotalSlides) {
        formationCurrentSlideIndex = formationTotalSlides - 1;
    }
    
    // ìŠ¬ë¼ì´ë“œ ì´ë™
    if (formationPerformanceTrack) {
        const offset = -formationCurrentSlideIndex * 100;
        formationPerformanceTrack.style.transform = `translateX(${offset}%)`;
    }
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateFormationSliderButtons();
}

// í¬ë©”ì´ì…˜ ì„±ê³¼ ì¹´ë“œ ì„ íƒ í•¨ìˆ˜
function selectFormationPerformance(selectedPerformance, clickedCard) {
    console.log('í¬ë©”ì´ì…˜ ì„ íƒ:', selectedPerformance);
    
    // ëª¨ë“  í¬ë©”ì´ì…˜ ì¹´ë“œì—ì„œ ì„ íƒ ìƒíƒœ ì œê±°
    document.querySelectorAll('.formation-performance-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // ì„ íƒëœ ì¹´ë“œì— ì„ íƒ ìƒíƒœ ì¶”ê°€
    if (clickedCard) {
        clickedCard.classList.add('selected');
    }
    
    // í•´ë‹¹ í¬ë©”ì´ì…˜ì˜ ê·¸ë£¹ ë°ì´í„° í‘œì‹œ
    displayFormationGroups(selectedPerformance.formation);
}

// í¬ë©”ì´ì…˜ ê·¸ë£¹ í‘œì‹œ í•¨ìˆ˜
function displayFormationGroups(selectedFormation) {
    console.log('í¬ë©”ì´ì…˜ ê·¸ë£¹ í‘œì‹œ ì‹œì‘:', selectedFormation);
    const groupsSection = document.getElementById('formationGroupsSection');
    if (!groupsSection) {
        console.log('ê·¸ë£¹ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì„ íƒëœ í¬ë©”ì´ì…˜ì˜ ê²½ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const formationMatchesData = window.formationMatchesData || {};
    const matches = formationMatchesData[selectedFormation] || [];
    console.log(`ì„ íƒëœ í¬ë©”ì´ì…˜ ${selectedFormation}ì˜ ê²½ê¸° ìˆ˜:`, matches.length);
    
    if (matches.length === 0) {
        console.log('ì„ íƒí•œ í¬ë©”ì´ì…˜ì— ëŒ€í•œ ê²½ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        showFormationGroupsGuide('ì„ íƒí•œ í¬ë©”ì´ì…˜ì— ëŒ€í•œ ê²½ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ìƒëŒ€ í¬ë©”ì´ì…˜ ì¶”ì¶œ ë° ì¹´ìš´íŠ¸
    const opponentFormations = {};
    matches.forEach(match => {
        try {
            const opponentFormation = match.opponentFormation || calculateFormationFromPlayers(match.opponentPlayers || []);
            if (opponentFormation) {
                if (!opponentFormations[opponentFormation]) {
                    opponentFormations[opponentFormation] = 0;
                }
                opponentFormations[opponentFormation]++;
            }
        } catch (error) {
            console.error('ìƒëŒ€ í¬ë©”ì´ì…˜ ê³„ì‚° ì‹¤íŒ¨:', error);
        }
    });
    
    // ê²½ê¸° ìˆ˜ê°€ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedOpponentFormations = Object.entries(opponentFormations)
        .sort((a, b) => b[1] - a[1])
        .map(([formation, count]) => ({ formation, count }));
    
    console.log('ìƒëŒ€ í¬ë©”ì´ì…˜ ëª©ë¡:', sortedOpponentFormations);
    
    // HTML ìƒì„±
    groupsSection.innerHTML = `
        <div class="formation-detail-container">
            <div class="formation-detail-header">
                <h3>${selectedFormation} <span class="formation-match-count">${matches.length}ê²½ê¸°</span></h3>
            </div>
            <div class="opponent-formation-slider-container">
                <button class="opponent-slider-btn opponent-prev-btn" id="opponentPrevBtn" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15,18 9,12 15,6"></polyline>
                    </svg>
                </button>
                <div class="opponent-formation-slider" id="opponentFormationSlider">
                    <div class="opponent-formation-track" id="opponentFormationTrack">
                        <!-- All ë°•ìŠ¤ -->
                        <div class="opponent-formation-box active" data-formation="all">
                            <div class="opponent-formation-name">All</div>
                            <div class="opponent-formation-count">${matches.length}ê²½ê¸°</div>
                        </div>
                        <!-- ìƒëŒ€ í¬ë©”ì´ì…˜ ë°•ìŠ¤ë“¤ -->
                        ${sortedOpponentFormations.map(({ formation, count }) => `
                            <div class="opponent-formation-box" data-formation="${formation}">
                                <div class="opponent-formation-name">${formation}</div>
                                <div class="opponent-formation-count">${count}ê²½ê¸°</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button class="opponent-slider-btn opponent-next-btn" id="opponentNextBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9,18 15,12 9,6"></polyline>
                    </svg>
                </button>
            </div>
            <div class="formation-detail-content" id="formationDetailContent">
                <!-- ì„ íƒëœ ìƒëŒ€ í¬ë©”ì´ì…˜ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    `;
    
    // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
    initOpponentFormationSlider();
    
    console.log('í¬ë©”ì´ì…˜ ê·¸ë£¹ ë°ì´í„° í‘œì‹œ ì™„ë£Œ');
}

// ìƒëŒ€ í¬ë©”ì´ì…˜ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
function initOpponentFormationSlider() {
    const slider = document.getElementById('opponentFormationSlider');
    const track = document.getElementById('opponentFormationTrack');
    const prevBtn = document.getElementById('opponentPrevBtn');
    const nextBtn = document.getElementById('opponentNextBtn');
    const boxes = track?.querySelectorAll('.opponent-formation-box');
    
    if (!slider || !track || !boxes || boxes.length === 0) return;
    
    let currentScroll = 0;
    const scrollAmount = 200; // í•œ ë²ˆì— ìŠ¤í¬ë¡¤í•  í”½ì…€ ìˆ˜
    
    // ì´ì „ ë²„íŠ¼ í´ë¦­
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            currentScroll = Math.max(0, currentScroll - scrollAmount);
            track.style.transform = `translateX(-${currentScroll}px)`;
            updateOpponentSliderButtons();
        });
    }
    
    // ë‹¤ìŒ ë²„íŠ¼ í´ë¦­
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            const maxScroll = track.scrollWidth - slider.clientWidth;
            currentScroll = Math.min(maxScroll, currentScroll + scrollAmount);
            track.style.transform = `translateX(-${currentScroll}px)`;
            updateOpponentSliderButtons();
        });
    }
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateOpponentSliderButtons() {
        const maxScroll = track.scrollWidth - slider.clientWidth;
        if (prevBtn) prevBtn.disabled = currentScroll <= 0;
        if (nextBtn) nextBtn.disabled = currentScroll >= maxScroll;
    }
    
    // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ
    updateOpponentSliderButtons();
    
    // ê° ë°•ìŠ¤ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    boxes.forEach(box => {
        box.addEventListener('click', () => {
            // ì´ì „ active í´ë˜ìŠ¤ ì œê±°
            boxes.forEach(b => b.classList.remove('active'));
            // í˜„ì¬ ë°•ìŠ¤ì— active í´ë˜ìŠ¤ ì¶”ê°€
            box.classList.add('active');
            
            const selectedOpponentFormation = box.getAttribute('data-formation');
            console.log('ì„ íƒëœ ìƒëŒ€ í¬ë©”ì´ì…˜:', selectedOpponentFormation);
            
            // TODO: ìƒëŒ€ í¬ë©”ì´ì…˜ ì„ íƒ ì‹œ ë™ì‘ (ë‹¤ìŒì— êµ¬í˜„)
        });
    });
}

// í¬ë©”ì´ì…˜ ê·¸ë£¹ ê°€ì´ë“œ í‘œì‹œ í•¨ìˆ˜
function showFormationGroupsGuide(message) {
    const groupsSection = document.getElementById('formationGroupsSection');
    if (!groupsSection) return;
    
    groupsSection.innerHTML = `
        <div class="formation-groups-guide">
            <div class="guide-icon">ğŸ“Š</div>
            <div class="guide-content">
                <h4>í¬ë©”ì´ì…˜ ê·¸ë£¹ ë¶„ì„</h4>
                <p>${message}</p>
                
            </div>
        </div>
    `;
}

// í¬ë©”ì´ì…˜ ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateFormationSliderButtons() {
    if (formationSliderPrevBtn) {
        formationSliderPrevBtn.disabled = formationCurrentSlideIndex === 0;
    }
    if (formationSliderNextBtn) {
        formationSliderNextBtn.disabled = formationCurrentSlideIndex === formationTotalSlides - 1 || formationTotalSlides === 0;
    }
}


// í¬ë©”ì´ì…˜ ë¡œë”© í‘œì‹œ
function showFormationLoading(message = 'í¬ë©”ì´ì…˜ ë°ì´í„° ë¶„ì„ ì¤‘...') {
    if (formationLoading) {
        formationLoading.style.display = 'flex';
        const loadingText = formationLoading.querySelector('span');
        if (loadingText) {
            loadingText.textContent = message;
        }
    }
    if (formationLayout) formationLayout.style.display = 'none';
    if (noFormationData) noFormationData.style.display = 'none';
}

// í¬ë©”ì´ì…˜ ë¡œë”© ìˆ¨ê¸°ê¸°
function hideFormationLoading() {
    if (formationLoading) formationLoading.style.display = 'none';
    if (formationLayout) formationLayout.style.display = 'flex';
}

// í¬ë©”ì´ì…˜ ë°ì´í„° ì—†ìŒ í‘œì‹œ
function showNoFormationData() {
    if (formationLoading) formationLoading.style.display = 'none';
    if (formationLayout) formationLayout.style.display = 'none';
    if (noFormationData) noFormationData.style.display = 'block';
}

// DOMì´ ë¡œë“œëœ í›„ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // íŒì—… ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    addPopupOverlayClickEvent();
});
